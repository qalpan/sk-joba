<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Marketplace v2</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 55vh; width: 100%; }
        .filter-bar { padding: 10px; background: white; display: flex; gap: 10px; overflow-x: auto; border-bottom: 2px solid #ddd; }
        .filter-bar select, .filter-bar input { padding: 8px; border-radius: 20px; border: 1px solid #ccc; min-width: 150px; }
        .container { padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .card h4 { margin-top: 0; color: #333; }
        input:invalid { border: 2px solid red; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; color: black; }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 10px; text-align: left; background: white; }
    </style>
</head>
<body>

<div class="filter-bar">
    <select id="filter-type" onchange="loadAll()">
        <option value="all">–ë–∞—Ä–ª—ã“ì—ã</option>
        <option value="worker">“ö—ã–∑–º–µ—Ç—Ç–µ—Ä</option>
        <option value="good">–¢–∞—É–∞—Ä–ª–∞—Ä</option>
        <option value="order">–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä</option>
    </select>
    <input type="text" id="search-input" placeholder="–Ü–∑–¥–µ—É (–º—ã—Å–∞–ª—ã: –°–∞–Ω—Ç–µ—Ö–Ω–∏–∫)..." oninput="loadAll()">
</div>

<div id="map"></div>

<div class="container">
    <div class="card">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç “±—Å—ã–Ω—É</h4>
        <input type="text" id="w_name" placeholder="–ê—Ç—ã“£—ã–∑ (—Ç–µ–∫ –º”ô—Ç—ñ–Ω)" required pattern="[A-Za-z–ê-–Ø–∞-—è–Å—ë–Ü—ñ“¢“£“í“ì“Æ“Ø“∞“±“ö“õ”®”©”ò”ô“∫“ª\s]+">
        <input type="text" id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ (–º—ã—Å–∞–ª—ã: –°–∞–Ω—Ç–µ—Ö–Ω–∏–∫)" required>
        <input type="tel" id="w_phone" placeholder="+77001234567" pattern="\+7\d{10}" title="–§–æ—Ä–º–∞—Ç: +7 –∂”ô–Ω–µ 10 —Ü–∏—Ñ—Ä" required>
        <select id="w_dur"><option value="1">1 —Å–∞“ì–∞—Ç (500—Ç–≥)</option><option value="24">1 —Ç”ô—É–ª—ñ–∫ (2000—Ç–≥)</option></select>
        <button class="btn-w" style="background:#007bff; color:white;" onclick="saveWorker()">–¢—ñ—Ä–∫–µ–ª—É</button>
    </div>

    <div class="card">
        <h4>üì¶ –¢–∞—É–∞—Ä —Å–∞—Ç—É</h4>
        <input type="text" id="g_name" placeholder="–°–∞—Ç—É—à—ã –∞—Ç—ã" required>
        <input type="text" id="g_prod" placeholder="–¢–∞—É–∞—Ä (–º—ã—Å–∞–ª—ã: –°—É—Å—ã–Ω)" required>
        <input type="text" id="g_price" placeholder="–ë–∞“ì–∞—Å—ã (–º—ã—Å–∞–ª—ã: 500 —Ç–≥)" required>
        <input type="tel" id="g_phone" placeholder="+77001234567" pattern="\+7\d{10}" required>
        <button class="btn-g" style="background:#ffc107;" onclick="saveGoods()">–¢–∞—É–∞—Ä “õ–æ—Å—É</button>
    </div>
</div>

<div id="admin-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; overflow:auto; padding:20px;">
    <button onclick="closeAdmin()" style="float:right; padding:10px 20px;">‚ùå –ñ–∞–±—É</button>
    <h2 style="color:white;">–ö“Ø—Ç—É–¥–µ–≥—ñ ”©—Ç—ñ–Ω—ñ–º–¥–µ—Ä (–¢–æ–ª—ã“õ –∞“õ–ø–∞—Ä–∞—Ç)</h2>
    <table class="admin-table" id="admin-table-body"></table>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    // Spiderfier –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è—Å—ã
    const oms = new OverlappingMarkerSpiderfier(map, { keepSpiderfied: true });
    const API = "https://sk-joba.onrender.com";
    const myToken = localStorage.getItem('device_token') || Math.random().toString(36).substring(2);
    localStorage.setItem('device_token', myToken);

    function loadAll() {
        const typeFilter = document.getElementById('filter-type').value;
        const searchFilter = document.getElementById('search-input').value.toLowerCase();

        fetch(`${API}/get-all`).then(res => res.json()).then(data => {
            map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });
            oms.clearMarkers();

            // –ú–∞–º–∞–Ω–¥–∞—Ä
            if (typeFilter === 'all' || typeFilter === 'worker') {
                data.workers.forEach(w => {
                    if (w.job.toLowerCase().includes(searchFilter)) addMarker(w, 'worker', 'blue', w.job);
                });
            }
            // –¢–∞—É–∞—Ä–ª–∞—Ä
            if (typeFilter === 'all' || typeFilter === 'good') {
                data.goods.forEach(g => {
                    if (g.product_name.toLowerCase().includes(searchFilter)) addMarker(g, 'good', 'yellow', g.product_name);
                });
            }
            // –¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä
            if (typeFilter === 'all' || typeFilter === 'order') {
                data.orders.forEach(o => {
                    if (o.description.toLowerCase().includes(searchFilter)) addMarker(o, 'order', 'red', '–¢–∞–ø—Å—ã—Ä—ã—Å');
                });
            }
        });
    }

    function addMarker(item, type, color, tooltipText) {
        const icon = L.icon({ 
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
            iconSize: [25, 41] 
        });
        
        const marker = L.marker([item.lat, item.lon], {icon}).addTo(map);
        let content = `<b>${item.name || item.seller_name || item.client_name}</b><br>${item.job || item.product_name || item.description}<br><a href="tel:${item.phone}">${item.phone}</a>`;
        
        if (item.device_token === myToken) {
            content += `<br><button onclick="deleteItem('${type}', ${item.id})" style="background:red; color:white; border:none; border-radius:3px; cursor:pointer;">”®—à—ñ—Ä—É</button>`;
        }

        marker.bindPopup(content);
        marker.bindTooltip(tooltipText, {permanent: true, direction: 'top'});
        oms.addMarker(marker); // Spiderfier-–≥–µ “õ–æ—Å—É
    }

    // –¢–µ–∫—Å–µ—Ä—É —Ñ—É–Ω–∫—Ü–∏—è—Å—ã (Validation)
    function validate(id, name) {
        const el = document.getElementById(id);
        if(!el.checkValidity()) {
            alert(`"${name}" “±—è—à—ã“ì—ã –¥“±—Ä—ã—Å —Ç–æ–ª—Ç—ã—Ä—ã–ª–º–∞–¥—ã. –¢–µ–ª–µ—Ñ–æ–Ω +77... —Ç“Ø—Ä—ñ–Ω–¥–µ (12 —Ç–∞“£–±–∞) –±–æ–ª—É—ã —Ç–∏—ñ—Å.`);
            return false;
        }
        return true;
    }

    function saveWorker() {
        if(!validate('w_name', '–ê—Ç—ã') || !validate('w_job', '–ú–∞–º–∞–Ω–¥—ã“õ') || !validate('w_phone', '–¢–µ–ª–µ—Ñ–æ–Ω')) return;
        navigator.geolocation.getCurrentPosition(p => {
            const body = { name: v('w_name'), phone: v('w_phone'), job: v('w_job'), durationHours: v('w_dur'), device_token: myToken, lat: p.coords.latitude, lon: p.coords.longitude };
            fetch(`${API}/save-worker`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(() => alert("–¢—ñ—Ä–∫–µ–ª–¥—ñ! –¢”©–ª–µ–º —Ä–∞—Å—Ç–∞–ª“ì–∞–Ω —Å–æ“£ —à—ã“ì–∞—Å—ã–∑."));
        });
    }

    function saveGoods() {
        if(!validate('g_phone', '–¢–µ–ª–µ—Ñ–æ–Ω')) return;
        navigator.geolocation.getCurrentPosition(p => {
            const body = { name: v('g_name'), product: v('g_prod'), price: v('g_price'), phone: v('g_phone'), device_token: myToken, lat: p.coords.latitude, lon: p.coords.longitude };
            fetch(`${API}/save-goods`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(() => alert("–¢–∞—É–∞—Ä “õ–æ—Å—ã–ª–¥—ã! –ê–¥–º–∏–Ω —Ä–∞—Å—Ç–∞—É—ã–Ω –∫“Ø—Ç—ñ“£—ñ–∑."));
        });
    }

    // –ê–¥–º–∏–Ω —Ç–µ—Ä–µ–∑–µ—Å—ñ–Ω–¥–µ —Ç–æ–ª—ã“õ –∫–µ—Å—Ç–µ —à—ã“ì–∞—Ä—É
    function loadPending() {
        fetch(`${API}/admin/pending`).then(res => res.json()).then(list => {
            let html = `<tr><th>–¢“Ø—Ä—ñ</th><th>–ê—Ç—ã</th><th>–ê“õ–ø–∞—Ä–∞—Ç</th><th>–ë–∞“ì–∞—Å—ã/–ñ“±–º—ã—Å—ã</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>”ò—Ä–µ–∫–µ—Ç</th></tr>`;
            list.forEach(i => {
                html += `<tr>
                    <td>${i.type === 'worker' ? '–ú–∞–º–∞–Ω' : '–¢–∞—É–∞—Ä'}</td>
                    <td>${i.name || i.seller_name}</td>
                    <td>${i.job || i.product_name}</td>
                    <td>${i.price || i.expires_at || '-'}</td>
                    <td>${i.phone}</td>
                    <td><button onclick="activate('${i.id}', '${i.type}')">‚úÖ –†–∞—Å—Ç–∞—É</button></td>
                </tr>`;
            });
            document.getElementById('admin-table-body').innerHTML = html;
        });
    }

    function v(id) { return document.getElementById(id).value; }
    window.onhashchange = function() { if(location.hash === "#admin777") { document.getElementById('admin-modal').style.display='block'; loadPending(); } };
    loadAll();
</script>
</body>
</html>
