<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        :root { --primary: #007bff; --success: #28a745; --warning: #ffc107; }
        body { font-family: sans-serif; margin: 0; background: #f4f7f6; }
        .header-box { position: sticky; top: 0; z-index: 1000; text-align: center; padding: 10px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-input { width: 90%; padding: 12px; border-radius: 25px; border: 2px solid var(--primary); outline: none; font-size: 16px; }
        .style-switcher { display: flex; justify-content: center; gap: 10px; margin-top: 8px; }
        .style-btn { padding: 6px 14px; border-radius: 15px; border: 1px solid #ddd; background: #eee; cursor: pointer; font-size: 12px; }
        .style-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        #map { height: 45vh; width: 100%; border-bottom: 3px solid var(--primary); }
        .marker-label { background: rgba(255, 255, 255, 0.95); border: 1px solid #666; border-radius: 4px; padding: 2px 5px; font-size: 11px; font-weight: bold; white-space: nowrap; color: #333; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        #visible-list-container { background: white; margin: 10px; border-radius: 12px; height: 25vh; overflow-y: auto; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .list-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .call-icon { font-size: 24px; text-decoration: none; color: var(--success); padding: 5px 10px; }
        .container { padding: 15px; display: grid; gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 10px; border-top: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, textarea, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; }
        button { color: white; border: none; font-weight: bold; cursor: pointer; }
        #admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:15px; overflow-y:auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        th { background: #f2f2f2; }
    </style>
</head>
<body>

<div class="header-box">
    <input type="text" id="searchInput" class="search-input" placeholder="üîç –Ü–∑–¥–µ—É..." oninput="filterMarkers()">
    <div class="style-switcher">
        <button id="btn-color" class="style-btn active" onclick="changeMapStyle('color')">–¢“Ø—Å—Ç—ñ</button>
        <button id="btn-mono" class="style-btn" onclick="changeMapStyle('mono')">–ê“õ-“õ–∞—Ä–∞</button>
    </div>
</div>

<div id="map"></div>

<div id="visible-list-container">
    <div style="padding:10px; font-weight:bold; background:#eee; position: sticky; top:0;">üìç –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞: (<span id="item-count">0</span>)</div>
    <div id="dynamic-list-content"></div>
</div>

<div class="container">
    <div class="card" style="border-color: var(--primary);">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç –∂–∞—Ä–∏—è–ª–∞—É</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ">
        <input id="w_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" type="tel">
        <button onclick="saveItem('worker', false)" style="background:var(--primary)">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
        <button onclick="initVIP('worker')" style="background:#0056b3">üíé VIP –∂–∞—Ä–∏—è–ª–∞—É</button>
    </div>
    </div>

<div id="admin-modal">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h3>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å (–¢–æ–ª—ã“õ –∞“õ–ø–∞—Ä–∞—Ç)</h3>
        <button onclick="location.hash=''" style="background:red; width: auto; padding: 5px 15px;">–ñ–∞–±—É</button>
    </div>
    <div id="admin-content"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
    const API = "https://sk-joba.onrender.com"; 
    const myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    const map = L.map('map').setView([43.2389, 76.8897], 13);
    const baseLayers = {
        color: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
        mono: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png')
    };
    baseLayers.color.addTo(map);

    function changeMapStyle(s) {
        map.removeLayer(baseLayers.color); map.removeLayer(baseLayers.mono);
        baseLayers[s].addTo(map);
        document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + s).classList.add('active');
    }

    const markersGroup = L.markerClusterGroup({ spiderfyOnMaxZoom: true, maxClusterRadius: 30 });
    map.addLayer(markersGroup);

    let rawData = [];
    let adminDataFull = null;

    function loadMarkers() {
        fetch(API + '/get-all').then(r => r.json()).then(data => {
            adminDataFull = data.admin_all;
            const newData = [];
            if(data.workers) data.workers.forEach(x => newData.push({...x, type:'worker', info: x.job, title: x.name}));
            if(data.goods) data.goods.forEach(x => newData.push({...x, type:'good', info: x.product_name, title: x.seller_name}));
            if(data.orders) data.orders.forEach(x => newData.push({...x, type:'order', info: x.description, title: x.client_name}));
            
            rawData = newData;
            filterMarkers();
            if(location.hash === '#admin777') renderAdmin();
        });
    }

    function filterMarkers() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        markersGroup.clearLayers();
        let listHtml = '';
        let count = 0;

        rawData.forEach(i => {
            if(i.info.toLowerCase().includes(term) || i.title.toLowerCase().includes(term)) {
                count++;
                const color = i.type==='worker'?'#007bff':(i.type==='good'?'#ffc107':'#28a745');
                const cleanPhone = i.phone.replace(/\D/g, ''); // –¢–µ–∫ —Å–∞–Ω–¥–∞—Ä

                const m = L.marker([i.lat, i.lon], {
                    icon: L.divIcon({ 
                        html: `<div style="display:flex;flex-direction:column;align-items:center;"><div style="background:${color};width:14px;height:14px;border-radius:50%;border:2px solid white;box-shadow:0 0 4px rgba(0,0,0,0.5);"></div><div class="marker-label">${i.info.substring(0,12)}</div></div>`,
                        className: '', iconSize: [60, 40], iconAnchor: [30, 7] 
                    })
                });

                let delBtn = (i.device_token === myToken || i.device_token === 'WAITING_VIP_' + myToken) 
                    ? `<button onclick="deleteItem(${i.id},'${i.type}')" style="background:red; padding:4px; margin-top:5px; font-size:10px;">”®—à—ñ—Ä—É</button>` : "";

                // POPUP —ñ—à—ñ–Ω–¥–µ–≥—ñ —Ç–µ–ª–µ—Ñ–æ–Ω —à–∞–ª—É (tel:...)
                m.bindPopup(`
                    <div style="text-align:center;">
                        <b>${i.info}</b><br>${i.title}<br>
                        <a href="tel:${cleanPhone}" style="display:block; background:green; color:white; padding:8px; border-radius:5px; margin-top:5px; text-decoration:none;">üìû –•–∞–±–∞—Ä–ª–∞—Å—É</a>
                        ${delBtn}
                    </div>
                `);
                markersGroup.addLayer(m);

                // –¢”©–º–µ–Ω–¥–µ–≥—ñ —Ç—ñ–∑—ñ–º–¥–µ–≥—ñ —Ç–µ–ª–µ—Ñ–æ–Ω —à–∞–ª—É (tel:...)
                listHtml += `
                    <div class="list-item">
                        <div><b style="color:${color}">${i.info}</b><br><small>${i.title}</small></div>
                        <a href="tel:${cleanPhone}" class="call-icon">üìû</a>
                    </div>
                `;
            }
        });
        document.getElementById('item-count').innerText = count;
        document.getElementById('dynamic-list-content').innerHTML = listHtml;
    }

    function renderAdmin() {
        document.getElementById('admin-modal').style.display = 'block';
        if(!adminDataFull) return;
        
        let h = `<table><tr><th>–£–∞“õ—ã—Ç—ã</th><th>–¢“Ø—Ä—ñ</th><th>–ê“õ–ø–∞—Ä–∞—Ç</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–°—Ç–∞—Ç—É—Å</th><th>”ò—Ä–µ–∫–µ—Ç</th></tr>`;
        
        ['workers', 'goods', 'orders'].forEach(cat => {
            adminDataFull[cat].forEach(item => {
                const date = new Date(item.created_at);
                const timeStr = `${date.getDate()}.${date.getMonth()+1}.${date.getFullYear()} ${date.getHours()}:${date.getMinutes()}`;
                const typeName = cat.slice(0, -1);
                
                h += `<tr>
                    <td>${timeStr}</td>
                    <td>${cat}</td>
                    <td>${item.job || item.product_name || item.description}</td>
                    <td><a href="tel:${item.phone}">${item.phone}</a></td>
                    <td>${item.is_active ? '‚úÖ VIP' : '‚è≥ –¢–µ–≥—ñ–Ω'}</td>
                    <td>
                        <button onclick="toggleActive(${item.id},'${typeName}',${!item.is_active})" style="background:orange; padding:2px; font-size:9px;">VIP –∞—É—ã—Å—Ç—ã—Ä—É</button>
                        <button onclick="admDel(${item.id},'${typeName}')" style="background:red; padding:2px; font-size:9px;">–ñ–æ—é</button>
                    </td>
                </tr>`;
            });
        });
        document.getElementById('admin-content').innerHTML = h + "</table>";
    }

    // –¢”©–ª–µ–º –∂”ô–Ω–µ —Å–∞“õ—Ç–∞—É –ª–æ–≥–∏–∫–∞—Å—ã (”®–∑–≥–µ—Ä—ñ—Å—Å—ñ–∑)
    function initVIP(type) { 
        const info = "–¢”©–ª–µ–º –Ω”©–º—ñ—Ä—ñ: 8 707 123 45 67 (Kaspi/Halyk)\n–ë–∞“ì–∞—Å—ã: 490‚Ç∏\n\n–¢”©–ª–µ–ø –±–æ–ª—Å–∞“£—ã–∑ 'OK' –±–∞—Å—ã“£—ã–∑.";
        if(confirm(info)) saveItem(type, true); 
    }

    function saveItem(type, isVip) {
        let d = { is_vip: isVip, device_token: myToken };
        if(type==='worker') { d.name=v('w_name'); d.job=v('w_job'); d.phone=v('w_phone'); }
        // ... (–±–∞—Å“õ–∞ —Ç“Ø—Ä–ª–µ—Ä)
        navigator.geolocation.getCurrentPosition(pos => {
            d.lat = pos.coords.latitude; d.lon = pos.coords.longitude;
            fetch(API + (type==='worker'?'/save-worker':'/save-order'), { 
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d) 
            }).then(() => loadMarkers());
        });
    }

    function toggleActive(id, type, val) {
        fetch(API + '/admin/toggle-active', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, type, active:val})}).then(() => loadMarkers());
    }

    function admDel(id, type) {
        if(confirm("”®—à—ñ—Ä—É?")) fetch(API + '/delete-item', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, type, token:'admin777'})}).then(() => loadMarkers());
    }

    window.onhashchange = () => {
        if(location.hash === '#admin777') {
            if(prompt("–ü–∞—Ä–æ–ª—å:") === 'admin777') renderAdmin();
            else location.hash = '';
        } else document.getElementById('admin-modal').style.display = 'none';
    };

    function v(id){ return document.getElementById(id).value; }
    loadMarkers();
    setInterval(loadMarkers, 20000);
</script>
</body>
</html>
