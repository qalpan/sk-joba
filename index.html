<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Service Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    /* –ñ–∞“£–∞ —Å—Ç–∏–ª—å–¥–µ—Ä */
    .main-nav {
        position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
        z-index: 1000; display: flex; gap: 20px;
    }
    .category-btn {
        background: #3498db; color: white; border: none; padding: 10px 20px;
        border-radius: 10px; cursor: pointer; font-weight: bold;
    }
    .sub-menu {
        position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%);
        background: white; border-radius: 10px; display: none; /* ”ò–¥–µ–ø–∫—ñ–¥–µ –∂–∞–±—ã“õ */
        flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1001;
    }
    .sub-item { padding: 10px 20px; cursor: pointer; border-bottom: 1px solid #eee; }
    .sub-item:hover { background: #f1f1f1; }
</style>

<body>
    <button class="work-btn" onclick="startTracking()">üü¢ –ñ“±–º—ã—Å“õ–∞ —à—ã“ì—É</button>

    <div id="map"></div>

    <div class="main-nav">
        <button class="category-btn" onclick="toggleMenu('services')">üõ† “ö—ã–∑–º–µ—Ç—Ç–µ—Ä</button>
        <button class="category-btn" onclick="toggleMenu('goods')">üõç –¢–∞—É–∞—Ä–ª–∞—Ä</button>
    </div>

    <div id="services-menu" class="sub-menu">
        <div class="sub-item" onclick="filterMarkers('üõ†')">üõ† –°–∞–Ω—Ç–µ—Ö–Ω–∏–∫</div>
        <div class="sub-item" onclick="filterMarkers('‚ö°')">‚ö° –≠–ª–µ–∫—Ç—Ä–∏–∫</div>
        <div class="sub-item" onclick="filterMarkers('üßπ')">üßπ –¢–∞–∑–∞–ª—ã“õ</div>
    </div>

    <div id="goods-menu" class="sub-menu">
        <div class="sub-item" onclick="filterMarkers('üõí')">üõí –ê–∑—ã“õ-—Ç“Ø–ª—ñ–∫</div>
        <div class="sub-item" onclick="filterMarkers('üíä')">üíä –î”ô—Ä—ñ—Ö–∞–Ω–∞</div>
        <div class="sub-item" onclick="filterMarkers('üì¶')">üì¶ –ñ–µ—Ç–∫—ñ–∑—É</div>
    </div>

<script>
    // –ú”ô–∑—ñ—Ä–¥—ñ –∞—à—É/–∂–∞–±—É
    function toggleMenu(type) {
        const sMenu = document.getElementById('services-menu');
        const gMenu = document.getElementById('goods-menu');
        if (type === 'services') {
            sMenu.style.display = sMenu.style.display === 'flex' ? 'none' : 'flex';
            gMenu.style.display = 'none';
        } else {
            gMenu.style.display = gMenu.style.display === 'flex' ? 'none' : 'flex';
            sMenu.style.display = 'none';
        }
    }

    // –¢–µ–∫ –û–ù–õ–ê–ô–ù –º–∞–º–∞–Ω–¥–∞—Ä–¥—ã —Å“Ø–∑–≥—ñ–ª–µ—É
    function filterMarkers(role) {
        document.getElementById('services-menu').style.display = 'none';
        document.getElementById('goods-menu').style.display = 'none';

        Object.keys(markers).forEach(id => {
            const marker = markers[id];
            // 1. –†”©–ª—ñ —Å”ô–π–∫–µ—Å –∫–µ–ª–µ –º–µ?
            // 2. –°–æ“£“ì—ã —Ä–µ—Ç “õ–∞—à–∞–Ω –∞“õ–ø–∞—Ä–∞—Ç –∂—ñ–±–µ—Ä–¥—ñ? (–ú—ã—Å–∞–ª—ã, —Å–æ“£“ì—ã 5 –º–∏–Ω—É—Ç—Ç–∞)
            const isOnline = (Date.now() - marker.lastSeen) < 300000; // 5 –º–∏–Ω—É—Ç

            if (marker.role === role && isOnline) {
                map.addLayer(marker);
            } else {
                map.removeLayer(marker);
            }
        });
    }

    // –û—Ä—ã–Ω –∞–ª“ì–∞–Ω–¥–∞ —É–∞“õ—ã—Ç—Ç—ã —Å–∞“õ—Ç–∞—É
    socket.on('receive_location', (data) => {
        if (markers[data.id]) {
            markers[data.id].setLatLng([data.lat, data.lng]);
            markers[data.id].lastSeen = Date.now(); // –£–∞“õ—ã—Ç—Ç—ã –∂–∞“£–∞—Ä—Ç—É
        } else {
            const icon = L.divIcon({
                html: `<div style="font-size: 24px;">${data.role}</div>`,
                className: 'custom-div-icon'
            });
            const newMarker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map)
                .bindPopup(`<b>${data.role} ${data.id}</b><br><button onclick="orderService('${data.id}')">–¢–∞–ø—Å—ã—Ä—ã—Å</button>`);
            
            newMarker.role = data.role;
            newMarker.lastSeen = Date.now(); 
            markers[data.id] = newMarker;
        }
    });
</script>
</body>
</html>
