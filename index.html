<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba Multi-Contact Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root { --primary: #007bff; --success: #28a745; }
        body { font-family: sans-serif; margin: 0; background: #f4f7f6; }
        #map { height: 40vh; width: 100%; border-bottom: 3px solid var(--primary); }
        .contact-row { display: flex; gap: 5px; margin-top: 5px; }
        .contact-row select { width: 30%; }
        .contact-badge { 
            display: inline-block; 
            background: #e9ecef; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 11px; 
            margin: 2px; 
            border: 1px solid #ccc;
        }
        .admin-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 5px; }
        .add-btn { background: #6c757d; color: white; width: auto; padding: 5px 10px; cursor: pointer; border-radius: 5px; margin-top: 5px; display: inline-block; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="visible-list-container">
    <div style="padding:10px; font-weight:bold; background:#eee;">üìç –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞: (<span id="item-count">0</span>)</div>
    <div id="dynamic-list-content"></div>
</div>

<div class="container" style="padding: 15px;">
    <div class="card" id="form-worker" style="background: white; padding: 15px; border-radius: 10px; border-top: 5px solid var(--primary); margin-bottom: 15px;">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç –∂–∞—Ä–∏—è–ª–∞—É</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ">
        
        <div id="w_contacts_wrapper">
            <div class="contact-row">
                <select class="contact-type"><option value="–¢–µ–ª">–¢–µ–ª</option><option value="Email">Email</option><option value="Skype">Skype</option><option value="WA">WhatsApp</option></select>
                <input class="contact-val" placeholder="–ë–∞–π–ª–∞–Ω—ã—Å –¥–µ—Ä–µ–≥—ñ">
            </div>
        </div>
        <div class="add-btn" onclick="addContactField('w_contacts_wrapper')">+ –ë–∞–π–ª–∞–Ω—ã—Å “õ–æ—Å—É</div>
        
        <button onclick="saveWithContacts('worker')" style="background:var(--primary); color:white; width:100%; margin-top:10px; padding:10px; border:none; font-weight:bold;">–ñ–∞—Ä–∏—è–ª–∞—É</button>
    </div>
</div>

<div id="admin-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto;">
    <button onclick="location.hash=''" style="background:red; color:white; float:right;">–ñ–∞–±—É</button>
    <h3>–ê–¥–º–∏–Ω –ë–∞—Å“õ–∞—Ä—É</h3>
    <div id="admin-content"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
    const API = "https://sk-joba.onrender.com";
    const myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    // –ë–∞–π–ª–∞–Ω—ã—Å ”©—Ä—ñ—Å—ñ–Ω “õ–æ—Å—É
    function addContactField(wrapperId) {
        const div = document.createElement('div');
        div.className = 'contact-row';
        div.innerHTML = `
            <select class="contact-type"><option value="–¢–µ–ª">–¢–µ–ª</option><option value="Email">Email</option><option value="Skype">Skype</option><option value="WA">WhatsApp</option></select>
            <input class="contact-val" placeholder="–ë–∞–π–ª–∞–Ω—ã—Å –¥–µ—Ä–µ–≥—ñ">
            <button onclick="this.parentElement.remove()" style="width:auto; background:none; color:red; border:none;">X</button>
        `;
        document.getElementById(wrapperId).appendChild(div);
    }

    // –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∂–∏–Ω–∞—É (Contacts JSON —Ñ–æ—Ä–º–∞—Ç—ã–Ω–¥–∞)
    function getContacts(wrapperId) {
        const rows = document.getElementById(wrapperId).querySelectorAll('.contact-row');
        let arr = [];
        rows.forEach(row => {
            const type = row.querySelector('.contact-type').value;
            const val = row.querySelector('.contact-val').value;
            if(val) arr.push({type, val});
        });
        return arr;
    }

    function saveWithContacts(type) {
        let contacts = getContacts('w_contacts_wrapper');
        let d = {
            name: document.getElementById('w_name').value,
            job: document.getElementById('w_job').value,
            phone: contacts[0] ? contacts[0].val : '', // –ë—ñ—Ä—ñ–Ω—à—ñ –Ω”©–º—ñ—Ä –Ω–µ–≥—ñ–∑–≥—ñ —Ä–µ—Ç—ñ–Ω–¥–µ
            contacts: JSON.stringify(contacts),
            device_token: myToken
        };

        navigator.geolocation.getCurrentPosition(pos => {
            d.lat = pos.coords.latitude; d.lon = pos.coords.longitude;
            fetch(`${API}/save-worker`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(d)
            }).then(() => { alert("–°”ô—Ç—Ç—ñ —Å–∞“õ—Ç–∞–ª–¥—ã!"); location.reload(); });
        });
    }

    // –ê“õ–ø–∞—Ä–∞—Ç—Ç—ã –∫”©—Ä—Å–µ—Ç—É —Ñ—É–Ω–∫—Ü–∏—è—Å—ã
    function renderContactsHtml(contacts) {
        if(!contacts) return '';
        const arr = typeof contacts === 'string' ? JSON.parse(contacts) : contacts;
        return arr.map(c => `<span class="contact-badge"><b>${c.type}:</b> ${c.val}</span>`).join('');
    }

    // –ú–∞—Ä–∫–µ—Ä–ª–µ—Ä–¥—ñ –∂“Ø–∫—Ç–µ—É
    function loadMarkers() {
        fetch(API + '/get-all').then(r => r.json()).then(data => {
            const allItems = [...data.workers, ...data.goods, ...data.orders];
            document.getElementById('item-count').innerText = allItems.length;
            
            let listHtml = '';
            allItems.forEach(i => {
                const contactsHtml = renderContactsHtml(i.contacts);
                
                // –¢—ñ–∑—ñ–º–¥–µ–≥—ñ –∫”©—Ä—ñ–Ω—ñ—Å
                listHtml += `
                    <div class="list-item" style="border-bottom:1px solid #ddd; padding:10px;">
                        <div>
                            <b>${i.job || i.product_name || i.description}</b><br>
                            <small>${i.name || i.seller_name || i.client_name}</small><br>
                            <div style="margin-top:5px;">${contactsHtml}</div>
                        </div>
                    </div>
                `;

                // –ö–∞—Ä—Ç–∞–¥–∞“ì—ã –º–∞—Ä–∫–µ—Ä (“õ—ã—Å“õ–∞—à–∞)
                const m = L.marker([i.lat, i.lon]).addTo(map);
                m.bindPopup(`
                    <div style="text-align:center;">
                        <b>${i.job || i.product_name}</b><br>
                        ${contactsHtml}<br>
                        <a href="tel:${i.phone}" style="display:inline-block; margin-top:5px; background:green; color:white; padding:5px; border-radius:5px; text-decoration:none;">üìû “ö–æ“£—ã—Ä–∞—É</a>
                    </div>
                `);
            });
            document.getElementById('dynamic-list-content').innerHTML = listHtml;
            
            if(location.hash === '#admin777') renderAdmin(data.admin_all);
        });
    }

    function renderAdmin(adminData) {
        document.getElementById('admin-modal').style.display = 'block';
        let h = `<table class="admin-table"><tr><th>–ê—Ç—ã</th><th>–ñ“±–º—ã—Å—ã</th><th>–ë–∞—Ä–ª—ã“õ –±–∞–π–ª–∞–Ω—ã—Å</th><th>–£–∞“õ—ã—Ç—ã</th></tr>`;
        
        Object.keys(adminData).forEach(cat => {
            adminData[cat].forEach(item => {
                h += `<tr>
                    <td>${item.name || item.seller_name}</td>
                    <td>${item.job || item.product_name}</td>
                    <td>${renderContactsHtml(item.contacts)}</td>
                    <td>${new Date(item.created_at).toLocaleString()}</td>
                </tr>`;
            });
        });
        document.getElementById('admin-content').innerHTML = h + "</table>";
    }

    const map = L.map('map').setView([43.2389, 76.8897], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    loadMarkers();
</script>
</body>
</html>
