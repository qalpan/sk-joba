<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba | Live</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 50vh; width: 100%; background: #e0e0e0; }
        .search-box { padding: 15px; background: white; text-align: center; border-bottom: 2px solid #007bff; }
        .search-box input { width: 90%; padding: 12px; border-radius: 25px; border: 2px solid #007bff; outline: none; }
        .container { padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input, select, textarea, button { width: 100%; margin: 8px 0; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        
        /* –ú–∞—Ä–∫–µ—Ä —Å—Ç–∏–ª—ñ */
        .marker-label { background: white; border: 1px solid #007bff; border-radius: 4px; padding: 2px 5px; font-weight: bold; font-size: 11px; color: #333; }
        
        /* –ê–¥–º–∏–Ω –ú–æ–¥–∞–ª—å */
        #admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10000; padding:20px; overflow-y:auto; }
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .admin-tabs button { flex: 1; background: #6c757d; font-size: 12px; }
        .admin-tabs button.active { background: #007bff; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f8f9fa; }
    </style>
</head>
<body>

<div class="search-box">
    <input type="text" id="searchInput" placeholder="–Ü–∑–¥–µ—É: “ö—ã–∑–º–µ—Ç, –¢–∞—É–∞—Ä –Ω–µ–º–µ—Å–µ –¢–∞–ø—Å—ã—Ä—ã—Å..." oninput="filterMarkers()">
</div>

<div id="map"></div>

<div id="admin-modal">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h2>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h2>
        <button onclick="window.location.hash=''" style="background:red; width:80px; padding:5px;">–ñ–∞–±—É</button>
    </div>
    
    <div class="admin-tabs">
        <button id="tab-pending" onclick="loadAdmin('pending')" class="active">‚è≥ –ö–µ–∑–µ–∫—Ç–µ</button>
        <button id="tab-active" onclick="loadAdmin('active')">‚úÖ –ñ–∞—Ä–∏—è–ª–∞–Ω“ì–∞–Ω</button>
        <button id="tab-deleted" onclick="loadAdmin('deleted')">‚ùå –ñ–æ–π—ã–ª“ì–∞–Ω</button>
    </div>
    
    <div id="admin-content"></div>
</div>

<div class="container">
    <div class="card">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ">
        <input id="w_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <select id="w_dur">
            <option value="1">1 —Å–∞“ì–∞—Ç ‚Äî 49‚Ç∏</option>
            <option value="24">1 —Ç”ô—É–ª—ñ–∫ ‚Äî 490‚Ç∏</option>
        </select>
        <button onclick="saveItem('worker')">–¢”©–ª–µ—É –∂”ô–Ω–µ –¢—ñ—Ä–∫–µ—É</button>
    </div>

    <div class="card">
        <h4>üì¶ –¢–∞—É–∞—Ä</h4>
        <input id="g_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="g_prod" placeholder="–¢–∞—É–∞—Ä –∞—Ç–∞—É—ã">
        <input id="g_price" placeholder="–ë–∞“ì–∞—Å—ã">
        <input id="g_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <select id="g_dur">
            <option value="1">1 —Å–∞“ì–∞—Ç ‚Äî 49‚Ç∏</option>
            <option value="24">1 —Ç”ô—É–ª—ñ–∫ ‚Äî 490‚Ç∏</option>
        </select>
        <button onclick="saveItem('good')" style="background:#ffc107; color:black;">–¢”©–ª–µ—É –∂”ô–Ω–µ –ñ–∞—Ä–∏—è–ª–∞—É</button>
    </div>

    <div class="card">
        <h4>üìã –¢–∞–ø—Å—ã—Ä—ã—Å</h4>
        <input id="c_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <textarea id="c_desc" placeholder="–ù–µ “õ–∞–∂–µ—Ç?"></textarea>
        <input id="c_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <button onclick="saveItem('order')" style="background:#28a745;">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
    const API = "https://sk-joba.onrender.com";
    const myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    // –ö–ê–†–¢–ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø–°–´
    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markersGroup = L.markerClusterGroup();
    map.addLayer(markersGroup);

    // –ö–∞—Ä—Ç–∞ ”©–ª—à–µ–º—ñ–Ω —Ç“Ø–∑–µ—É
    setTimeout(() => { map.invalidateSize(); }, 500);

    let allData = { workers: [], goods: [], orders: [] };

    function v(id) { return document.getElementById(id).value.trim(); }

    function saveItem(type) {
        let d = {}, path = '';
        if(type==='worker'){ path='/save-worker'; d={name:v('w_name'), job:v('w_job'), phone:v('w_phone'), durationHours:v('w_dur')}; }
        if(type==='good'){ path='/save-goods'; d={name:v('g_name'), product:v('g_prod'), price:v('g_price'), phone:v('g_phone'), durationHours:v('g_dur')}; }
        if(type==='order'){ path='/save-order'; d={name:v('c_name'), description:v('c_desc'), phone:v('c_phone')}; }

        if(!d.phone) return alert("–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ–Ω –∂–∞–∑—ã“£—ã–∑!");

        navigator.geolocation.getCurrentPosition(p => {
            d.lat=p.coords.latitude; d.lon=p.coords.longitude; d.device_token=myToken;
            fetch(API+path, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)})
            .then(r => r.json())
            .then(() => {
                alert("”®—Ç—ñ–Ω—ñ–º –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ!");
                loadMarkers();
            });
        }, () => alert("GPS “õ–æ—Å—ã“£—ã–∑!"));
    }

    function loadMarkers() {
        fetch(API+'/get-all').then(r => r.json()).then(data => {
            allData = data;
            filterMarkers();
        }).catch(e => console.error("–î–µ—Ä–µ–∫ –∂“Ø–∫—Ç–µ–ª–º–µ–¥—ñ:", e));
    }

    function filterMarkers() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        markersGroup.clearLayers();

        const process = (arr, type, color, key) => {
            arr.forEach(i => {
                const text = i[key] || "";
                if (text.toLowerCase().includes(query) || query === "") {
                    addM(i.lat, i.lon, `<b>${type}</b><br>${text}<br>${i.phone}`, text, i.id, type, i.device_token, color);
                }
            });
        };

        process(allData.workers, 'worker', '#007bff', 'job');
        process(allData.goods, 'good', '#ffc107', 'product_name');
        process(allData.orders, 'order', '#28a745', 'description');
    }

    function addM(lat, lon, txt, mini, id, type, token, color) {
        const icon = L.divIcon({ html: `<div style="background:${color};width:14px;height:14px;border-radius:50%;border:2px solid white;"></div>`, className: '' });
        const m = L.marker([lat, lon], { icon });
        const delBtn = token === myToken ? `<br><button onclick="delItem(${id},'${type}')" style="background:red;padding:2px;font-size:10px;">”®—à—ñ—Ä—É</button>` : "";
        m.bindPopup(txt + delBtn);
        m.bindTooltip(mini.substring(0,15), { permanent: true, direction: 'top', className: 'marker-label', offset: [0, -10] });
        markersGroup.addLayer(m);
    }

    function delItem(id, type, admin=false) {
        if(!confirm("”®—à—ñ—Ä—É–¥—ñ —Ä–∞—Å—Ç–∞–π—Å—ã–∑ –±–∞?")) return;
        fetch(API+'/delete-item', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, type, token: admin ? 'ADMIN' : myToken})})
        .then(() => admin ? loadAdmin(currentTab) : loadMarkers());
    }

    // –ê–î–ú–ò–ù –õ–û–ì–ò–ö–ê–°–´
    let currentTab = 'pending';
    window.onhashchange = () => {
        if(location.hash === "#admin777") {
            const p = prompt("–ü–∞—Ä–æ–ª—å:");
            if(p === "admin777") { document.getElementById('admin-modal').style.display='block'; loadAdmin('pending'); }
        } else { document.getElementById('admin-modal').style.display='none'; }
    };

    function loadAdmin(status) {
        currentTab = status;
        document.querySelectorAll('.admin-tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + status).classList.add('active');

        fetch(`${API}/admin/list?status=${status}`).then(r => r.json()).then(list => {
            let html = `<table><tr><th>–¢“Ø—Ä—ñ</th><th>–ê“õ–ø–∞—Ä–∞—Ç</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>”ò—Ä–µ–∫–µ—Ç</th></tr>`;
            list.forEach(i => {
                const actionBtn = status === 'pending' ? `<button onclick="act(${i.id},'${i.type}')" style="background:green; padding:5px;">‚úÖ “ö–æ—Å—É</button>` : "";
                const delBtn = status !== 'deleted' ? `<button onclick="delItem(${i.id},'${i.type}',true)" style="background:red; padding:5px;">‚ùå ”®—à—ñ—Ä—É</button>` : "”®—à—ñ—Ä—ñ–ª–≥–µ–Ω";
                html += `<tr><td>${i.type}</td><td>${i.info}</td><td>${i.phone}</td><td>${actionBtn} ${delBtn}</td></tr>`;
            });
            document.getElementById('admin-content').innerHTML = list.length ? html + "</table>" : "<p style='padding:20px;'>–¢—ñ–∑—ñ–º –±–æ—Å.</p>";
        });
    }

    function act(id, type) {
        fetch(API+'/admin/activate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, type})}).then(() => loadAdmin('pending'));
    }

    loadMarkers();
</script>
</body>
</html>
