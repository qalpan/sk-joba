<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Marketplace: –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 45vh; width: 100%; border-bottom: 3px solid #007bff; }
        .filter-bar { padding: 10px; background: white; display: flex; gap: 10px; position: sticky; top: 0; z-index: 1000; }
        .container { padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        input, select, button, textarea { width: 100%; margin: 8px 0; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; }
        button { cursor: pointer; font-weight: bold; border: none; color: white; background: #007bff; }
        .kaspi-btn { display: block; background: #f00; color: #fff; text-align: center; padding: 10px; text-decoration: none; border-radius: 8px; font-weight: bold; }
        .marker-label { background: white; border: 1px solid #007bff; border-radius: 4px; padding: 2px 6px; font-weight: bold; font-size: 11px; }
        
        /* –ê–¥–º–∏–Ω –ö–µ—Å—Ç–µ—Å—ñ */
        #admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10001; padding:20px; overflow-y:auto; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        .admin-table th { background: #333; color: white; padding: 10px; text-align: left; }
        .admin-table td { border: 1px solid #ddd; padding: 10px; }
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="filter-bar">
    <select id="filter-type" onchange="loadAll()"><option value="all">–ë–∞—Ä–ª—ã“ì—ã</option><option value="worker">–ú–∞–º–∞–Ω–¥–∞—Ä</option><option value="good">–¢–∞—É–∞—Ä–ª–∞—Ä</option><option value="order">–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä</option></select>
    <input type="text" id="search-input" placeholder="–Ü–∑–¥–µ—É..." oninput="loadAll()">
</div>

<div id="map"></div>

<div class="container">
    <div class="card" style="border-top: 5px solid #007bff;">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç “±—Å—ã–Ω—É</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ">
        <input id="w_phone" placeholder="+77XXXXXXXXX">
        <select id="w_dur" onchange="updatePrice('worker')"><option value="1">1 —Å–∞“ì–∞—Ç (49 —Ç–≥)</option><option value="24">1 —Ç”ô—É–ª—ñ–∫ (490 —Ç–≥)</option></select>
        <a id="w_kaspi_link" href="#" target="_blank" class="kaspi-btn">Kaspi-–º–µ–Ω —Ç”©–ª–µ—É 49‚Ç∏</a>
        <button onclick="saveWorker()" style="margin-top:10px;">–¢”©–ª–µ–¥—ñ–º –∂”ô–Ω–µ –¢—ñ—Ä–∫–µ–ª—É</button>
    </div>

    <div class="card" style="border-top: 5px solid #ffc107;">
        <h4>üì¶ –¢–∞—É–∞—Ä —Å–∞—Ç—É</h4>
        <input id="g_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="g_prod" placeholder="–¢–∞—É–∞—Ä –∞—Ç—ã">
        <input id="g_phone" placeholder="+77XXXXXXXXX">
        <select id="g_dur" onchange="updatePrice('good')"><option value="1">1 —Å–∞“ì–∞—Ç (49 —Ç–≥)</option><option value="24">1 —Ç”ô—É–ª—ñ–∫ (490 —Ç–≥)</option></select>
        <a id="g_kaspi_link" href="#" target="_blank" class="kaspi-btn" style="background:#ffc107; color:black;">Kaspi-–º–µ–Ω —Ç”©–ª–µ—É 49‚Ç∏</a>
        <button onclick="saveGoods()" style="background:#ffc107; color:black; margin-top:10px;">–¢”©–ª–µ–¥—ñ–º –∂”ô–Ω–µ “ö–æ—Å—É</button>
    </div>

    <div class="card" style="border-top: 5px solid #dc3545;">
        <h4>üìã –¢–∞–ø—Å—ã—Ä—ã—Å (–¢–µ–≥—ñ–Ω)</h4>
        <input id="c_name" placeholder="–ê—Ç—ã“£—ã–∑"><textarea id="c_desc" placeholder="–ù–µ “õ–∞–∂–µ—Ç?"></textarea><input id="c_phone" placeholder="+77XXXXXXXXX">
        <button style="background: #dc3545;" onclick="saveOrder()">–ñ–∞—Ä–∏—è–ª–∞—É</button>
    </div>
</div>

<div id="admin-modal">
    <button onclick="closeAdmin()" style="background:#333; float:right; width:auto; padding:5px 15px;">‚ùå –ñ–∞–±—É</button>
    <h2>–ê–¥–º–∏–Ω: –¢”©–ª–µ–º–¥–µ—Ä–¥—ñ —Ç–µ–∫—Å–µ—Ä—É</h2>
    <div id="admin-table-container" style="overflow-x:auto;"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>

<script>
    const API = "https://sk-joba.onrender.com";
    const myKaspiPhone = "77012223344"; // –û–°–´ –ñ–ï–†–ì–ï ”®–ó –ù”®–ú–Ü–†–Ü“¢–Ü–ó–î–Ü –ñ–ê–ó–´“¢–´–ó
    const myToken = localStorage.getItem('device_token') || Math.random().toString(36).substring(2);
    localStorage.setItem('device_token', myToken);

    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const oms = new OverlappingMarkerSpiderfier(map, { keepSpiderfied: true });

    function updatePrice(type) {
        const dur = document.getElementById(type === 'worker' ? 'w_dur' : 'g_dur').value;
        const price = dur === "1" ? 49 : 490;
        const link = document.getElementById(type === 'worker' ? 'w_kaspi_link' : 'g_kaspi_link');
        link.innerText = `Kaspi-–º–µ–Ω —Ç”©–ª–µ—É ${price}‚Ç∏`;
        link.href = `https://kaspi.kz/pay/_/transfer?number=${myKaspiPhone}&amount=${price}`;
    }
    updatePrice('worker'); updatePrice('good');

    function loadAll() {
        fetch(`${API}/get-all`).then(res => res.json()).then(data => {
            map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });
            oms.clearMarkers();
            const typeF = document.getElementById('filter-type').value;
            const searchF = document.getElementById('search-input').value.toLowerCase();

            if(typeF === 'all' || typeF === 'worker') data.workers.forEach(w => { if(w.job.toLowerCase().includes(searchF)) addMarker(w, 'worker', 'blue', w.job); });
            if(typeF === 'all' || typeF === 'good') data.goods.forEach(g => { if(g.product_name.toLowerCase().includes(searchF)) addMarker(g, 'good', 'yellow', g.product_name); });
            if(typeF === 'all' || typeF === 'order') data.orders.forEach(o => { if(o.description.toLowerCase().includes(searchF)) addMarker(o, 'order', 'red', o.description.substring(0,12)); });
        });
    }

    function addMarker(item, type, color, miniText) {
        const marker = L.marker([item.lat, item.lon], { icon: L.icon({ iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`, shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41] }) }).addTo(map);
        let content = `<b>${item.name || item.seller_name || item.client_name}</b><br>${item.job || item.product_name || item.description}<br><a href="tel:${item.phone}">${item.phone}</a>`;
        if(item.device_token === myToken) content += `<br><button onclick="delItem('${type}', ${item.id})" style="background:red; font-size:10px; padding:3px; color:white; border:none; margin-top:5px;">”®—à—ñ—Ä—É</button>`;
        marker.bindPopup(content).bindTooltip(miniText, { permanent: true, direction: 'top', className: 'marker-label' });
        oms.addMarker(marker);
    }

    function saveWorker() {
        navigator.geolocation.getCurrentPosition(p => {
            fetch(`${API}/save-worker`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: v('w_name'), job: v('w_job'), phone: v('w_phone'), durationHours: v('w_dur'), device_token: myToken, lat: p.coords.latitude, lon: p.coords.longitude }) }).then(() => alert("–¢”©–ª–µ–º–¥—ñ —Ç–µ–∫—Å–µ—Ä—É–≥–µ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ."));
        });
    }

    function saveGoods() {
        navigator.geolocation.getCurrentPosition(p => {
            fetch(`${API}/save-goods`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: v('g_name'), product: v('g_prod'), phone: v('g_phone'), durationHours: v('g_dur'), device_token: myToken, lat: p.coords.latitude, lon: p.coords.longitude }) }).then(() => alert("–¢–∞—É–∞—Ä —Ç–µ–∫—Å–µ—Ä—É–≥–µ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ."));
        });
    }

    function saveOrder() {
        navigator.geolocation.getCurrentPosition(p => {
            fetch(`${API}/save-order`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: v('c_name'), description: v('c_desc'), phone: v('c_phone'), device_token: myToken, lat: p.coords.latitude, lon: p.coords.longitude }) }).then(() => loadAll());
        });
    }

    // --- –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ ---
    window.onhashchange = () => {
        if(location.hash === "#admin777") {
            const p = prompt("“ö“±–ø–∏—è—Å”©–∑:");
            if(p === "admin777") { document.getElementById('admin-modal').style.display='block'; loadPending(); }
        }
    };

    function loadPending() {
        fetch(`${API}/admin/pending`).then(res => res.json()).then(list => {
            let html = `<table class="admin-table"><tr><th>–£–∞“õ—ã—Ç—ã</th><th>–ê—Ç—ã</th><th>–ê“õ–ø–∞—Ä–∞—Ç</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–¢–∞—Ä–∏—Ñ</th><th>”ò—Ä–µ–∫–µ—Ç</th></tr>`;
            list.forEach(i => {
                const badgeColor = i.duration === '24 —Å–∞“ì–∞—Ç' ? 'green' : 'orange';
                html += `<tr>
                    <td>${i.date_text}</td>
                    <td>${i.name}</td>
                    <td>${i.info}</td>
                    <td><a href="tel:${i.phone}">${i.phone}</a></td>
                    <td><span class="badge" style="background:${badgeColor}; color:white;">${i.duration}</span></td>
                    <td><button onclick="activate('${i.id}', '${i.type}')" style="background:green; padding:5px; width:auto;">–†–∞—Å—Ç–∞—É</button></td>
                </tr>`;
            });
            document.getElementById('admin-table-container').innerHTML = list.length ? html + "</table>" : "<h4>–ñ–∞“£–∞ ”©—Ç—ñ–Ω—ñ–º –∂–æ“õ</h4>";
        });
    }

    function activate(id, type) {
        fetch(`${API}/admin/activate`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id, type }) }).then(() => loadPending());
    }

    function v(id) { return document.getElementById(id).value; }
    function delItem(type, id) { if(confirm("”®—à—ñ—Ä–µ—Å—ñ–∑ –±–µ?")) fetch(`${API}/delete/${type}/${id}`, { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ device_token: myToken }) }).then(() => loadAll()); }
    function closeAdmin() { document.getElementById('admin-modal').style.display='none'; location.hash=""; }
    loadAll();
</script>
</body>
</html>
