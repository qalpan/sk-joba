<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>–ö–∞—Ä—Ç–∞ –•–∞–±–∞—Ä–ª–∞–º–∞</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        #map { height: 45vh; width: 100%; transition: 0.5s; }
        .grayscale { filter: grayscale(1) brightness(0.8); }
        .card { border-left: 5px solid #007bff; padding: 10px; margin: 10px 0; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 5px; }
        .card.vip { border-left-color: gold; background: #fffef0; }
        .info-full { font-size: 13px; color: #333; margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px; }
        #adminPanel { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:1000; padding:20px; overflow:auto; }
        input, select, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        .btn-post { background: #28a745; color: #fff; border: none; cursor: pointer; }
        .btn-vip { background: gold; color: #000; border: none; cursor: pointer; }
    </style>
</head>
<body style="margin:0; background:#f0f2f5; font-family:sans-serif;">

<div id="map"></div>

<div style="padding:15px;">
    <button onclick="document.getElementById('map').classList.toggle('grayscale')" style="background:#333; color:#fff;">üåì –¢“Ø—Å—Ç—ñ / –ê“õ-“õ–∞—Ä–∞ –∫–∞—Ä—Ç–∞</button>

    <input type="text" id="search" placeholder="üîç –°–∞–Ω–∞—Ç, –º–∞–º–∞–Ω–¥—ã“õ –Ω–µ–º–µ—Å–µ —Ç–∞—É–∞—Ä..." oninput="render()">

    <h4 style="margin:15px 0 5px 0;">üìç –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞: (<span id="count">0</span>)</h4>
    <div id="list"></div>

    <hr>

    <h4>üì¢ –ñ–∞—Ä–∏—è–ª–∞—É</h4>
    <select id="p_type"><option>“ö—ã–∑–º–µ—Ç</option><option>–¢–∞—É–∞—Ä</option><option>–¢–∞–ø—Å—ã—Ä—ã—Å</option></select>
    <input id="p_name" placeholder="–ê—Ç—ã“£—ã–∑ (–º–∏–Ω. 2 —Ç–∞“£–±–∞)">
    <input id="p_job" placeholder="“ö–∞–Ω–¥–∞–π “õ—ã–∑–º–µ—Ç –Ω–µ–º–µ—Å–µ —Ç–∞—É–∞—Ä?">
    <input id="p_tel" placeholder="–¢–µ–ª: +77001234567 (12 —Ç–∞“£–±–∞)">
    <input id="p_email" placeholder="Email: example@mail.kz">
    
    <div style="display:flex; gap:10px;">
        <button onclick="saveAd(false)" class="btn-post">–¢–µ–≥—ñ–Ω (–õ–µ–∑–¥–µ)</button>
        <button onclick="saveAd(true)" class="btn-vip">üíé VIP (–ê–¥–º–∏–Ω–Ω–µ–Ω —Å–æ“£)</button>
    </div>
</div>

<div id="adminPanel">
    <div style="display:flex; justify-content:space-between;">
        <h2>üõ° –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h2>
        <button onclick="location.hash=''" style="width:auto;">–ñ–∞–±—É</button>
    </div>
    <div id="admin-table"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
    const API = "https://sk-joba.onrender.com"; 
    let myToken = localStorage.getItem('token') || "U" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('token', myToken);

    let map = L.map('map', {zoomControl: false}).setView([43.2389, 76.8897], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let rawData = [];
    let markers = [];

    // 1 –¢–ê–õ–ê–ü: “ö–∞—Ç–∞“£ —Ç–µ–∫—Å–µ—Ä—É (Regex)
    function checkValid() {
        const n = document.getElementById('p_name').value, 
              j = document.getElementById('p_job').value,
              t = document.getElementById('p_tel').value, 
              e = document.getElementById('p_email').value;

        if (n.length < 2 || j.length < 2) return alert("–ê—Ç—ã –Ω–µ–º–µ—Å–µ –º”ô—Ç—ñ–Ω –∫–µ–º—ñ–Ω–¥–µ 2 —Ç–∞“£–±–∞!");
        if (!/^\+7\d{10}$/.test(t.replace(/\s/g, ""))) return alert("–¢–µ–ª “õ–∞—Ç–µ! –§–æ—Ä–º–∞—Ç: +77011112233 (12 —Ç–∞“£–±–∞)");
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)) return alert("Email “õ–∞—Ç–µ! (@ –∂”ô–Ω–µ . –±–æ–ª—É—ã —à–∞—Ä—Ç)");
        return true;
    }

    async function load() {
        try {
            const r = await fetch(API + '/ads');
            if (!r.ok) throw new Error("–°–µ—Ä–≤–µ—Ä “õ–∞—Ç–µ—Å—ñ (500)");
            rawData = await r.json();
            render();
            checkAdmin();
        } catch(e) { console.error("–î–µ—Ä–µ–∫ –∂“Ø–∫—Ç–µ–ª–º–µ–¥—ñ:", e); }
    }

    // 5 & 6 –¢–ê–õ–ê–ü–¢–ê–†: –¢–æ–ª—ã“õ –∞“õ–ø–∞—Ä–∞—Ç –∂”ô–Ω–µ –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞
    function render() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        let listH = "", count = 0;
        const search = document.getElementById('search').value.toLowerCase();
        const bounds = map.getBounds();

        rawData.forEach(i => {
            const isOwner = i.token === myToken;
            if (i.is_vip && !i.is_active && !isOwner) return; // 4-—Ç–∞–ª–∞–ø: VIP –∞–¥–º–∏–Ω—Å—ñ–∑ –∫”©—Ä—ñ–Ω–±–µ–π–¥—ñ
            if (!i.is_vip && !i.is_online && !isOwner) return; // 3-—Ç–∞–ª–∞–ø: –¢–µ–≥—ñ–Ω —Ç–µ–∫ –æ–Ω–ª–∞–π–Ω –±–æ–ª—Å–∞

            if (search && !i.job.toLowerCase().includes(search) && !i.name.toLowerCase().includes(search)) return;

            // “ö–∞–±–∞—Ç—Ç–∞—Å—É–¥—ã –±–æ–ª–¥—ã—Ä–º–∞—É (Jitter)
            const lat = i.lat + (Math.random() - 0.5) * 0.0006;
            const lon = i.lon + (Math.random() - 0.5) * 0.0006;

            const m = L.circleMarker([lat, lon], { 
                radius: 10, 
                color: i.is_vip ? 'gold':'blue', 
                fillColor: i.is_online?'green':'gray', 
                fillOpacity:0.8 
            }).addTo(map);

            // 5 –¢–ê–õ–ê–ü: –ú–∏–Ω–∏ –∞“õ–ø–∞—Ä–∞—Ç (Popup)
            m.bindPopup(`<b>${i.job}</b><br>üìû ${i.tel}<br>üìß ${i.email}`);
            markers.push(m);

            if (bounds.contains([lat, lon])) {
                count++;
                listH += `
                <div class="card ${i.is_vip?'vip':''}">
                    <b>${i.job}</b> <small>(${i.type})</small> ${i.is_online?'üü¢':'‚ö™'}<br>
                    <small>–ò–µ—Å—ñ: ${i.name}</small>
                    <div class="info-full" style="font-size:12px; background:#f9f9f9; padding:5px; margin-top:5px;">
                        üìû ${i.tel} <br> üìß ${i.email}
                    </div>
                </div>`;
            }
        });
        document.getElementById('count').innerText = count;
        document.getElementById('list').innerHTML = listH;
    }

    // 2 –¢–ê–õ–ê–ü: –ö–∞—Ä—Ç–∞ —Ç“Ø—Å—ñ–Ω –∞—É—ã—Å—Ç—ã—Ä—É
    function toggleMapMode() {
        document.getElementById('map').classList.toggle('grayscale');
    }

    async function saveAd(isVip) {
        if (!checkValid()) return;
        navigator.geolocation.getCurrentPosition(async p => {
            const res = await fetch(API + '/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: document.getElementById('p_name').value, 
                    job: document.getElementById('p_job').value,
                    type: document.getElementById('p_type').value, 
                    tel: document.getElementById('p_tel').value,
                    email: document.getElementById('p_email').value, 
                    is_vip: isVip, 
                    token: myToken,
                    lat: p.coords.latitude, 
                    lon: p.coords.longitude
                })
            });
            if (isVip) alert("VIP —Ç”©–ª–µ–º —Ö–∞–±–∞—Ä–ª–∞–º–∞—Å—ã –∞–¥–º–∏–Ω–≥–µ –∫–µ—Ç—Ç—ñ!");
            load();
        }, () => alert("GPS “õ–æ—Å—ã“£—ã–∑!"), { enableHighAccuracy: true });
    }

    // –ë–∞—Å“õ–∞ —Ñ—É–Ω–∫—Ü–∏—è–ª–∞—Ä (admAct, checkAdmin, —Ç.–±. ”©–∑–≥–µ—Ä—ñ—Å—Å—ñ–∑)
</script>
</body>
</html>
