<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace SK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 45vh; width: 100%; border-bottom: 3px solid #007bff; }
        .container { padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input, select, textarea, button { width: 100%; margin: 8px 0; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        .kaspi { display: block; background: #e81d25; color: white; text-align: center; padding: 10px; border-radius: 8px; text-decoration: none; font-weight: bold; margin-bottom: 5px; }
        #admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10001; padding:20px; overflow-y:auto; }
        .admin-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 10px; }
        .invalid { border: 2px solid red !important; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="container">
    <div class="card">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç “±—Å—ã–Ω—É</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ">
        <input id="w_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <select id="w_dur" onchange="updPrice('w')"><option value="1">1 —Å–∞“ì–∞—Ç (49‚Ç∏)</option><option value="24">1 —Ç”ô—É–ª—ñ–∫ (490‚Ç∏)</option></select>
        <a id="w_link" href="https://kaspi.kz/pay/_/transfer?number=77012223344&amount=49" target="_blank" class="kaspi">Kaspi —Ç”©–ª–µ—É 49‚Ç∏</a>
        <button onclick="saveWorker(this)">–¢”©–ª–µ–¥—ñ–º –∂”ô–Ω–µ –¢—ñ—Ä–∫–µ–ª—É</button>
    </div>

    <div class="card">
        <h4>üì¶ –¢–∞—É–∞—Ä —Å–∞—Ç—É</h4>
        <input id="g_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="g_prod" placeholder="–¢–∞—É–∞—Ä –∞—Ç—ã">
        <input id="g_price" placeholder="–ë–∞“ì–∞—Å—ã (–¢–µ–∫ —Å–∞–Ω)">
        <input id="g_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <select id="g_dur" onchange="updPrice('g')"><option value="1">1 —Å–∞“ì–∞—Ç (49‚Ç∏)</option><option value="24" selected>1 —Ç”ô—É–ª—ñ–∫ (490‚Ç∏)</option></select>
        <a id="g_link" href="https://kaspi.kz/pay/_/transfer?number=77012223344&amount=490" target="_blank" class="kaspi" style="background:#ffc107; color:black;">Kaspi —Ç”©–ª–µ—É 490‚Ç∏</a>
        <button onclick="saveGoods(this)" style="background:#ffc107; color:black;">–¢”©–ª–µ–¥—ñ–º –∂”ô–Ω–µ “ö–æ—Å—É</button>
    </div>

    <div class="card">
        <h4>üìã –¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É (–¢–µ–≥—ñ–Ω)</h4>
        <input id="c_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <textarea id="c_desc" placeholder="–ù–µ “õ–∞–∂–µ—Ç?"></textarea>
        <input id="c_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <button onclick="saveOrder(this)" style="background:#28a745;">–ñ–∞—Ä–∏—è–ª–∞—É</button>
    </div>
</div>

<div id="admin-modal">
    <button onclick="window.location.hash=''" style="width:auto; float:right;">‚ùå –ñ–∞–±—É</button>
    <h3>–ê–¥–º–∏–Ω: –¢”©–ª–µ–º–¥–µ—Ä</h3>
    <div id="admin-list"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
    const API = "https://sk-joba.onrender.com";
    const myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markersGroup = L.layerGroup().addTo(map);

    function updPrice(p) {
        const d = document.getElementById(p+'_dur').value;
        const pr = d == '1' ? 49 : 490;
        const l = document.getElementById(p+'_link');
        l.innerText = `Kaspi —Ç”©–ª–µ—É ${pr}‚Ç∏`;
        l.href = `https://kaspi.kz/pay/_/transfer?number=77012223344&amount=${pr}`;
    }

    // “ö–ê–¢–ê“¢ –í–ê–õ–ò–î–ê–¶–ò–Ø (–ë“±—Ä—ã–Ω“ì—ã –¥“±—Ä—ã—Å –Ω“±—Å“õ–∞)
    function check(ids, numIds = []) {
        let ok = true;
        ids.forEach(id => {
            const el = document.getElementById(id);
            const val = el.value.trim();
            if(!val) { el.classList.add('invalid'); ok = false; }
            else if(numIds.includes(id) && isNaN(val.replace(/\s/g, ''))) { 
                el.classList.add('invalid'); 
                alert("–ë“±–ª ”©—Ä—ñ—Å–∫–µ —Ç–µ–∫ —Å–∞–Ω –∂–∞–∑—ã“£—ã–∑!"); 
                ok = false; 
            }
            else { el.classList.remove('invalid'); }
        });
        if(!ok) alert("–ë–∞—Ä–ª—ã“õ –∂–æ–ª–¥—ã –¥“±—Ä—ã—Å —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑!");
        return ok;
    }

    function saveWorker(btn) {
        if(!check(['w_name','w_job','w_phone'])) return;
        btn.disabled = true;
        navigator.geolocation.getCurrentPosition(p => {
            send('/save-worker', {name:v('w_name'), job:v('w_job'), phone:v('w_phone'), durationHours:v('w_dur'), lat:p.coords.latitude, lon:p.coords.longitude, device_token:myToken}, btn);
        }, () => { alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è “õ–∞–∂–µ—Ç!"); btn.disabled = false; });
    }

    function saveGoods(btn) {
        if(!check(['g_name','g_prod','g_price','g_phone'], ['g_price'])) return;
        btn.disabled = true;
        navigator.geolocation.getCurrentPosition(p => {
            send('/save-goods', {name:v('g_name'), product:v('g_prod'), price:v('g_price'), phone:v('g_phone'), durationHours:v('g_dur'), lat:p.coords.latitude, lon:p.coords.longitude, device_token:myToken}, btn);
        }, () => { alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è “õ–∞–∂–µ—Ç!"); btn.disabled = false; });
    }

    function saveOrder(btn) {
        if(!check(['c_name','c_desc','c_phone'])) return;
        btn.disabled = true;
        navigator.geolocation.getCurrentPosition(p => {
            send('/save-order', {name:v('c_name'), description:v('c_desc'), phone:v('c_phone'), lat:p.coords.latitude, lon:p.coords.longitude, device_token:myToken}, btn);
        }, () => { alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è “õ–∞–∂–µ—Ç!"); btn.disabled = false; });
    }

    function send(path, data, btn) {
        fetch(API+path, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)})
        .then(() => { alert("–°”ô—Ç—Ç—ñ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ!"); location.reload(); })
        .catch(() => { alert("–°–µ—Ä–≤–µ—Ä “õ–∞—Ç–µ—Å—ñ!"); btn.disabled = false; });
    }

    // –ö–ê–†–¢–ê–î–ê“í–´ –¢–û–õ–´“ö –ü–û–ü–ê–ü –ê“ö–ü–ê–†–ê–¢–´
    function loadMarkers() {
        fetch(API + '/get-all').then(r => r.json()).then(data => {
            markersGroup.clearLayers();
            data.workers.forEach(w => L.marker([w.lat, w.lon]).addTo(markersGroup).bindPopup(`<b>üë∑ ${w.job}</b><br>–ê—Ç—ã: ${w.name}<br>–¢–µ–ª: <a href="tel:${w.phone}">${w.phone}</a>`));
            data.goods.forEach(g => {
                const icon = L.divIcon({html: `<div style="background:#ffc107;width:15px;height:15px;border-radius:50%;border:2px solid #fff;"></div>`, className:''});
                L.marker([g.lat, g.lon], {icon}).addTo(markersGroup).bindPopup(`<b>üì¶ ${g.product_name}</b><br>–ë–∞“ì–∞—Å—ã: ${g.price}‚Ç∏<br>–°–∞—Ç—É—à—ã: ${g.seller_name}<br>–¢–µ–ª: <a href="tel:${g.phone}">${g.phone}</a>`);
            });
            data.orders.forEach(o => {
                const icon = L.divIcon({html: `<div style="background:#28a745;width:15px;height:15px;border-radius:50%;border:2px solid #fff;"></div>`, className:''});
                L.marker([o.lat, o.lon], {icon}).addTo(markersGroup).bindPopup(`<b>üìã –¢–ê–ü–°–´–†–´–°</b><br>${o.description}<br>–ö–ª–∏–µ–Ω—Ç: ${o.client_name}<br>–¢–µ–ª: <a href="tel:${o.phone}">${o.phone}</a>`);
            });
        });
    }

    function v(id) { return document.getElementById(id).value; }

    window.onhashchange = () => {
        if(location.hash === "#admin777") {
            const p = prompt("–ü–∞—Ä–æ–ª—å:");
            if(p === "admin777") { document.getElementById('admin-modal').style.display='block'; loadAdmin(); }
        } else { document.getElementById('admin-modal').style.display='none'; }
    };

    function loadAdmin() {
        fetch(API+'/admin/pending').then(r => r.json()).then(list => {
            let h = `<table class="admin-table"><tr><th>–ö“Ø–Ω—ñ</th><th>–ê—Ç—ã/–¢–µ–ª</th><th>–ê“õ–ø–∞—Ä–∞—Ç</th><th>–°–æ–º–∞</th><th>”ò—Ä–µ–∫–µ—Ç</th></tr>`;
            list.forEach(i => h += `<tr><td>${i.d}</td><td>${i.name}<br>${i.phone}</td><td>${i.info}</td><td style="color:red;font-weight:bold;">${i.p}</td><td><button onclick="act('${i.id}','${i.type}')">–†–∞—Å—Ç–∞—É</button></td></tr>`);
            document.getElementById('admin-list').innerHTML = list.length ? h + "</table>" : "”®—Ç—ñ–Ω—ñ–º –∂–æ“õ.";
        });
    }

    function act(id, type) {
        fetch(API+'/admin/activate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, type})}).then(() => loadAdmin());
    }

    loadMarkers();
    if(window.location.hash === "#admin777") window.onhashchange();
</script>
</body>
</html>
