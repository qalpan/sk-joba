<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba: –¢–æ–ª—ã“õ –ñ”©–Ω–¥–µ–ª–≥–µ–Ω</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root { --blue: #007bff; --gold: #ffd700; --red: #dc3545; --green: #28a745; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Arial; height: 100%; overflow: hidden; background: #f4f4f4; }
        
        #map { height: 45vh; width: 100%; background: #ddd; }
        .grayscale { filter: grayscale(100%) brightness(0.9); }
        
        .main-container { height: 55vh; overflow-y: auto; background: #fff; padding: 15px; box-sizing: border-box; }
        .card { border: 1px solid #eee; padding: 12px; margin-bottom: 10px; border-radius: 8px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card.vip { border-left: 6px solid var(--gold); background: #fffdf2; }
        .card.free { border-left: 6px solid var(--blue); }
        
        /* 5. –¢–æ–ª—ã“õ –∞“õ–ø–∞—Ä–∞—Ç —Å—Ç–∏–ª—ñ */
        .info-chip { display: inline-block; background: #e9ecef; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin: 2px; border: 1px solid #dee2e6; }
        .info-chip b { color: var(--blue); }

        input, select, button { width: 100%; padding: 12px; margin-top: 8px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; border: none; transition: 0.2s; }
        .btn-post { background: var(--green); color: white; }
        .btn-vip { background: var(--gold); color: black; }
        .btn-del { background: var(--red); color: white; width: auto; padding: 5px 12px; font-size: 11px; float: right; border-radius: 4px; }
        
        /* 5. –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å */
        #adminPanel { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto; }
        .admin-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 15px; }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="main-container">
    <button onclick="toggleMap()" style="background:#333; color:white;">üåì –ö–∞—Ä—Ç–∞ —Ç“Ø—Ä—ñ (–¢“Ø—Å—Ç—ñ / –ê“õ-“õ–∞—Ä–∞)</button>

    <div style="margin: 15px 0;">
        <input type="text" id="searchInput" placeholder="üîç –ú–∞–º–∞–Ω–¥—ã“õ, —Ç–∞—É–∞—Ä –Ω–µ–º–µ—Å–µ —Å–∏–ø–∞—Ç—Ç–∞–º–∞ –±–æ–π—ã–Ω—à–∞ —ñ–∑–¥–µ—É..." oninput="filterMarkers()">
        <select id="catFilter" onchange="filterMarkers()" style="margin-top:5px;"></select>
    </div>

    <div id="nearby-section">
        <h4 style="margin: 0; color: var(--blue);">üìç –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞: (<span id="item-count">0</span>)</h4>
        <div id="list-content" style="margin-top:10px;"></div>
    </div>

    <hr style="margin: 25px 0;">

    <div id="add-form">
        <h4>üì¢ –ñ–∞“£–∞ —Ö–∞–±–∞—Ä–ª–∞–º–∞ –∂–∞—Ä–∏—è–ª–∞—É</h4>
        <select id="p_type">
            <option value="“ö—ã–∑–º–µ—Ç">üë∑ “ö—ã–∑–º–µ—Ç (–ú–∞–º–∞–Ω–¥—ã“õ)</option>
            <option value="–¢–∞—É–∞—Ä">üì¶ –¢–∞—É–∞—Ä (–°–∏–ø–∞—Ç—Ç–∞–º–∞)</option>
            <option value="–¢–∞–ø—Å—ã—Ä—ã—Å">üõí –¢–∞–ø—Å—ã—Ä—ã—Å (–ë”©–ª—ñ–º)</option>
        </select>
        <input id="p_name" placeholder="–ê—Ç—ã“£—ã–∑ (–º–∏–Ω. 2 —Ç–∞“£–±–∞)">
        <input id="p_job" placeholder="–ù–µ “±—Å—ã–Ω–∞—Å—ã–∑ –Ω–µ–º–µ—Å–µ –Ω–µ –∫–µ—Ä–µ–∫?">
        
        <div id="contact_list">
            <div class="c-row" style="display:flex; gap:5px; margin-top:5px;">
                <select class="ct" style="width:35%"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option></select>
                <input class="cv" style="width:65%" placeholder="–î–µ—Ä–µ–∫">
            </div>
        </div>
        <button onclick="addContactField()" style="background:none; color:var(--blue); font-size:12px; width:auto; border:none; text-decoration:underline;">+ –ë–∞–π–ª–∞–Ω—ã—Å —Ç“Ø—Ä—ñ–Ω “õ–æ—Å—É</button>
        
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="submitData(false)" class="btn-post">–¢–µ–≥—ñ–Ω (–õ–µ–∑–¥–µ)</button>
            <button onclick="submitData(true)" class="btn-vip">üíé VIP (–¢”©–ª–µ–º–º–µ–Ω)</button>
        </div>
    </div>
</div>

<div id="adminPanel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>üõ° ”ò–∫—ñ–º—à—ñ–ª—ñ–∫ –ø–∞–Ω–µ–ª—ñ</h2>
        <button onclick="location.hash=''" style="width:auto; background:var(--red); color:white; padding:5px 20px;">–ñ–∞–±—É</button>
    </div>
    <table class="admin-table">
        <thead>
            <tr>
                <th>–£–∞“õ—ã—Ç / ID</th>
                <th>–ê—Ç—ã / –°–∞–Ω–∞—Ç</th>
                <th>–ë–∞–π–ª–∞–Ω—ã—Å –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ (–¢–æ–ª—ã“õ)</th>
                <th>–¢”©–ª–µ–º —Å—Ç–∞—Ç—É—Å—ã</th>
                <th>”ò—Ä–µ–∫–µ—Ç—Ç–µ—Ä</th>
            </tr>
        </thead>
        <tbody id="admin-tbody"></tbody>
    </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<script>
    const API = "https://sk-joba.onrender.com";
    let myToken = localStorage.getItem('token') || "T" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('token', myToken);

    let map = L.map('map', {zoomControl: false}).setView([43.2389, 76.8897], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let markers = [];
    let rawData = [];

    // 1. –°—Ç–∞–Ω–¥–∞—Ä—Ç—Ç—ã –í–∞–ª–∏–¥–∞—Ü–∏—è
    function validateInput(type, val) {
        val = val.trim();
        if (type === '–¢–µ–ª') return /^\+7\d{10}$/.test(val.replace(/\s+/g, ''));
        if (type === 'Email') return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
        return val.length >= 2;
    }

    function toggleMap() { document.getElementById('map').classList.toggle('grayscale'); }
    
    function addContactField() {
        const div = document.createElement('div');
        div.className = 'c-row'; div.style = "display:flex; gap:5px; margin-top:5px;";
        div.innerHTML = `<select class="ct" style="width:35%"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option></select><input class="cv" style="width:65%" placeholder="–î–µ—Ä–µ–∫">`;
        document.getElementById('contact_list').appendChild(div);
    }

    async function fetchData() {
        try {
            const r = await fetch(API + '/get-all');
            rawData = await r.json();
            
            // 7. –°–∞–Ω–∞—Ç—Ç–∞—Ä–¥—ã –∞–≤—Ç–æ–º–∞—Ç—Ç—ã –∂–∏–Ω–∞—É
            const sel = document.getElementById('catFilter');
            const cats = [...new Set(rawData.map(i => i.job))].filter(Boolean);
            sel.innerHTML = '<option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
            
            handleAdminAccess();
            filterMarkers();
        } catch(e) { console.error("–î–µ—Ä–µ–∫ –∞–ª—É “õ–∞—Ç–µ—Å—ñ"); }
    }

    function filterMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        let listH = "", count = 0, now = Date.now();
        const search = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('catFilter').value;
        const bounds = map.getBounds();

        rawData.forEach(i => {
            const isOnline = (now - (i.last_ping || 0)) < 40000;
            const isOwner = i.token === myToken;

            // 3 & 4. –ö”©—Ä—ñ–Ω—É –ª–æ–≥–∏–∫–∞—Å—ã (VIP —Ç–µ–∫ –∞–¥–º–∏–Ω —Ä“±“õ—Å–∞—Ç—ã–º–µ–Ω –Ω–µ–º–µ—Å–µ –∏–µ—Å—ñ–Ω–µ)
            if (i.is_vip && !i.is_active && !isOwner) return;
            if (!i.is_vip && !isOnline && !isOwner) return;

            // 7. –°“±—Ä—ã–ø—Ç–∞—É
            if (cat && i.job !== cat) return;
            if (search && !i.job.toLowerCase().includes(search) && !i.name.toLowerCase().includes(search)) return;

            // “ö–∞–±–∞—Ç—Ç–∞—Å—É–¥—ã –±–æ–ª–¥—ã—Ä–º–∞—É (jitter)
            const mLat = i.lat + (Math.random() - 0.5) * 0.0006;
            const mLon = i.lon + (Math.random() - 0.5) * 0.0006;

            const m = L.circleMarker([mLat, mLon], {
                color: i.is_vip ? 'gold' : 'blue',
                fillColor: isOnline ? 'green' : (i.is_vip ? 'gold' : 'blue'),
                fillOpacity: 0.8, radius: 10, weight: 3
            }).addTo(map);

            let contacts = []; try { contacts = typeof i.contacts === 'string' ? JSON.parse(i.contacts) : i.contacts; } catch(e){}
            const contactHtml = contacts.map(c => `<div class="info-chip"><b>${c.type}:</b> ${c.val}</div>`).join('');
            const delBtn = isOwner ? `<button onclick="deleteAd(${i.id})" class="btn-del">”®—à—ñ—Ä—É</button>` : "";

            // 5. –ú–∏–Ω–∏ –∞“õ–ø–∞—Ä–∞—Ç Popup-—Ç–∞ ”ô—Ä“õ–∞—à–∞–Ω –∫”©—Ä—ñ–Ω–µ–¥—ñ
            m.bindPopup(`<b>${i.job}</b><br><small>${i.name}</small><hr>${contactHtml}${delBtn}`);
            markers.push(m);

            // 6. –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞ —Ç—ñ–∑—ñ–º—ñ
            if (bounds.contains([mLat, mLon])) {
                count++;
                listH += `
                    <div class="card ${i.is_vip?'vip':'free'}">
                        ${delBtn} <b>${i.job}</b> <small>(${i.type})</small><br>
                        <small style="color:gray">${i.name}</small> ${isOnline?'üü¢':''}<br>
                        <div style="margin-top:5px;">${contactHtml}</div>
                    </div>`;
            }
        });
        document.getElementById('item-count').innerText = count;
        document.getElementById('list-content').innerHTML = listH || "<p style='font-size:12px;color:gray;'>–ê–π–Ω–∞–ª–∞“£—ã–∑–¥–∞ —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É –∂–æ“õ.</p>";
    }

    async function submitData(isVip) {
        const n = document.getElementById('p_name').value;
        const j = document.getElementById('p_job').value;
        if (!validateInput('T', n) || !validateInput('T', j)) return alert("–ê—Ç—ã“£—ã–∑ –±–µ–Ω —Å–∏–ø–∞—Ç—Ç–∞–º–∞ –∫–µ–º—ñ–Ω–¥–µ 2 —Ç–∞“£–±–∞ –±–æ–ª—É—ã –∫–µ—Ä–µ–∫!");

        let c = [];
        let valid = true;
        document.querySelectorAll('.c-row').forEach(row => {
            const t = row.querySelector('.ct').value, v = row.querySelector('.cv').value;
            if (v) {
                if (validateInput(t, v)) c.push({type: t, val: v});
                else { valid = false; alert(`${t} “õ–∞—Ç–µ —Ñ–æ—Ä–º–∞—Ç—Ç–∞! (–¢–µ–ª: +7... 12 —Ç–∞“£–±–∞)`); }
            }
        });

        if (!valid || c.length === 0) return;

        // –ù–∞“õ—Ç—ã –æ—Ä—ã–Ω–¥—ã –∞–Ω—ã“õ—Ç–∞—É
        navigator.geolocation.getCurrentPosition(async pos => {
            await fetch(API + '/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: n, job: j, type: document.getElementById('p_type').value,
                    is_vip: isVip, lat: pos.coords.latitude, lon: pos.coords.longitude,
                    contacts: JSON.stringify(c), token: myToken
                })
            });
            if(isVip) alert("VIP —Ç”©–ª–µ–º —Ç—É—Ä–∞–ª—ã —Ç–∞–ø—Å—ã—Ä—ã—Å –∞–¥–º–∏–Ω–≥–µ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ. –¢–µ–∫—Å–µ—Ä—É–¥–µ–Ω —Å–æ“£ –∫–∞—Ä—Ç–∞“ì–∞ —à—ã“ì–∞–¥—ã.");
            fetchData();
        }, () => alert("GPS “õ–æ—Å—ã“£—ã–∑! –û–Ω—Å—ã–∑ –æ—Ä—ã–Ω “õ–∞—Ç–µ –∫”©—Ä—Å–µ—Ç—ñ–ª–µ–¥—ñ."), { enableHighAccuracy: true, maximumAge: 0 });
    }

    function deleteAd(id) { if(confirm("–ñ–æ—é–¥—ã —Ä–∞—Å—Ç–∞–π—Å—ã–∑ –±–∞?")) fetch(API+'/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,token:myToken})}).then(fetchData); }

    // 5. –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å –õ–æ–≥–∏–∫–∞—Å—ã
    function handleAdminAccess() {
        if (location.hash === "#admin777") {
            document.getElementById('adminPanel').style.display = 'block';
            let html = "";
            rawData.forEach(i => {
                let contacts = []; try { contacts = typeof i.contacts === 'string' ? JSON.parse(i.contacts) : i.contacts; } catch(e){}
                html += `<tr>
                    <td>${new Date(i.created_at).toLocaleString()}<br><small>ID: ${i.id}</small></td>
                    <td><b>${i.name}</b><br>${i.job}</td>
                    <td>${contacts.map(c => `<div><b>${c.type}:</b> ${c.val}</div>`).join('')}</td>
                    <td>${i.is_active ? '‚úÖ –†“±“õ—Å–∞—Ç –µ—Ç—ñ–ª–≥–µ–Ω' : (i.is_vip ? '‚è≥ –¢”©–ª–µ–º –∫“Ø—Ç—É–¥–µ' : '–¢–µ–≥—ñ–Ω')}</td>
                    <td>
                        <button onclick="adminToggle(${i.id}, ${!i.is_active})" style="background:var(--blue); color:white; font-size:10px; padding:5px;">“ö–æ—Å—É / ”®—à—ñ—Ä—É</button>
                        <button onclick="deleteAd(${i.id})" style="background:var(--red); color:white; font-size:10px; padding:5px; margin-top:3px;">–ñ–æ—é</button>
                    </td>
                </tr>`;
            });
            document.getElementById('admin-tbody').innerHTML = html;
        } else {
            document.getElementById('adminPanel').style.display = 'none';
        }
    }

    async function adminToggle(id, active) {
        await fetch(API + '/admin-toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id, active, pass: "admin777"})
        });
        fetchData();
    }

    window.onhashchange = handleAdminAccess;
    setInterval(() => fetch(API+'/ping',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:myToken})}), 30000);
    map.on('moveend', filterMarkers);
    fetchData();
</script>
</body>
</html>
