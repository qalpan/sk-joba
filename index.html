<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba Marketplace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 50vh; width: 100%; border-bottom: 3px solid #007bff; }
        .container { padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, select, textarea, button { width: 100%; margin: 5px 0; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        .invalid { border: 2px solid red !important; background: #fff8f8; }
        /* –ú–ê–†–ö–ï–†–î–ï–ì–Ü –¢“∞–†–ê“ö–¢–´ –ñ–ê–ó–£ */
        .leaflet-tooltip { background: white; border: 2px solid #007bff; color: black; font-weight: bold; border-radius: 4px; padding: 2px 5px; font-size: 12px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="container">
    <div class="card">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ (–ú”ô—Ç—ñ–Ω+–°–∞–Ω)">
        <input id="w_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (11-12 —Å–∞–Ω)">
        <select id="w_dur"><option value="1">1 —Å–∞“ì–∞—Ç</option><option value="24">1 —Ç”ô—É–ª—ñ–∫</option></select>
        <button onclick="saveItem('worker')">–¢—ñ—Ä–∫–µ–ª—É</button>
    </div>
    <div class="card">
        <h4>üì¶ –¢–∞—É–∞—Ä</h4>
        <input id="g_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="g_prod" placeholder="–¢–∞—É–∞—Ä (–ú”ô—Ç—ñ–Ω+–°–∞–Ω)">
        <input id="g_price" placeholder="–ë–∞“ì–∞—Å—ã (–¢–µ–∫ —Å–∞–Ω)">
        <input id="g_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (11-12 —Å–∞–Ω)">
        <select id="g_dur"><option value="24">1 —Ç”ô—É–ª—ñ–∫</option></select>
        <button onclick="saveItem('good')" style="background:#ffc107; color:black;">“ö–æ—Å—É</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
    const API = "https://sk-joba.onrender.com"; // –û—Å—ã –∂–µ—Ä–≥–µ Render-–¥–µ–≥—ñ —Å—ñ–ª—Ç–µ–º–µ–Ω—ñ “õ–æ–π—ã“£—ã–∑
    const myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markersGroup = L.markerClusterGroup();
    map.addLayer(markersGroup);

    function v(id){ return document.getElementById(id).value.trim(); }

    function saveItem(type) {
        let d = {}, path = '', phoneId = '', priceId = '';
        if(type==='worker'){ path='/save-worker'; phoneId='w_phone'; d={name:v('w_name'), job:v('w_job'), phone:v('w_phone'), durationHours:v('w_dur')}; }
        if(type==='good'){ path='/save-goods'; phoneId='g_phone'; priceId='g_price'; d={name:v('g_name'), product:v('g_prod'), price:v('g_price'), phone:v('g_phone'), durationHours:v('g_dur')}; }

        // –¢–ï–ö–°–ï–†–£: –¢–µ–ª–µ—Ñ–æ–Ω (11-12 —Å–∞–Ω)
        const pVal = d.phone.replace(/\+/g, '');
        if(pVal.length < 11 || pVal.length > 12 || isNaN(pVal)) {
            document.getElementById(phoneId).classList.add('invalid');
            return alert("–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ–Ω –¥“±—Ä—ã—Å –∂–∞–∑—ã“£—ã–∑ (11-12 —Å–∞–Ω)!");
        } else { document.getElementById(phoneId).classList.remove('invalid'); }

        // –¢–ï–ö–°–ï–†–£: –ë–∞“ì–∞ (–¢–µ–∫ —Å–∞–Ω)
        if(type==='good' && (isNaN(d.price) || d.price === "")) {
            document.getElementById(priceId).classList.add('invalid');
            return alert("–ë–∞“ì–∞“ì–∞ —Ç–µ–∫ —Å–∞–Ω –∂–∞–∑—ã“£—ã–∑!");
        } else if(priceId) { document.getElementById(priceId).classList.remove('invalid'); }

        navigator.geolocation.getCurrentPosition(p => {
            d.lat=p.coords.latitude; d.lon=p.coords.longitude; d.device_token=myToken;
            fetch(API+path, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)})
            .then(() => location.reload());
        }, () => alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è —Ä“±“õ—Å–∞—Ç –µ—Ç—ñ–ª–º–µ–≥–µ–Ω!"));
    }

    function loadMarkers() {
        fetch(API+'/get-all').then(r => r.json()).then(data => {
            markersGroup.clearLayers();
            data.workers.forEach(w => addM(w.lat, w.lon, `<b>üë∑ ${w.job}</b><br>${w.phone}`, w.job, w.id, 'worker', w.device_token, '#007bff'));
            data.goods.forEach(g => addM(g.lat, g.lon, `<b>üì¶ ${g.product_name}</b><br>${g.price}‚Ç∏`, g.price + "‚Ç∏", g.id, 'good', g.device_token, '#ffc107'));
        });
    }

    function addM(lat, lon, txt, mini, id, type, token, color) {
        const icon = L.divIcon({html: `<div style="background:${color};width:18px;height:18px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 5px #000;"></div>`, className:''});
        const m = L.marker([lat, lon], {icon});
        const del = token === myToken ? `<br><button onclick=\"delItem(${id},'${type}')\" style=\"background:red;color:white;border:none;width:100%;cursor:pointer;margin-top:5px;padding:5px;\">”®—à—ñ—Ä—É</button>` : "";
        m.bindPopup(txt + del);
        m.bindTooltip(mini, {permanent: true, direction: 'top', offset: [0, -10]});
        markersGroup.addLayer(m);
    }

    function delItem(id, type) {
        if(!confirm("”®—à—ñ—Ä—É–¥—ñ —Ä–∞—Å—Ç–∞–π—Å—ã–∑ –±–∞?")) return;
        fetch(API+'/delete-item', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, type, token: myToken})})
        .then(() => location.reload());
    }

    loadMarkers();
</script>
</body>
</html>
