<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>SK-Joba Map System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root { --primary: #007bff; }
        body { font-family: sans-serif; margin: 0; }
        #map { height: 50vh; width: 100%; transition: filter 0.5s; }
        /* –ö–∞—Ä—Ç–∞–Ω—ã“£ –∞“õ-“õ–∞—Ä–∞ —Ä–µ–∂–∏–º—ñ */
        .grayscale { filter: grayscale(100%); }
        .header-box { padding: 10px; text-align: center; background: white; }
        .card { background: white; padding: 15px; margin: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .contact-item { background: #eee; padding: 4px; margin: 2px 0; border-radius: 4px; font-size: 13px; }
        .admin-panel { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto; }
    </style>
</head>
<body>

<div class="header-box">
    <button onclick="toggleMapMode()">üåì –ö–∞—Ä—Ç–∞ —Ç“Ø—Å—ñ–Ω ”©–∑–≥–µ—Ä—Ç—É (–ê“õ-“õ–∞—Ä–∞/–¢“Ø—Å—Ç—ñ)</button>
    <input type="text" id="searchInput" placeholder="–Ü–∑–¥–µ—É..." oninput="filterMarkers()" style="width:80%; padding:10px; margin-top:10px; border-radius:20px;">
</div>

<div id="map"></div>

<div id="visible-list-container">
    <div style="padding:10px; font-weight:bold; background:#f0f0f0;">üìç –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞: (<span id="item-count">0</span>)</div>
    <div id="dynamic-list-content"></div>
</div>

<div class="card">
    <h4>üì¢ –•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É –∂–∞—Ä–∏—è–ª–∞—É</h4>
    <input id="p_name" placeholder="–ê—Ç—ã“£—ã–∑ (–º–∏–Ω. 2 —Ç–∞“£–±–∞)">
    <input id="p_job" placeholder="“ö—ã–∑–º–µ—Ç/–¢–∞—É–∞—Ä –∞—Ç—ã (–º–∏–Ω. 2 —Ç–∞“£–±–∞)">
    <div id="contacts_list">
        <div class="contact-row" style="display:flex; gap:5px; margin-top:5px;">
            <select class="c-type"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option></select>
            <input class="c-val" placeholder="–î–µ—Ä–µ–∫">
        </div>
    </div>
    <button onclick="addContactRow()">+ –ë–∞–π–ª–∞–Ω—ã—Å “õ–æ—Å—É</button>
    <br><br>
    <button onclick="processPost(false)" style="background:green; color:white; padding:10px; width:48%;">–¢–µ–≥—ñ–Ω (–õ–µ–∑–¥–µ)</button>
    <button onclick="processPost(true)" style="background:blue; color:white; padding:10px; width:48%;">VIP (–¢”©–ª–µ–º–º–µ–Ω)</button>
</div>

<div id="adminPanel" class="admin-panel">
    <h3>üõ° –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å (–¢–æ–ª—ã“õ –∞“õ–ø–∞—Ä–∞—Ç)</h3>
    <button onclick="closeAdmin()">–ñ–∞–±—É</button>
    <div id="admin-data"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
    const API = "https://sk-joba.onrender.com";
    let myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);
    
    let map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let markers = [];
    let rawData = [];

    // 1. –í–ê–õ–ò–î–ê–¶–ò–Ø (“ö–ê–¢–ê“¢ –¢–ï–ö–°–ï–†–£)
    function validateData(type, val) {
        if (type === '–¢–µ–ª') return /^\+7\d{10}$/.test(val); // +77071234567 (12 —Ç–∞“£–±–∞)
        if (type === 'Email') return val.includes('@') && val.includes('.') && val.length > 5;
        return val.length >= 2; // –ú”ô—Ç—ñ–Ω –Ω–µ —Å–∞–Ω 2-–¥–µ–Ω –∫–µ–º –µ–º–µ—Å
    }

    function toggleMapMode() {
        document.getElementById('map').classList.toggle('grayscale');
    }

    function addContactRow() {
        let div = document.createElement('div');
        div.className = 'contact-row';
        div.style = "display:flex; gap:5px; margin-top:5px;";
        div.innerHTML = `<select class="c-type"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option></select><input class="c-val" placeholder="–î–µ—Ä–µ–∫">`;
        document.getElementById('contacts_list').appendChild(div);
    }

    // 2. –ñ–ê–†–ò–Ø–õ–ê–£ –õ–û–ì–ò–ö–ê–°–´
    function processPost(isVip) {
        const name = document.getElementById('p_name').value;
        const job = document.getElementById('p_job').value;
        
        if (!validateData('Text', name) || !validateData('Text', job)) {
            alert("–ê—Ç—ã“£—ã–∑ –±–µ–Ω “õ—ã–∑–º–µ—Ç –∞—Ç—ã 2 —Ç–∞“£–±–∞–¥–∞–Ω –∫–µ–º –±–æ–ª–º–∞—É—ã –∫–µ—Ä–µ–∫!");
            return;
        }

        let contacts = [];
        document.querySelectorAll('.contact-row').forEach(row => {
            let t = row.querySelector('.c-type').value;
            let v = row.querySelector('.c-val').value;
            if (validateData(t, v)) contacts.push({type: t, val: v});
        });

        if (contacts.length === 0) {
            alert("–ë–∞–π–ª–∞–Ω—ã—Å –¥–µ—Ä–µ–≥—ñ “õ–∞—Ç–µ –Ω–µ–º–µ—Å–µ –±–æ—Å! (–¢–µ–ª: +77071234567)");
            return;
        }

        if (isVip) {
            alert("VIP –¢”©–ª–µ–º: 1000 ‚Ç∏. –¢”©–ª–µ–≥–µ–Ω —Å–æ“£ –∞–¥–º–∏–Ω –º–∞“õ“±–ª–¥–∞–π–¥—ã.");
        }

        navigator.geolocation.getCurrentPosition(pos => {
            const body = {
                name, job, is_vip: isVip,
                lat: pos.coords.latitude, lon: pos.coords.longitude,
                contacts: JSON.stringify(contacts),
                token: myToken
            };

            fetch(API + '/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            }).then(() => {
                alert("–ñ—ñ–±–µ—Ä—ñ–ª–¥—ñ!");
                loadData();
            });
        });
    }

    // 3. –ú”ò–õ–Ü–ú–ï–¢–¢–ï–†–î–Ü –ö”®–†–°–ï–¢–£ (24 –°–ê“í–ê–¢ –¢–ï–ö–°–ï–†–Ü–°–Ü)
function loadData() {
    fetch(API + '/get-all')
        .then(r => r.json())
        .then(data => {
            // –ï–≥–µ—Ä —Å–µ—Ä–≤–µ—Ä –æ–±—ä–µ–∫—Ç –∂—ñ–±–µ—Ä—Å–µ, –æ–Ω—ã –º–∞—Å—Å–∏–≤–∫–µ –∞–π–Ω–∞–ª–¥—ã—Ä—É –Ω–µ–º–µ—Å–µ –±–æ—Å –º–∞—Å—Å–∏–≤ “õ—ã–ª—É
            rawData = Array.isArray(data) ? data : (data.workers || []); 
            filterMarkers();
        })
        .catch(err => console.error("–î–µ—Ä–µ–∫ –∂“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ:", err));
}

function filterMarkers() {
    // 1. rawData-–Ω—ã“£ –º–∞—Å—Å–∏–≤ –µ–∫–µ–Ω—ñ–Ω —Ç–µ–∫—Å–µ—Ä—É (“ö–∞—Ç–µ–¥–µ–Ω “õ–æ—Ä“ì–∞—É)
    let dataToProcess = [];
    if (Array.isArray(rawData)) {
        dataToProcess = rawData;
    } else if (rawData && typeof rawData === 'object') {
        // –ï–≥–µ—Ä –¥–µ—Ä–µ–∫—Ç–µ—Ä –Ω—ã—Å–∞–Ω –±–æ–ª—Å–∞ (workers, goods, orders), –±”ô—Ä—ñ–Ω –±—ñ—Ä –º–∞—Å—Å–∏–≤–∫–µ –∂–∏–Ω–∞—É
        dataToProcess = [
            ...(rawData.workers || []),
            ...(rawData.goods || []),
            ...(rawData.orders || [])
        ];
    }

    // –ö–∞—Ä—Ç–∞–Ω—ã —Ç–∞–∑–∞–ª–∞—É
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    let listHtml = "";
    let count = 0;
    const now = Date.now();
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    dataToProcess.forEach(item => {
        // 2. –£–ê“ö–´–¢–¢–´ –¢–ï–ö–°–ï–†–£ (24 —Å–∞“ì–∞—Ç)
        const createdTime = new Date(item.created_at).getTime();
        const hoursPassed = (now - createdTime) / (1000 * 60 * 60);
        if (hoursPassed > 24) return;

        // 3. –û–ù–õ–ê–ô–ù –°–¢–ê–¢–£–° –ü–ï–ù VIP –¢–ï–ö–°–ï–†–£
        const isOnline = (now - (item.last_ping || 0)) < 300000; // 5 –º–∏–Ω
        
        // –¢–µ–≥—ñ–Ω —Ö–∞–±–∞—Ä–ª–∞–º–∞ —Ç–µ–∫ –∏–µ—Å—ñ –æ–Ω–ª–∞–π–Ω –±–æ–ª—Å–∞ –∫”©—Ä—ñ–Ω–µ–¥—ñ
        if (!item.is_active && !item.is_vip) {
             if (!isOnline) return;
        }
        // VIP —Ç–µ–∫ –∞–¥–º–∏–Ω –º–∞“õ“±–ª–¥–∞—Å–∞ –∫”©—Ä—ñ–Ω–µ–¥—ñ
        if (item.is_vip && !item.is_active) return;

        // 4. –Ü–ó–î–ï–£ (SEARCH) - –ê—Ç—ã –Ω–µ–º–µ—Å–µ “õ—ã–∑–º–µ—Ç—ñ –±–æ–π—ã–Ω—à–∞
        const itemName = (item.name || item.seller_name || item.client_name || "").toLowerCase();
        const itemJob = (item.job || item.product_name || item.description || "").toLowerCase();
        if (!itemName.includes(searchTerm) && !itemJob.includes(searchTerm)) return;

        // 5. –ë–ê–ô–õ–ê–ù–´–° –ê“ö–ü–ê–†–ê–¢–¢–ê–†–´–ù –î–ê–ô–´–ù–î–ê–£ (”ò—Ä“õ–∞—à–∞–Ω –±–∞—Ä–ª—ã“õ –∂–µ—Ä–¥–µ —à—ã“ì—É—ã “Ø—à—ñ–Ω)
        let contactsHtml = "";
        try {
            const contacts = typeof item.contacts === 'string' ? JSON.parse(item.contacts) : item.contacts;
            if (Array.isArray(contacts)) {
                contactsHtml = contacts.map(c => `
                    <div class="contact-item">
                        <span style="color:#777; font-size:11px;">${c.type}:</span> 
                        <b style="font-size:13px;">${c.val}</b>
                    </div>
                `).join('');
            }
        } catch(e) { contactsHtml = "–î–µ—Ä–µ–∫ “õ–∞—Ç–µ"; }

        // 6. –ú–ê–†–ö–ï–†–î–Ü –ö–ê–†–¢–ê“í–ê –®–´“í–ê–†–£
        const marker = L.circleMarker([item.lat, item.lon], {
            color: item.is_vip ? 'gold' : 'blue',
            weight: 3,
            fillColor: isOnline ? '#00ff00' : (item.is_vip ? 'gold' : 'blue'),
            fillOpacity: 0.7,
            radius: 10
        }).addTo(map);

        const popupContent = `
            <div style="min-width:150px;">
                <b style="font-size:16px;">${item.job || item.product_name || "“ö—ã–∑–º–µ—Ç"}</b><br>
                <span style="color:gray;">${item.name || "–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã"}</span>
                <hr style="margin:5px 0;">
                ${contactsHtml}
                <div style="font-size:10px; color:#aaa; margin-top:5px;">–ñ–∞—Ä–∏—è–ª–∞–Ω–¥—ã: ${new Date(item.created_at).toLocaleString()}</div>
            </div>
        `;
        marker.bindPopup(popupContent);
        markers.push(marker);

        // 7. –ñ–ê“ö–´–ù –ú–ê“¢–î–ê –¢–Ü–ó–Ü–ú–Ü–ù–ï “ö–û–°–£
        if (map.getBounds().contains([item.lat, item.lon])) {
            count++;
            listHtml += `
                <div class="card" style="border-left: 5px solid ${item.is_vip ? 'gold' : 'blue'}; margin-bottom:10px; padding:10px; background:#fff;">
                    <div style="display:flex; justify-content:space-between;">
                        <b>${item.job || item.product_name}</b>
                        ${isOnline ? '<span style="color:green; font-size:10px;">‚óè –æ–Ω–ª–∞–π–Ω</span>' : ''}
                    </div>
                    <div style="font-size:13px; color:#555;">${item.name}</div>
                    <div style="margin-top:5px;">${contactsHtml}</div>
                </div>
            `;
        }
    });

    document.getElementById('item-count').innerText = count;
    document.getElementById('dynamic-list-content').innerHTML = listHtml || "<div style='padding:10px;'>–ë“±–ª –º–∞“£–¥–∞ –µ—à—Ç–µ“£–µ —Ç–∞–±—ã–ª“ì–∞–Ω –∂–æ“õ</div>";
}

    // –ê–¥–º–∏–Ω —Ç–µ–∫—Å–µ—Ä—É
    function checkAdmin() {
        let p = prompt("“ö“±–ø–∏—è —Å”©–∑:");
        if (p === "admin777") {
            document.getElementById('adminPanel').style.display = 'block';
            renderAdminData();
        }
    }

    function renderAdminData() {
        let h = "";
        rawData.forEach(i => {
            h += `<div class="card">
                <b>${i.job}</b> (ID: ${i.id})<br>
                –£–∞“õ—ã—Ç—ã: ${new Date(i.created_at).toLocaleString()}<br>
                –î–µ—Ä–µ–∫—Ç–µ—Ä: ${i.contacts}<br>
                –°—Ç–∞—Ç—É—Å: ${i.is_active ? '–ê–∫—Ç–∏–≤' : '–ö“Ø—Ç—É–¥–µ'}<br>
                <button onclick="toggleItem(${i.id}, true)">“ö–æ—Å—É/VIP –ú–∞“õ“±–ª–¥–∞—É</button>
                <button onclick="deleteItem(${i.id})" style="color:red">–ñ–æ—é</button>
            </div>`;
        });
        document.getElementById('admin-data').innerHTML = h;
    }

    setInterval(() => {
        fetch(API + '/ping', { method: 'POST', body: JSON.stringify({token: myToken}), headers: {'Content-Type': 'application/json'} });
    }, 30000);

    loadData();
</script>
</body>
</html>
