<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba | Live</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 45vh; width: 100%; background: #ddd; }
        .search-box { padding: 10px; background: white; text-align: center; }
        .search-box input { width: 90%; padding: 12px; border-radius: 25px; border: 2px solid #007bff; outline: none; }
        .container { padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, select, textarea, button { width: 100%; margin: 5px 0; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        
        /* –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å –°—Ç–∏–ª—ñ */
        #admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto; }
        .admin-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .admin-tabs button { flex: 1; background: #6c757d; font-size: 11px; padding: 10px 5px; }
        .admin-tabs button.active { background: #007bff; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f4f4f4; }
        .status-badge { padding: 2px 5px; border-radius: 3px; font-size: 10px; color: white; }
    </style>
</head>
<body>

<div class="search-box">
    <input type="text" id="searchInput" placeholder="–Ü–∑–¥–µ—É..." oninput="filterMarkers()">
</div>

<div id="map"></div>

<div id="admin-modal">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3>–ë–∞—Å“õ–∞—Ä—É –ø–∞–Ω–µ–ª—ñ</h3>
        <button onclick="window.location.hash=''" style="background:red; width:70px;">–ñ–∞–±—É</button>
    </div>
    
    <div class="admin-tabs">
        <button id="tab-pending" onclick="renderAdmin('pending')" class="active">‚è≥ –ö–µ–∑–µ–∫—Ç–µ</button>
        <button id="tab-active" onclick="renderAdmin('active')">‚úÖ –ë–µ–ª—Å–µ–Ω–¥—ñ</button>
        <button id="tab-all" onclick="renderAdmin('all')">üìä –ë–∞—Ä–ª—ã“ì—ã</button>
    </div>
    
    <div id="admin-content">
        </div>
</div>

<div class="container">
    <div class="card">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ">
        <input id="w_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <select id="w_dur"><option value="1">1 —Å–∞“ì–∞—Ç</option><option value="24">1 —Ç”ô—É–ª—ñ–∫</option></select>
        <button onclick="saveItem('worker')">–¢—ñ—Ä–∫–µ—É</button>
    </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
    const API = "https://sk-joba.onrender.com";
    const myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let markers = L.layerGroup().addTo(map);

    let rawData = []; // –°–µ—Ä–≤–µ—Ä–¥–µ–Ω –∫–µ–ª–≥–µ–Ω —Ç–∞–∑–∞ –¥–µ—Ä–µ–∫—Ç–µ—Ä

    // 1. –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∂“Ø–∫—Ç–µ—É
    function loadData() {
        fetch(API + '/get-all')
            .then(r => r.json())
            .then(data => {
                // –°–µ—Ä–≤–µ—Ä–¥–µ–Ω –∫–µ–ª–≥–µ–Ω “Ø—à —Ç—ñ–∑—ñ–º–¥—ñ –±—ñ—Ä –º–∞—Å—Å–∏–≤–∫–µ –∂–∏–Ω–∞–π–º—ã–∑
                rawData = [
                    ...data.workers.map(i => ({...i, type: 'worker', info: i.job})),
                    ...data.goods.map(i => ({...i, type: 'good', info: i.product_name})),
                    ...data.orders.map(i => ({...i, type: 'order', info: i.description}))
                ];
                renderMarkers(rawData);
                if(document.getElementById('admin-modal').style.display === 'block') {
                    renderAdmin('pending'); 
                }
            });
    }

    // 2. –ö–∞—Ä—Ç–∞“ì–∞ –º–∞—Ä–∫–µ—Ä–ª–µ—Ä–¥—ñ —à—ã“ì–∞—Ä—É (—Ç–µ–∫ –±–µ–ª—Å–µ–Ω–¥—ñ–ª–µ—Ä—ñ–Ω)
    function renderMarkers(data) {
        markers.clearLayers();
        data.forEach(i => {
            // –ï–≥–µ—Ä –∞–∫—Ç–∏–≤—Ç—ñ –±–æ–ª—Å–∞ –Ω–µ–º–µ—Å–µ —Ç–∞–ø—Å—ã—Ä—ã—Å (—Ç–µ–≥—ñ–Ω) –±–æ–ª—Å–∞ –∫–∞—Ä—Ç–∞“ì–∞ —à—ã“ì–∞—Ä—É
            if (i.is_active || i.type === 'order') {
                const color = i.type === 'worker' ? 'blue' : (i.type === 'good' ? 'orange' : 'green');
                const m = L.circleMarker([i.lat, i.lon], {radius: 8, color: color, fillOpacity: 0.8});
                m.bindPopup(`${i.info}<br>${i.phone}`);
                m.addTo(markers);
            }
        });
    }

    // 3. –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨–î–Ü –°“Æ–ó–ì–Ü–õ–ï–£ –ñ”ò–ù–ï –ö”®–†–°–ï–¢–£
    function renderAdmin(filter) {
        // –ë–∞—Ç—ã—Ä–º–∞–ª–∞—Ä–¥—ã“£ —Ç“Ø—Å—ñ–Ω –∞—É—ã—Å—Ç—ã—Ä—É
        document.querySelectorAll('.admin-tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + filter).classList.add('active');

        let filtered = [];
        if (filter === 'pending') filtered = rawData.filter(i => !i.is_active && i.type !== 'order');
        else if (filter === 'active') filtered = rawData.filter(i => i.is_active || i.type === 'order');
        else filtered = rawData;

        let html = `<table><tr><th>–¢“Ø—Ä—ñ</th><th>–ê“õ–ø–∞—Ä–∞—Ç</th><th>”ò—Ä–µ–∫–µ—Ç</th></tr>`;
        
        filtered.forEach(i => {
            const statusColor = i.is_active ? 'green' : 'orange';
            const actionBtn = (!i.is_active && i.type !== 'order') 
                ? `<button onclick="activateItem(${i.id}, '${i.type}')" style="background:green; padding:5px;">‚úÖ “ö–æ—Å—É</button>` 
                : `<span class="status-badge" style="background:green">–ë–µ–ª—Å–µ–Ω–¥—ñ</span>`;

            html += `<tr>
                <td><small>${i.type}</small></td>
                <td>${i.info}<br><small>${i.phone}</small></td>
                <td>${actionBtn}</td>
            </tr>`;
        });

        document.getElementById('admin-content').innerHTML = filtered.length ? html + "</table>" : "<p>–¢—ñ–∑—ñ–º –±–æ—Å</p>";
    }

    // 4. –ê–∫—Ç–∏–≤—Ç–µ–Ω–¥—ñ—Ä—É (–ê–¥–º–∏–Ω “Ø—à—ñ–Ω)
    function activateItem(id, type) {
        fetch(API + '/admin/activate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id, type})
        }).then(() => {
            alert("“ö–æ—Å—ã–ª–¥—ã!");
            loadData(); // –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ “õ–∞–π—Ç–∞ –∂“Ø–∫—Ç–µ–ø, –∫–µ—Å—Ç–µ–Ω—ñ –∂–∞“£–∞—Ä—Ç—É
        });
    }

    // –ê–¥–º–∏–Ω–≥–µ –∫—ñ—Ä—É
    window.onhashchange = () => {
        if(location.hash === "#admin777") {
            const p = prompt("–ü–∞—Ä–æ–ª—å:");
            if(p === "admin777") {
                document.getElementById('admin-modal').style.display='block';
                loadData();
            }
        } else {
            document.getElementById('admin-modal').style.display='none';
        }
    };

    loadData();
</script>
</body>
</html>
