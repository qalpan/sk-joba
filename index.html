<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root { --blue: #007bff; --gold: #ffd700; --red: #dc3545; --green: #28a745; }
        body, html { margin: 0; padding: 0; font-family: sans-serif; background: #f4f4f4; }
        
        /* –ö–ê–†–¢–ê –ö”®–†–Ü–ù–£–Ü “Æ–®–Ü–ù –ú–ê“¢–´–ó–î–´: –ë–∏—ñ–∫—Ç—ñ–∫ –±–µ–∫—ñ—Ç—ñ–ª—É—ñ –∫–µ—Ä–µ–∫ */
        #map { height: 50vh; width: 100%; background: #ddd; position: relative; }
        .grayscale { filter: grayscale(100%); }
        
        .header { padding: 10px; background: white; text-align: center; border-bottom: 2px solid var(--blue); }
        .card { background: white; padding: 10px; margin: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .contact-box { background: #f8f9fa; padding: 5px; margin: 2px 0; border-radius: 4px; border-left: 3px solid var(--blue); font-size: 13px; }
        .btn-del { background: var(--red); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; float: right; }
        .list-area { height: 25vh; overflow-y: auto; background: white; }
        input, select, button { padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; width: 95%; }
    </style>
</head>
<body>

<div class="header">
    <button onclick="toggleColor()" style="width:auto; background:#333; color:white;">üåì –¢“Ø—Å—Ç—ñ / –ê“õ-“õ–∞—Ä–∞ –∫–∞—Ä—Ç–∞</button>
    <input type="text" id="searchInput" placeholder="üîç –Ü–∑–¥–µ—É (–ú–∞–º–∞–Ω–¥—ã“õ, —Ç–∞—É–∞—Ä, —Å–∞–Ω–∞—Ç...)" oninput="filterMarkers()">
    <select id="catFilter" onchange="filterMarkers()"><option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option></select>
</div>

<div id="map"></div>

<div class="list-area">
    <div style="padding:10px; font-weight:bold; background:#eee;">üìç –ê—É–º–∞“õ—Ç–∞“ì—ã —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–ª–∞—Ä: (<span id="item-count">0</span>)</div>
    <div id="list-content"></div>
</div>

<div class="card">
    <h4>üì¢ –ñ–∞“£–∞ —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É</h4>
    <select id="p_type">
        <option value="“ö—ã–∑–º–µ—Ç">üë∑ “ö—ã–∑–º–µ—Ç (–ú–∞–º–∞–Ω–¥—ã“õ)</option>
        <option value="–¢–∞—É–∞—Ä">üì¶ –¢–∞—É–∞—Ä (–°–∏–ø–∞—Ç—Ç–∞–º–∞)</option>
        <option value="–¢–∞–ø—Å—ã—Ä—ã—Å">üõí –¢–∞–ø—Å—ã—Ä—ã—Å (–ë”©–ª—ñ–º)</option>
    </select>
    <input id="p_name" placeholder="–ê—Ç—ã“£—ã–∑ (–º–∏–Ω. 2 —Ç–∞“£–±–∞)">
    <input id="p_job" placeholder="–ù–µ–≥—ñ–∑–≥—ñ –∞“õ–ø–∞—Ä–∞—Ç (–º–∞–º–∞–Ω–¥—ã“õ/—Ç–∞—É–∞—Ä)">
    
    <div id="contacts_input">
        <div class="c-row" style="display:flex; gap:5px; margin-bottom:5px;">
            <select class="ct" style="width:30%"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option></select>
            <input class="cv" style="width:70%" placeholder="–î–µ—Ä–µ–∫">
        </div>
    </div>
    <button onclick="addContact()" style="width:auto; font-size:12px;">+ –ë–∞–π–ª–∞–Ω—ã—Å “õ–æ—Å—É</button>
    
    <div style="display:flex; gap:10px; margin-top:10px;">
        <button onclick="publish(false)" style="background:var(--green); color:white; flex:1; border:none;">–¢–µ–≥—ñ–Ω (–õ–µ–∑–¥–µ)</button>
        <button onclick="publish(true)" style="background:var(--blue); color:white; flex:1; border:none;">üíé VIP (–¢”©–ª–µ–º–º–µ–Ω)</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<script>
    const API = "https://sk-joba.onrender.com";
    let myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    // –ö–ê–†–¢–ê –Ü–°–ö–ï “ö–û–°–£
    let map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let markers = [];
    let rawData = [];
    const isAdmin = location.hash === "#admin777";

    // 1. –í–ê–õ–ò–î–ê–¶–ò–Ø (12 —Ç–∞“£–±–∞ —Ç–µ–ª, @ email, 2 —Ç–∞“£–±–∞ –º”ô—Ç—ñ–Ω)
    function validate(t, v) {
        if (t === '–¢–µ–ª') return /^\+7\d{10}$/.test(v.replace(/\s+/g, ''));
        if (t === 'Email') return v.includes('@') && v.includes('.');
        return v.trim().length >= 2;
    }

    function toggleColor() { document.getElementById('map').classList.toggle('grayscale'); }
    function addContact() {
        const div = document.createElement('div');
        div.className = 'c-row'; div.style = "display:flex; gap:5px; margin-top:5px;";
        div.innerHTML = `<select class="ct" style="width:30%"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option></select><input class="cv" style="width:70%" placeholder="–î–µ—Ä–µ–∫">`;
        document.getElementById('contacts_input').appendChild(div);
    }

    // 2. –î–ï–†–ï–ö–¢–ï–†–î–Ü –ñ“Æ–ö–¢–ï–£ (24 —Å–∞“ì–∞—Ç—Ç—ã“õ —Ç–µ–∫—Å–µ—Ä—ñ—Å–ø–µ–Ω)
    function loadData() {
        fetch(API + '/get-all').then(r => r.json()).then(data => {
            rawData = Array.isArray(data) ? data : [];
            updateCats();
            filterMarkers();
        }).catch(err => console.error("–î–µ—Ä–µ–∫ –∞–ª—É “õ–∞—Ç–µ—Å—ñ:", err));
    }

    function updateCats() {
        const sel = document.getElementById('catFilter');
        const unique = [...new Set(rawData.map(i => i.job))];
        sel.innerHTML = '<option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option>';
        unique.forEach(c => { if(c) sel.innerHTML += `<option value="${c}">${c}</option>`; });
    }

    // 3. –§–ò–õ–¨–¢–† –ñ”ò–ù–ï –ö–ê–†–¢–ê–î–ê –ö”®–†–°–ï–¢–£ (–ê–π–º–∞“õ –±–æ–π—ã–Ω—à–∞ ‚Ññ6)
    function filterMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        let listHtml = "", count = 0, now = Date.now();
        const search = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('catFilter').value;
        const bounds = map.getBounds();

        rawData.forEach(i => {
            // 24 —Å–∞“ì–∞—Ç—Ç—ã“õ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã ”©—à—ñ—Ä—É
            if ((now - new Date(i.created_at).getTime()) / 3600000 > 24) return;

            const isOnline = (now - (i.last_ping || 0)) < 300000;
            const isOwner = i.token === myToken;

            // –ö”©—Ä—ñ–Ω—É —à–∞—Ä—Ç—ã (‚Ññ3 –∂”ô–Ω–µ ‚Ññ4)
            if (!i.is_active && !i.is_vip && !isOnline) return; // –¢–µ–≥—ñ–Ω: —Ç–µ–∫ –∏–µ—Å—ñ –æ–Ω–ª–∞–π–Ω –±–æ–ª—Å–∞
            if (i.is_vip && !i.is_active && !isAdmin && !isOwner) return; // VIP: —Ç–µ–∫ –º–∞“õ“±–ª–¥–∞–Ω—Å–∞

            // –Ü–∑–¥–µ—É (‚Ññ7)
            if (cat && i.job !== cat) return;
            if (search && !i.job.toLowerCase().includes(search) && !i.name.toLowerCase().includes(search)) return;

            const marker = L.circleMarker([i.lat, i.lon], {
                color: i.is_vip ? 'gold' : 'blue',
                radius: 10, fillOpacity: 0.8
            }).addTo(map);
            
            let cHtml = "";
            try {
                const cArr = typeof i.contacts === 'string' ? JSON.parse(i.contacts) : i.contacts;
                cHtml = cArr.map(c => `<div class="contact-box"><b>${c.type}:</b> ${c.val}</div>`).join('');
            } catch(e) { cHtml = "–î–µ—Ä–µ–∫ “õ–∞—Ç–µ"; }

            const delBtn = isOwner ? `<button class="btn-del" onclick="removeAd(${i.id})">”®—à—ñ—Ä—É</button>` : "";
            marker.bindPopup(`<b>${i.job}</b><br><small>${i.name}</small> ${isOnline ? '<span style="color:green;font-size:10px;">‚óè –æ–Ω–ª–∞–π–Ω</span>' : ''}<hr>${cHtml}${delBtn}`);
            markers.push(marker);

            // –¢–µ–∫ –∫–∞—Ä—Ç–∞ –∞—É–º–∞“ì—ã–Ω–¥–∞“ì—ã–ª–∞—Ä–¥—ã —Ç—ñ–∑—ñ–º–≥–µ —à—ã“ì–∞—Ä—É (‚Ññ6)
            if (bounds.contains([i.lat, i.lon])) {
                count++;
                listHtml += `<div class="card" style="border-left: 5px solid ${i.is_vip ? 'gold' : 'blue'}">
                    <b>${i.job}</b> <small>(${i.type})</small><br>${cHtml}${delBtn}
                </div>`;
            }
        });
        document.getElementById('item-count').innerText = count;
        document.getElementById('list-content').innerHTML = listHtml;
    }

    // 4. –ñ–ê–†–ò–Ø–õ–ê–£ (GPS –ü–ï–ù –í–ê–õ–ò–î–ê–¶–ò–Ø ‚Ññ1)
    function publish(isVip) {
        const n = document.getElementById('p_name').value;
        const j = document.getElementById('p_job').value;
        const t = document.getElementById('p_type').value;

        let contacts = [];
        document.querySelectorAll('.c-row').forEach(r => {
            const ct = r.querySelector('.ct').value, cv = r.querySelector('.cv').value;
            if (validate(ct, cv)) contacts.push({type: ct, val: cv});
        });

        if (!validate('M', n) || !validate('M', j) || contacts.length === 0) {
            return alert("–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –¥“±—Ä—ã—Å —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑! –¢–µ–ª: +7... 12 —Ç–∞“£–±–∞.");
        }

        if (isVip) alert("VIP –¢”©–ª–µ–º: 1000 ‚Ç∏. –¢”©–ª–µ–º–Ω–µ–Ω –∫–µ–π—ñ–Ω –∞–¥–º–∏–Ω –º–∞“õ“±–ª–¥–∞–π–¥—ã.");

        navigator.geolocation.getCurrentPosition(pos => {
            fetch(API + '/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: n, job: j, type: t, is_vip: isVip,
                    lat: pos.coords.latitude, lon: pos.coords.longitude,
                    contacts: JSON.stringify(contacts), token: myToken
                })
            }).then(() => { alert("–ñ—ñ–±–µ—Ä—ñ–ª–¥—ñ!"); loadData(); });
        }, () => alert("GPS “õ–æ—Å—ã“£—ã–∑!"));
    }

    function removeAd(id) {
        if(confirm("”®—à—ñ—Ä—É–¥—ñ —Ä–∞—Å—Ç–∞–π—Å—ã–∑ –±–∞?")) {
            fetch(API + '/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id, token: myToken})
            }).then(loadData);
        }
    }

    setInterval(() => {
        fetch(API + '/ping', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({token: myToken}) });
    }, 30000);

    map.on('moveend', filterMarkers);
    loadData();
</script>
</body>
</html>
