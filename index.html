<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>SK-Joba Map System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root { --primary: #007bff; }
        body { font-family: sans-serif; margin: 0; }
        #map { height: 50vh; width: 100%; transition: filter 0.5s; }
        /* –ö–∞—Ä—Ç–∞–Ω—ã“£ –∞“õ-“õ–∞—Ä–∞ —Ä–µ–∂–∏–º—ñ */
        .grayscale { filter: grayscale(100%); }
        .header-box { padding: 10px; text-align: center; background: white; }
        .card { background: white; padding: 15px; margin: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .contact-item { background: #eee; padding: 4px; margin: 2px 0; border-radius: 4px; font-size: 13px; }
        .admin-panel { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto; }
    </style>
</head>
<body>

<div class="header-box">
    <button onclick="toggleMapMode()">üåì –ö–∞—Ä—Ç–∞ —Ç“Ø—Å—ñ–Ω ”©–∑–≥–µ—Ä—Ç—É (–ê“õ-“õ–∞—Ä–∞/–¢“Ø—Å—Ç—ñ)</button>
    <input type="text" id="searchInput" placeholder="–Ü–∑–¥–µ—É..." oninput="filterMarkers()" style="width:80%; padding:10px; margin-top:10px; border-radius:20px;">
</div>

<div id="map"></div>

<div id="visible-list-container">
    <div style="padding:10px; font-weight:bold; background:#f0f0f0;">üìç –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞: (<span id="item-count">0</span>)</div>
    <div id="dynamic-list-content"></div>
</div>

<div class="card">
    <h4>üì¢ –•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É –∂–∞—Ä–∏—è–ª–∞—É</h4>
    <input id="p_name" placeholder="–ê—Ç—ã“£—ã–∑ (–º–∏–Ω. 2 —Ç–∞“£–±–∞)">
    <input id="p_job" placeholder="“ö—ã–∑–º–µ—Ç/–¢–∞—É–∞—Ä –∞—Ç—ã (–º–∏–Ω. 2 —Ç–∞“£–±–∞)">
    <div id="contacts_list">
        <div class="contact-row" style="display:flex; gap:5px; margin-top:5px;">
            <select class="c-type"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option></select>
            <input class="c-val" placeholder="–î–µ—Ä–µ–∫">
        </div>
    </div>
    <button onclick="addContactRow()">+ –ë–∞–π–ª–∞–Ω—ã—Å “õ–æ—Å—É</button>
    <br><br>
    <button onclick="processPost(false)" style="background:green; color:white; padding:10px; width:48%;">–¢–µ–≥—ñ–Ω (–õ–µ–∑–¥–µ)</button>
    <button onclick="processPost(true)" style="background:blue; color:white; padding:10px; width:48%;">VIP (–¢”©–ª–µ–º–º–µ–Ω)</button>
</div>

<div id="adminPanel" class="admin-panel">
    <h3>üõ° –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å (–¢–æ–ª—ã“õ –∞“õ–ø–∞—Ä–∞—Ç)</h3>
    <button onclick="closeAdmin()">–ñ–∞–±—É</button>
    <div id="admin-data"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
    const API = "https://sk-joba.onrender.com";
    let myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);
    
    let map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let markers = [];
    let rawData = [];

    // 1. –í–ê–õ–ò–î–ê–¶–ò–Ø (“ö–ê–¢–ê“¢ –¢–ï–ö–°–ï–†–£)
    function validateData(type, val) {
        if (type === '–¢–µ–ª') return /^\+7\d{10}$/.test(val); // +77071234567 (12 —Ç–∞“£–±–∞)
        if (type === 'Email') return val.includes('@') && val.includes('.') && val.length > 5;
        return val.length >= 2; // –ú”ô—Ç—ñ–Ω –Ω–µ —Å–∞–Ω 2-–¥–µ–Ω –∫–µ–º –µ–º–µ—Å
    }

    function toggleMapMode() {
        document.getElementById('map').classList.toggle('grayscale');
    }

    function addContactRow() {
        let div = document.createElement('div');
        div.className = 'contact-row';
        div.style = "display:flex; gap:5px; margin-top:5px;";
        div.innerHTML = `<select class="c-type"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option></select><input class="c-val" placeholder="–î–µ—Ä–µ–∫">`;
        document.getElementById('contacts_list').appendChild(div);
    }

    // 2. –ñ–ê–†–ò–Ø–õ–ê–£ –õ–û–ì–ò–ö–ê–°–´
    function processPost(isVip) {
        const name = document.getElementById('p_name').value;
        const job = document.getElementById('p_job').value;
        
        if (!validateData('Text', name) || !validateData('Text', job)) {
            alert("–ê—Ç—ã“£—ã–∑ –±–µ–Ω “õ—ã–∑–º–µ—Ç –∞—Ç—ã 2 —Ç–∞“£–±–∞–¥–∞–Ω –∫–µ–º –±–æ–ª–º–∞—É—ã –∫–µ—Ä–µ–∫!");
            return;
        }

        let contacts = [];
        document.querySelectorAll('.contact-row').forEach(row => {
            let t = row.querySelector('.c-type').value;
            let v = row.querySelector('.c-val').value;
            if (validateData(t, v)) contacts.push({type: t, val: v});
        });

        if (contacts.length === 0) {
            alert("–ë–∞–π–ª–∞–Ω—ã—Å –¥–µ—Ä–µ–≥—ñ “õ–∞—Ç–µ –Ω–µ–º–µ—Å–µ –±–æ—Å! (–¢–µ–ª: +77071234567)");
            return;
        }

        if (isVip) {
            alert("VIP –¢”©–ª–µ–º: 1000 ‚Ç∏. –¢”©–ª–µ–≥–µ–Ω —Å–æ“£ –∞–¥–º–∏–Ω –º–∞“õ“±–ª–¥–∞–π–¥—ã.");
        }

        navigator.geolocation.getCurrentPosition(pos => {
            const body = {
                name, job, is_vip: isVip,
                lat: pos.coords.latitude, lon: pos.coords.longitude,
                contacts: JSON.stringify(contacts),
                token: myToken
            };

            fetch(API + '/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            }).then(() => {
                alert("–ñ—ñ–±–µ—Ä—ñ–ª–¥—ñ!");
                loadData();
            });
        });
    }

    // 3. –ú”ò–õ–Ü–ú–ï–¢–¢–ï–†–î–Ü –ö”®–†–°–ï–¢–£ (24 –°–ê“í–ê–¢ –¢–ï–ö–°–ï–†–Ü–°–Ü)
    function loadData() {
        fetch(API + '/get-all').then(r => r.json()).then(data => {
            rawData = data;
            filterMarkers();
        });
    }

    function filterMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        let listHtml = "";
        let count = 0;
        const now = Date.now();

        rawData.forEach(item => {
            const createdTime = new Date(item.created_at).getTime();
            const hoursPassed = (now - createdTime) / (1000 * 60 * 60);
            
            // 24 —Å–∞“ì–∞—Ç—Ç–∞–Ω –∞—Å—Å–∞ –∫”©—Ä—Å–µ—Ç–ø–µ—É
            if (hoursPassed > 24) return;

            // –¢–µ–≥—ñ–Ω –±–æ–ª—Å–∞ - —Ç–µ–∫ –∏–µ—Å—ñ –æ–Ω–ª–∞–π–Ω –±–æ–ª—Å–∞ –∫”©—Ä—ñ–Ω–µ–¥—ñ (–º—ã—Å–∞–ª—ã, —Å–æ“£“ì—ã 5 –º–∏–Ω)
            const isOnline = (now - (item.last_ping || 0)) < 300000;
            if (!item.is_active && !item.is_vip) {
                 if (!isOnline) return;
            }

            // VIP - —Ç–µ–∫ –∞–¥–º–∏–Ω –º–∞“õ“±–ª–¥–∞—Å–∞ (is_active) –∫”©—Ä—ñ–Ω–µ–¥—ñ
            if (item.is_vip && !item.is_active) return;

            const marker = L.circleMarker([item.lat, item.lon], {
                color: item.is_vip ? 'gold' : 'blue',
                radius: 10,
                fillOpacity: 0.8
            }).addTo(map);

            let contactsHtml = JSON.parse(item.contacts).map(c => `<div class="contact-item"><b>${c.type}:</b> ${c.val}</div>`).join('');
            marker.bindPopup(`<b>${item.job}</b><br>${item.name}<hr>${contactsHtml}`);
            markers.push(marker);

            if (map.getBounds().contains([item.lat, item.lon])) {
                count++;
                listHtml += `<div class="card"><b>${item.job}</b><br>${contactsHtml}</div>`;
            }
        });
        document.getElementById('item-count').innerText = count;
        document.getElementById('dynamic-list-content').innerHTML = listHtml;
    }

    // –ê–¥–º–∏–Ω —Ç–µ–∫—Å–µ—Ä—É
    function checkAdmin() {
        let p = prompt("“ö“±–ø–∏—è —Å”©–∑:");
        if (p === "admin777") {
            document.getElementById('adminPanel').style.display = 'block';
            renderAdminData();
        }
    }

    function renderAdminData() {
        let h = "";
        rawData.forEach(i => {
            h += `<div class="card">
                <b>${i.job}</b> (ID: ${i.id})<br>
                –£–∞“õ—ã—Ç—ã: ${new Date(i.created_at).toLocaleString()}<br>
                –î–µ—Ä–µ–∫—Ç–µ—Ä: ${i.contacts}<br>
                –°—Ç–∞—Ç—É—Å: ${i.is_active ? '–ê–∫—Ç–∏–≤' : '–ö“Ø—Ç—É–¥–µ'}<br>
                <button onclick="toggleItem(${i.id}, true)">“ö–æ—Å—É/VIP –ú–∞“õ“±–ª–¥–∞—É</button>
                <button onclick="deleteItem(${i.id})" style="color:red">–ñ–æ—é</button>
            </div>`;
        });
        document.getElementById('admin-data').innerHTML = h;
    }

    setInterval(() => {
        fetch(API + '/ping', { method: 'POST', body: JSON.stringify({token: myToken}), headers: {'Content-Type': 'application/json'} });
    }, 30000);

    loadData();
</script>
</body>
</html>
