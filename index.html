<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba | Unified Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        :root { --primary: #007bff; --success: #28a745; --warning: #ffc107; --danger: #dc3545; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; }
        
        /* SEARCH BOX */
        .search-box { padding: 10px; background: white; text-align: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-box input { width: 90%; padding: 12px; border-radius: 25px; border: 2px solid var(--primary); outline: none; }
        
        #map { height: 45vh; width: 100%; border-bottom: 3px solid var(--primary); }

        /* –î–ò–ù–ê–ú–ò–ö–ê–õ–´“ö –¢–Ü–ó–Ü–ú –°–¢–ò–õ–Ü */
        #visible-list-container { max-height: 250px; overflow-y: auto; background: white; margin: 10px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .list-header { padding: 10px; background: #eee; font-weight: bold; font-size: 14px; position: sticky; top: 0; }
        .list-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .list-item:hover { background: #f9f9f9; }
        .list-info { flex: 1; }
        .list-info b { color: var(--primary); font-size: 14px; }
        .list-info p { margin: 2px 0; font-size: 13px; color: #555; }
        .list-call { background: var(--success); color: white; padding: 8px 12px; border-radius: 20px; text-decoration: none; font-size: 12px; font-weight: bold; }

        .container { padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; align-items: start; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; border-top: 5px solid var(--primary); }
        
        input, select, textarea, button { width: 100%; margin: 8px 0; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.8; }
        
        .vip-btn { background: var(--warning); color: black; margin-top: 5px; }
        .payment-info { background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 8px; font-size: 12px; margin: 5px 0; color: #856404; }

        /* –ú–ê–†–ö–ï–† –ê–°–¢–´–ù–î–ê“í–´ –ú”ò–¢–Ü–ù */
        .marker-label { background: rgba(255,255,255,0.9); border: 1px solid var(--primary); border-radius: 4px; padding: 1px 4px; font-size: 11px; font-weight: bold; color: #333; pointer-events: none; }

        #admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10001; padding:20px; overflow-y:auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    </style>
</head>
<body>

<div class="search-box">
    <input type="text" id="searchInput" placeholder="–Ü–∑–¥–µ—É (–ú–∞–º–∞–Ω–¥—ã“õ, —Ç–∞—É–∞—Ä, —Ç–∞–ø—Å—ã—Ä—ã—Å...)" oninput="filterMarkers(); updateVisibleList();">
</div>
<div class="search-box">
    <input type="text" id="searchInput" placeholder="–Ü–∑–¥–µ—É..." oninput="filterMarkers(); updateVisibleList();">
    <div style="margin-top: 10px;">
        <button onclick="setMapStyle('color')" style="width: auto; padding: 5px 15px; background: var(--primary);">–¢“Ø—Å—Ç—ñ –∫–∞—Ä—Ç–∞</button>
        <button onclick="setMapStyle('mono')" style="width: auto; padding: 5px 15px; background: #666;">–ê“õ-“õ–∞—Ä–∞ –∫–∞—Ä—Ç–∞</button>
    </div>
</div>
<div id="map"></div>

<div id="visible-list-container">
    <div class="list-header">–û—Å—ã –∞—É–º–∞“õ—Ç–∞“ì—ã —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä:</div>
    <div id="dynamic-list-content"></div>
</div>

<div class="container">
    <div class="card" style="border-top-color: var(--primary);">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç –∂–∞—Ä–∏—è–ª–∞—É</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ">
        <input id="w_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <div class="payment-info">üíé VIP (490‚Ç∏): 24 —Å–∞“ì–∞—Ç –±–æ–π—ã –∫–∞—Ä—Ç–∞–¥–∞ “Ø–Ω–µ–º—ñ –∫”©—Ä—ñ–Ω—É.</div>
        <button onclick="saveItem('worker')">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
        <button class="vip-btn" onclick="initVIP('worker')">üíé VIP –∂–∞—Ä–∏—è–ª–∞—É</button>
    </div>

    <div class="card" style="border-top-color: var(--warning);">
        <h4>üì¶ –¢–∞—É–∞—Ä —Å–∞—Ç—É</h4>
        <input id="g_name" placeholder="–°–∞—Ç—É—à—ã –∞—Ç—ã">
        <input id="g_prod" placeholder="–¢–∞—É–∞—Ä –∞—Ç–∞—É—ã">
        <input id="g_price" placeholder="–ë–∞“ì–∞—Å—ã">
        <input id="g_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <div class="payment-info">üíé VIP (490‚Ç∏): 24 —Å–∞“ì–∞—Ç –±–æ–π—ã –∫–∞—Ä—Ç–∞–¥–∞ “Ø–Ω–µ–º—ñ –∫”©—Ä—ñ–Ω—É.</div>
        <button onclick="saveItem('good')" style="background:var(--warning); color:black;">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
        <button class="vip-btn" onclick="initVIP('good')" style="background:black; color:white;">üíé VIP –∂–∞—Ä–∏—è–ª–∞—É</button>
    </div>

    <div class="card" style="border-top-color: var(--success);">
        <h4>üìã –¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É (–¢–µ–≥—ñ–Ω)</h4>
        <input id="c_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <textarea id="c_desc" placeholder="–ù–µ “õ–∞–∂–µ—Ç?"></textarea>
        <input id="c_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <button style="background: var(--success);" onclick="saveItem('order')">–ñ–∞—Ä–∏—è–ª–∞—É</button>
    </div>
</div>

<div id="admin-modal">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h2>–ë–∞—Å“õ–∞—Ä—É –ø–∞–Ω–µ–ª—ñ</h2>
        <button onclick="location.hash=''" style="width:80px; background:var(--danger);">–ñ–∞–±—É</button>
    </div>
    <div id="admin-content"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
    const API = "https://sk-joba.onrender.com";
    const myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markersGroup = L.markerClusterGroup();
    map.addLayer(markersGroup);

    let rawData = []; // –ö–∞—Ä—Ç–∞–¥–∞“ì—ã –±–µ–ª—Å–µ–Ω–¥—ñ–ª–µ—Ä
    let adminData = null; // –ê–¥–º–∏–Ω–≥–µ –∞—Ä–Ω–∞–ª“ì–∞–Ω —Ç–æ–ª—ã“õ –±–∞–∑–∞

    // –ü–ò–ù–ì –ñ”ò–ù–ï –ö–ê–†–¢–ê –ñ–´–õ–ñ–´–¢–£
    function sendPing() { fetch(API + '/user-ping', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ token: myToken }) }); }
    setInterval(sendPing, 30000);
    sendPing();

    map.on('moveend', updateVisibleList);

    function saveItem(type) {
        let d = {}, path = '';
        if(type==='worker'){ path='/save-worker'; d={name:v('w_name'), job:v('w_job'), phone:v('w_phone')}; }
        if(type==='good'){ path='/save-goods'; d={name:v('g_name'), product:v('g_prod'), price:v('g_price'), phone:v('g_phone')}; }
        if(type==='order'){ path='/save-order'; d={name:v('c_name'), description:v('c_desc'), phone:v('c_phone')}; }

        if(!d.phone) return alert("–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ–Ω —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑!");

        navigator.geolocation.getCurrentPosition(p => {
            d.lat = p.coords.latitude; d.lon = p.coords.longitude; d.device_token = myToken;
            fetch(API + path, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(d) })
            .then(() => { alert("–ñ–∞—Ä–∏—è–ª–∞–Ω–¥—ã!"); loadMarkers(); });
        }, () => alert("GPS “õ–æ—Å—ã“£—ã–∑!"));
    }

    function initVIP(type) {
        alert("VIP –°–¢–ê–¢–£–° (490‚Ç∏). Kaspi: 87017398309. –¢”©–ª–µ–≥–µ–Ω —Å–æ“£ –ê–¥–º–∏–Ω –±–µ–ª—Å–µ–Ω–¥—ñ—Ä–µ–¥—ñ.");
        saveItem(type);
    }

    function loadMarkers() {
        fetch(API + '/get-all').then(r => r.json()).then(data => {
            adminData = data.admin_all;
            rawData = [
                ...data.workers.map(i => ({...i, type: 'worker', info: i.job})),
                ...data.goods.map(i => ({...i, type: 'good', info: i.product_name})),
                ...data.orders.map(i => ({...i, type: 'order', info: i.description}))
            ];
            filterMarkers();
            updateVisibleList();
            if(document.getElementById('admin-modal').style.display === 'block') renderAdmin();
        });
    }

    function filterMarkers() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        markersGroup.clearLayers();
        rawData.forEach(i => {
            if (i.info.toLowerCase().includes(term) || term === "") {
                const color = i.type === 'worker' ? '#007bff' : (i.type === 'good' ? '#ffc107' : '#28a745');
                const m = L.marker([i.lat, i.lon], {
                    icon: L.divIcon({ html: `<div style="background:${color};width:12px;height:12px;border-radius:50%;border:2px solid #fff;"></div>`, className: '' })
                });
                
                let delBtn = (i.device_token === myToken) ? `<br><button onclick="deleteItem(${i.id}, '${i.type}')" style="background:red; padding:3px; font-size:10px; width:auto;">–ñ–æ—é ‚ùå</button>` : "";
                m.bindPopup(`<b>${i.type.toUpperCase()}</b><br>${i.info}<br><a href="tel:${i.phone}">${i.phone}</a>${delBtn}`);
                
                // –ú”ò–¢–Ü–ù ”ò–†“ö–ê–®–ê–ù –ö”®–†–Ü–ù–Ü–ü –¢“∞–†–£–´ “Æ–®–Ü–ù
                m.bindTooltip(i.info.substring(0,15), { permanent: true, direction: 'bottom', offset: [0, 10], className: 'marker-label' });
                markersGroup.addLayer(m);
            }
        });
    }

    // –ê–£–î–ê–ù –ë–û–ô–´–ù–®–ê –ê–í–¢–û–ú–ê–¢–¢–´ –¢–Ü–ó–Ü–ú –ñ–ê“¢–ê–†–¢–£
    function updateVisibleList() {
        const bounds = map.getBounds();
        const term = document.getElementById('searchInput').value.toLowerCase();
        let html = '';
        let count = 0;

        rawData.forEach(i => {
            const loc = L.latLng(i.lat, i.lon);
            if(bounds.contains(loc) && (i.info.toLowerCase().includes(term) || term === "")) {
                count++;
                html += `
                    <div class="list-item">
                        <div class="list-info">
                            <b>${i.info}</b>
                            <p>${i.name || i.seller_name || i.client_name} ‚Ä¢ ${i.type}</p>
                        </div>
                        <a href="tel:${i.phone}" class="list-call">“ö–æ“£—ã—Ä–∞—É</a>
                    </div>
                `;
            }
        });
        document.getElementById('dynamic-list-content').innerHTML = count > 0 ? html : '<p style="padding:15px; font-size:13px;">–ë“±–ª –∞—É–º–∞“õ—Ç–∞ –µ—à—Ç–µ“£–µ —Ç–∞–±—ã–ª–º–∞–¥—ã...</p>';
    }

    function deleteItem(id, type) {
        if(!confirm("”®—à—ñ—Ä—É–¥—ñ —Ä–∞—Å—Ç–∞–π—Å—ã–∑ –±–∞?")) return;
        fetch(API + '/delete-item', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id, type, token: myToken}) }).then(() => loadMarkers());
    }

    function renderAdmin() {
        if(!adminData) return;
        let h = `<table><tr><th>–¢“Ø—Ä—ñ</th><th>–ò–Ω—Ñ–æ</th><th>–ö“Ø–π—ñ</th><th>”ò—Ä–µ–∫–µ—Ç</th></tr>`;
        const list = [
            ...adminData.workers.map(x=>({...x, t:'worker', msg: x.job})),
            ...adminData.goods.map(x=>({...x, t:'good', msg: x.product_name})),
            ...adminData.orders.map(x=>({...x, t:'order', msg: x.description}))
        ];
        list.forEach(i => {
            const status = i.is_active ? "<b style='color:green'>VIP</b>" : "–¢–µ–≥—ñ–Ω";
            const btn = `<button onclick="toggleActive(${i.id},'${i.t}', ${!i.is_active})">${i.is_active ? 'VIP ”®—à—ñ—Ä—É' : 'VIP “ö–æ—Å—É'}</button>`;
            h += `<tr><td>${i.t}</td><td>${i.msg}</td><td>${status}</td><td>${btn} <button style="background:red" onclick="deleteAdmin(${i.id},'${i.t}')">‚ùå</button></td></tr>`;
        });
        document.getElementById('admin-content').innerHTML = h + "</table>";
    }

    function toggleActive(id, type, active) {
        fetch(API + '/admin/toggle-active', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id, type, active}) }).then(() => loadMarkers());
    }
    
    function deleteAdmin(id, type) {
        fetch(API + '/delete-item', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id, type, token: 'admin777'}) }).then(() => loadMarkers());
    }

    function v(id){ return document.getElementById(id).value.trim(); }
    
    window.onhashchange = () => {
        if(location.hash === "#admin777") {
            const pass = prompt("“ö“±–ø–∏—è —Å”©–∑:");
            if(pass === "admin777") { document.getElementById('admin-modal').style.display='block'; renderAdmin(); }
            else { location.hash = ""; }
        } else { document.getElementById('admin-modal').style.display='none'; }
    };

    loadMarkers();
</script>
</body>
</html>
