<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        :root { --primary: #007bff; --success: #28a745; --warning: #ffc107; --danger: #dc3545; }
        body { font-family: sans-serif; margin: 0; background: #f4f7f6; }
        .header-box { position: sticky; top: 0; z-index: 1000; text-align: center; padding: 10px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-input { width: 90%; padding: 12px; border-radius: 25px; border: 2px solid var(--primary); outline: none; font-size: 16px; }
        #map { height: 45vh; width: 100%; border-bottom: 3px solid var(--primary); }
        .contact-badge { display: block; background: #e9ecef; border-radius: 4px; padding: 4px 8px; font-size: 13px; margin-top: 4px; border-left: 3px solid var(--primary); }
        .card { background: white; padding: 15px; border-radius: 10px; margin: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; }
        button { cursor: pointer; border: none; font-weight: bold; transition: 0.3s; }
        .admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto; }
        .online-dot { border: 3px solid #00ff00 !important; }
        .contact-row { display: flex; gap: 5px; margin-top: 5px; }
    </style>
</head>
<body>

<div class="header-box">
    <input type="text" id="searchInput" class="search-input" placeholder="üîç –Ü–∑–¥–µ—É (–ú–∞–º–∞–Ω–¥—ã“õ, —Ç–∞—É–∞—Ä...)" oninput="filterMarkers()">
    <button onclick="checkAdmin()" style="background:none; color:#ccc; font-size:10px; position:absolute; right:5px; top:5px;">Admin</button>
</div>

<div id="map"></div>

<div id="visible-list-container">
    <div style="padding:10px; font-weight:bold; background:#eee; position: sticky; top:0;">üìç –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞: (<span id="item-count">0</span>)</div>
    <div id="dynamic-list-content"></div>
</div>

<div class="card" style="border-top: 5px solid var(--primary);">
    <h4>üë∑ “ö—ã–∑–º–µ—Ç –∂–∞—Ä–∏—è–ª–∞—É</h4>
    <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
    <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“ì—ã“£—ã–∑ (–º—ã—Å–∞–ª—ã: –°–∞–Ω—Ç–µ—Ö–Ω–∏–∫)">
    <div id="w_contacts_list">
        <div class="contact-row">
            <select style="width:35%" class="c-type">
                <option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option><option>Skype</option><option>Teams</option>
            </select>
            <input style="width:65%" class="c-val" placeholder="–î–µ—Ä–µ–∫">
        </div>
    </div>
    <button onclick="addContactRow('w_contacts_list')" style="background:#6c757d; color:white; margin-top:5px; padding:5px; width:auto;">+ –ë–∞–π–ª–∞–Ω—ã—Å</button>
    <div style="display:flex; gap:10px; margin-top:10px;">
        <button onclick="processPost('worker', false)" style="background:var(--success); color:white; flex:1; padding:12px;">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
        <button onclick="processPost('worker', true)" style="background:var(--primary); color:white; flex:1; padding:12px;">üíé VIP (1000 ‚Ç∏)</button>
    </div>
</div>

<div id="adminPanel" class="admin-modal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>üõ° –ë–∞—Å“õ–∞—Ä—É –ø–∞–Ω–µ–ª—ñ</h3>
        <button onclick="document.getElementById('adminPanel').style.display='none'" style="background:var(--danger); color:white; padding:10px;">–ñ–∞–±—É</button>
    </div>
    <div id="admin-list"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
    const API = "https://sk-joba.onrender.com"; 
    let myToken = localStorage.getItem('token') || (Math.random().toString(36).substr(2) + Date.now().toString(36));
    localStorage.setItem('token', myToken);
    let isAdmin = false;

    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markersGroup = L.markerClusterGroup({ maxClusterRadius: 35 });
    map.addLayer(markersGroup);
    let rawData = [];

    // 1. –í–ê–õ–ò–î–ê–¶–ò–Ø (“ö–ê–¢–ê“¢ –¢–ï–ö–°–ï–†–£)
    function validateInput(type, value) {
        if (type === '–¢–µ–ª') {
            const phoneRegex = /^\+7\d{10}$/; // +77071234567
            return phoneRegex.test(value.replace(/\s+/g, ''));
        }
        if (type === 'Email') {
            return value.includes('@') && value.includes('.');
        }
        return value.length > 2;
    }

    // 2. –ë–ê–ô–õ–ê–ù–´–° –î–ï–†–ï–ö–¢–ï–†–Ü–ù –ñ–ò–ù–ê–£
    function getContacts(listId) {
        let contacts = [];
        const rows = document.getElementById(listId).querySelectorAll('.contact-row');
        for (let r of rows) {
            const cType = r.querySelector('.c-type').value;
            const cVal = r.querySelector('.c-val').value.trim();
            if (!validateInput(cType, cVal)) {
                alert(`“ö–∞—Ç–µ: ${cType} —Ñ–æ—Ä–º–∞—Ç—ã –¥“±—Ä—ã—Å –µ–º–µ—Å!`);
                return null;
            }
            contacts.push({type: cType, val: cVal});
        }
        return contacts.length > 0 ? JSON.stringify(contacts) : null;
    }

    // 3. –ñ–ê–†–ò–Ø–õ–ê–£ (GPS –ü–ï–ù VIP –¢–ï–ö–°–ï–†–£)
    function processPost(type, isVip) {
        const contactJson = getContacts(type === 'worker' ? 'w_contacts_list' : 'g_contacts_list');
        if (!contactJson) return;

        if (isVip) {
            const pay = confirm("VIP –∂–∞—Ä–∏—è–ª–∞—É “Ø—à—ñ–Ω 1000 ‚Ç∏ —Ç”©–ª–µ–º –∂–∞—Å–∞—É “õ–∞–∂–µ—Ç. –¢”©–ª–µ–º –±–µ—Ç—ñ–Ω–µ ”©—Ç—É?");
            if (!pay) return;
        }

        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            if (!lat || lat === 0) { alert("GPS “õ–∞—Ç–µ!"); return; }

            const d = { 
                device_token: myToken, is_vip: isVip, lat, lon, contacts: contactJson,
                name: document.getElementById('w_name').value, 
                job: document.getElementById('w_job').value
            };

            fetch(API + '/save-worker', { 
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d) 
            }).then(() => {
                alert(isVip ? "–¢”©–ª–µ–º –∫“Ø—Ç—ñ–ª—É–¥–µ... –ê–¥–º–∏–Ω –º–∞“õ“±–ª–¥–∞“ì–∞–Ω —Å–æ“£ —à—ã“ì–∞–¥—ã." : "–°”ô—Ç—Ç—ñ –∂–∞—Ä–∏—è–ª–∞–Ω–¥—ã!");
                loadMarkers();
            });
        }, (err) => alert("GPS “õ–æ—Å—ã“£—ã–∑!"), { enableHighAccuracy: true });
    }

    // 4. –ö–ê–†–¢–ê–î–ê –ñ”ò–ù–ï –¢–Ü–ó–Ü–ú–î–ï –ö”®–†–°–ï–¢–£
    function formatContacts(json) {
        try {
            const arr = typeof json === 'string' ? JSON.parse(json) : json;
            return arr.map(c => `<div class="contact-badge"><b>${c.type}:</b> ${c.val}</div>`).join('');
        } catch(e) { return "–î–µ—Ä–µ–∫ –∂–æ“õ"; }
    }

    function loadMarkers() {
        fetch(API + '/get-all').then(r => r.json()).then(data => {
            rawData = data.workers; // –¢–µ–∫ –∂“±–º—ã—Å—à—ã–ª–∞—Ä –º—ã—Å–∞–ª—ã–Ω–¥–∞
            filterMarkers();
            if(isAdmin) renderAdminList();
        });
    }

    function filterMarkers() {
        markersGroup.clearLayers();
        const bounds = map.getBounds();
        let listHtml = "", count = 0;

        rawData.forEach(i => {
            // VIP –±–æ–ª—Å–∞ –∂”ô–Ω–µ –∞–∫—Ç–∏–≤ –±–æ–ª–º–∞—Å–∞ - —Ç–µ–∫ –∞–¥–º–∏–Ω–≥–µ –Ω–µ–º–µ—Å–µ –∏–µ—Å—ñ–Ω–µ –∫”©—Ä—ñ–Ω–µ–¥—ñ
            const isOwner = i.device_token.includes(myToken);
            if (i.device_token.includes('WAITING_VIP_') && !i.is_active && !isAdmin && !isOwner) return;

            const latLng = [i.lat, i.lon];
            const isOnline = (Date.now() - (i.last_ping || 0)) < 180000;
            
            const m = L.marker(latLng, {
                icon: L.divIcon({ 
                    className: '', 
                    html: `<div style="background:${i.device_token.includes('WAITING_VIP') ? 'gold' : '#007bff'}; width:18px; height:18px; border-radius:50%; border:2px solid ${isOnline ? '#00ff00' : 'white'};"></div>` 
                })
            });

            const content = `<b>${i.job}</b><br><small>${i.name}</small><hr>${formatContacts(i.contacts)}`;
            m.bindPopup(content);
            markersGroup.addLayer(m);

            if (bounds.contains(latLng)) {
                count++;
                listHtml += `<div class="card"><b>${i.job}</b><br>${formatContacts(i.contacts)}</div>`;
            }
        });
        document.getElementById('item-count').innerText = count;
        document.getElementById('dynamic-list-content').innerHTML = listHtml;
    }

    // 5. –ê–î–ú–ò–ù –õ–û–ì–ò–ö–ê–°–´
    function checkAdmin() {
        const pass = prompt("“ö“±–ø–∏—è —Å”©–∑:");
        if (pass === "admin777") {
            isAdmin = true;
            document.getElementById('adminPanel').style.display = 'block';
            loadMarkers();
        }
    }

    function renderAdminList() {
        let h = "";
        rawData.forEach(i => {
            const date = new Date(i.created_at).toLocaleString('kk-KZ');
            h += `<div class="card" style="border-left: 5px solid ${i.is_active ? 'green' : 'red'}">
                <b>${i.job}</b> [${i.name}]<br>
                ${formatContacts(i.contacts)}
                <div style="font-size:11px; color:gray;">–£–∞“õ—ã—Ç—ã: ${date}</div>
                <button onclick="toggleActive(${i.id}, ${!i.is_active})" style="background:var(--success); color:white;">${i.is_active ? '”®—à—ñ—Ä—É' : '–ú–∞“õ“±–ª–¥–∞—É (VIP)'}</button>
                <button onclick="deleteItem(${i.id})" style="background:var(--danger); color:white;">–ñ–æ—é</button>
            </div>`;
        });
        document.getElementById('admin-list').innerHTML = h;
    }

    function toggleActive(id, active) {
        fetch(API + '/admin/toggle-active', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({id, type:'worker', active})
        }).then(loadMarkers);
    }

    function addContactRow(id) {
        const div = document.createElement('div');
        div.className = 'contact-row';
        div.innerHTML = `<select style="width:35%" class="c-type"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option><option>Skype</option><option>Teams</option></select><input style="width:65%" class="c-val" placeholder="–î–µ—Ä–µ–∫">`;
        document.getElementById(id).appendChild(div);
    }

    map.on('moveend', filterMarkers);
    loadMarkers();
</script>
</body>
</html>
