<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Marketplace</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 50vh; width: 100%; }
        .forms-container { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; }
        .card { background: white; padding: 10px; border-radius: 8px; flex: 1; min-width: 250px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, button, select { width: 100%; margin: 5px 0; padding: 8px; border-radius: 4px; border: 1px solid #ddd; }
        .btn-w { background: #007bff; color: white; }
        .btn-c { background: #dc3545; color: white; }
        .btn-g { background: #ffc107; color: black; }
        #admin-panel { background: #343a40; color: white; padding: 15px; display: none; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="forms-container">
    <div class="card">
        <h4>üë∑ –û—Ä—ã–Ω–¥–∞—É—à—ã</h4>
        <input type="text" id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input type="text" id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ">
        <input type="tel" id="w_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value="+7">
        <select id="w_dur"><option value="1">1 —Å–∞“ì–∞—Ç (500—Ç–≥)</option><option value="24">1 —Ç”ô—É–ª—ñ–∫ (2000—Ç–≥)</option></select>
        <button class="btn-w" onclick="saveWorker()">–¢”©–ª–µ—É –∂”ô–Ω–µ –¢—ñ—Ä–∫–µ–ª—É</button>
    </div>

    <div class="card">
        <h4>üì¶ –¢–∞—É–∞—Ä –°–∞—Ç—É</h4>
        <input type="text" id="g_name" placeholder="–°–∞—Ç—É—à—ã –∞—Ç—ã">
        <input type="text" id="g_prod" placeholder="–¢–∞—É–∞—Ä –∞—Ç—ã">
        <input type="text" id="g_price" placeholder="–ë–∞“ì–∞—Å—ã">
        <input type="tel" id="g_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value="+7">
        <button class="btn-g" onclick="saveGoods()">–¢–∞—É–∞—Ä–¥—ã “õ–æ—Å—É</button>
    </div>

    <div class="card">
        <h4>üìã –¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É</h4>
        <input type="text" id="c_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <textarea id="c_desc" placeholder="–ù–µ —ñ—Å—Ç–µ—É –∫–µ—Ä–µ–∫?"></textarea>
        <input type="tel" id="c_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value="+7">
        <button class="btn-c" onclick="saveOrder()">–¢–∞–ø—Å—ã—Ä—ã—Å “õ–∞–ª–¥—ã—Ä—É</button>
    </div>
</div>

<button onclick="document.getElementById('admin-panel').style.display='block'">–ê–¥–º–∏–Ω</button>

<div id="admin-panel">
    <h3>–¢”©–ª–µ–º–¥—ñ —Ä–∞—Å—Ç–∞—É (–ê–¥–º–∏–Ω)</h3>
    <div id="pending-list"></div>
    <button onclick="this.parentElement.style.display='none'">–ñ–∞–±—É</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const API = "https://sk-joba.onrender.com";
    const myToken = localStorage.getItem('device_token') || Math.random().toString(36).substring(2);
    localStorage.setItem('device_token', myToken);

    function loadAll() {
        fetch(`${API}/get-all`).then(res => res.json()).then(data => {
            map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });
            
            // –ú–∞–º–∞–Ω–¥–∞—Ä (–ö”©–∫)
            data.workers.forEach(w => L.marker([w.lat, w.lon]).addTo(map).bindPopup(`<b>–ú–∞–º–∞–Ω: ${w.name}</b><br>${w.job}<br>${w.phone}`));
            
            // –¢–∞—É–∞—Ä–ª–∞—Ä (–°–∞—Ä—ã)
            data.goods.forEach(g => {
                const yellowIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png', iconSize: [25, 41] });
                L.marker([g.lat, g.lon], {icon: yellowIcon}).addTo(map).bindPopup(`<b>–¢–ê–£–ê–†: ${g.product_name}</b><br>–ë–∞“ì–∞—Å—ã: ${g.price}<br>–°–∞—Ç—É—à—ã: ${g.seller_name}<br>${g.phone}`);
            });

            // –¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä (“ö—ã–∑—ã–ª)
            data.orders.forEach(o => {
                const redIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41] });
                let html = `<b>–¢–ê–ü–°–´–†–´–°: ${o.description}</b><br>${o.phone}`;
                if(o.device_token === myToken) html += `<br><button onclick="deleteOrder(${o.id})">”®—à—ñ—Ä—É</button>`;
                L.marker([o.lat, o.lon], {icon: redIcon}).addTo(map).bindPopup(html);
            });
        });
        loadPending();
    }

    // –ê–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏—è—Å—ã
    function loadPending() {
        fetch(`${API}/admin/pending-workers`).then(res => res.json()).then(list => {
            let html = "";
            list.forEach(w => {
                html += `<div>${w.name} - ${w.job} <button onclick="activateWorker(${w.id})">–†–∞—Å—Ç–∞—É (–¢”©–ª–µ–¥—ñ)</button></div>`;
            });
            document.getElementById('pending-list').innerHTML = html || "–ö“Ø—Ç—ñ–ø —Ç“±—Ä“ì–∞–Ω–¥–∞—Ä –∂–æ“õ";
        });
    }

    function activateWorker(id) {
        const secret = prompt("–ê–¥–º–∏–Ω –ø–∞—Ä–æ–ª—å:");
        fetch(`${API}/admin/activate-worker`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id, secret })
        }).then(() => loadAll());
    }

    function saveWorker() {
        alert("–¢”©–ª–µ–º–¥—ñ –∂–∞—Å–∞“£—ã–∑ (Kaspi +7701...). –†–∞—Å—Ç–∞–ª“ì–∞–Ω —Å–æ“£ –∫–∞—Ä—Ç–∞“ì–∞ —à—ã“ì–∞—Å—ã–∑.");
        navigator.geolocation.getCurrentPosition(p => {
            const body = { name: getValue('w_name'), phone: getValue('w_phone'), job: getValue('w_job'), durationHours: getValue('w_dur'), lat: p.coords.latitude, lon: p.coords.longitude };
            fetch(`${API}/save-worker`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(() => alert("–ö“Ø—Ç—É —Ç—ñ–∑—ñ–º—ñ–Ω–µ “õ–æ—Å—ã–ª–¥—ã“£—ã–∑."));
        });
    }

    function saveGoods() {
        navigator.geolocation.getCurrentPosition(p => {
            const body = { name: getValue('g_name'), product: getValue('g_prod'), price: getValue('g_price'), phone: getValue('g_phone'), lat: p.coords.latitude, lon: p.coords.longitude };
            fetch(`${API}/save-goods`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(() => { alert("–¢–∞—É–∞—Ä “õ–æ—Å—ã–ª–¥—ã!"); loadAll(); });
        });
    }

    function getValue(id) { return document.getElementById(id).value; }
    loadAll();
</script>
</body>
</html>
