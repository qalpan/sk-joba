<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Service Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* –¢”©–º–µ–Ω–≥—ñ –º”ô–∑—ñ—Ä –¥–∏–∑–∞–π–Ω—ã */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: flex; gap: 10px; background: rgba(255, 255, 255, 0.9);
            padding: 15px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px); width: 90%; max-width: 400px; justify-content: center;
        }
        
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; transition: 0.3s; padding: 5px;
        }
        .nav-item:hover { transform: translateY(-5); color: #3498db; }
        .nav-item span { font-size: 20px; }
        .nav-item label { font-size: 10px; font-weight: bold; margin-top: 5px; }

        /* "–ñ“±–º—ã—Å“õ–∞ —à—ã“ì—É" –±–∞—Ç—ã—Ä–º–∞—Å—ã */
        .work-btn {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: #27ae60; color: white; border: none; padding: 12px 20px;
            border-radius: 50px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer;
        }
    </style>
</head>
<body>

    <button class="work-btn" onclick="startTracking()">üü¢ –ñ“±–º—ã—Å“õ–∞ —à—ã“ì—É</button>

    <div id="map"></div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="filterMarkers('all')"><span>üåç</span><label>–ë–∞—Ä–ª—ã“ì—ã</label></div>
        <div class="nav-item" onclick="filterMarkers('üõ†')"><span>üõ†</span><label>–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫</label></div>
        <div class="nav-item" onclick="filterMarkers('‚ö°')"><span>‚ö°</span><label>–≠–ª–µ–∫—Ç—Ä–∏–∫</label></div>
        <div class="nav-item" onclick="filterMarkers('üõí')"><span>üõí</span><label>–î“Ø–∫–µ–Ω</label></div>
        <div class="nav-item" onclick="filterMarkers('üì¶')"><span>üì¶</span><label>–ö—É—Ä—å–µ—Ä</label></div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const socket = io("https://sk-joba.onrender.com");
    const map = L.map('map', { zoomControl: false }).setView([43.238, 76.889], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let myName = "";
    let myMarker;
    const markers = {}; 

    // 1. –°“Æ–ó–ì–Ü (–§–ò–õ–¨–¢–†) –§–£–ù–ö–¶–ò–Ø–°–´
    function filterMarkers(role) {
        alert("–¢–∞“£–¥–∞–ª“ì–∞–Ω —Å–∞–Ω–∞—Ç: " + (role === 'all' ? '–ë–∞—Ä–ª—ã“ì—ã' : role));
        Object.keys(markers).forEach(id => {
            if (role === 'all' || markers[id].role === role) {
                map.addLayer(markers[id]);
            } else {
                map.removeLayer(markers[id]);
            }
        });
    }

    // 2. –¢–Ü–†–ö–ï–õ–£ –ñ”ò–ù–ï –ì–ï–û–õ–û–ö–ê–¶–ò–Ø
    function startTracking() {
        myName = prompt("–ê—Ç—ã“£—ã–∑–¥—ã –∂–∞–∑—ã“£—ã–∑:");
        const role = prompt("–†”©–ª—ñ“£—ñ–∑–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑ (üõ†, ‚ö°, üõí, üì¶):", "üõ†");
        
        if (!myName) return;
        socket.emit('register', myName);

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((position) => {
                const { latitude, longitude } = position.coords;
                
                if (!myMarker) {
                    myMarker = L.marker([latitude, longitude]).addTo(map).bindPopup("–ú–µ–Ω: " + myName).openPopup();
                } else {
                    myMarker.setLatLng([latitude, longitude]);
                }
                map.setView([latitude, longitude], 15);

                socket.emit('send_location', { id: myName, role: role, lat: latitude, lng: longitude });
            });
        }
    }

    // 3. –ë–ê–°“ö–ê –ú–ê–ú–ê–ù–î–ê–†–î–´ –ö–ê–†–¢–ê“í–ê –°–ê–õ–£
    socket.on('receive_location', (data) => {
        if (markers[data.id]) {
            markers[data.id].setLatLng([data.lat, data.lng]);
        } else {
            const icon = L.divIcon({
                html: `<div style="font-size: 24px;">${data.role}</div>`,
                className: 'custom-div-icon'
            });
            const newMarker = L.marker([data.lat, data.lng], { icon: icon }).addTo(map)
                .bindPopup(`<b>${data.role} ${data.id}</b><br><button onclick="orderService('${data.id}')">–¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É</button>`);
            
            newMarker.role = data.role; // –°“Ø–∑–≥—ñ–ª–µ—É “Ø—à—ñ–Ω —Ä”©–ª—ñ–Ω —Å–∞“õ—Ç–∞–π–º—ã–∑
            markers[data.id] = newMarker;
        }
    });

    // 4. –¢–ê–ü–°–´–†–´–° –ñ–Ü–ë–ï–†–£
    function orderService(providerId) {
        if (!myName) myName = "“ö–æ–Ω–∞“õ_" + Math.floor(Math.random() * 1000);
        socket.emit('order_request', { to: providerId, from: myName });
        alert(providerId + " –º–∞–º–∞–Ω“ì–∞ —Å“±—Ä–∞–Ω—ã—Å –∫–µ—Ç—Ç—ñ. –ñ–∞—É–∞–ø –∫“Ø—Ç—ñ“£—ñ–∑...");
    }

    // 5. –¢–ê–ü–°–´–†–´–° “ö–ê–ë–´–õ–î–ê–£ (–ú–ê–ú–ê–ù “Æ–®–Ü–ù)
    socket.on('order_received', (data) => {
        const audio = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3');
        audio.play().catch(e => console.log("–î—ã–±—ã—Å –æ–π–Ω–∞—Ç—ã–ª–º–∞–¥—ã")); 
        
        if (confirm(`–ñ–ê“¢–ê –¢–ê–ü–°–´–†–´–°!\n–¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É—à—ñ: ${data.from}\n“ö–∞–±—ã–ª–¥–∞–π—Å—ã–∑ –±–∞?`)) {
            socket.emit('order_response', { toClient: data.from, from: myName, status: 'accepted' });
        } else {
            socket.emit('order_response', { toClient: data.from, from: myName, status: 'rejected' });
        }
    });

    // 6. –ñ–ê–£–ê–ü–¢–´ –ê–õ–£ (–ö–õ–ò–ï–ù–¢ “Æ–®–Ü–ù)
    socket.on('order_final_status', (data) => {
        if (data.status === 'accepted') {
            alert(`‚úÖ ${data.providerName} —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç—ã “õ–∞–±—ã–ª–¥–∞–¥—ã!`);
        } else {
            alert(`‚ùå –ö–µ—à—ñ—Ä—ñ“£—ñ–∑, ${data.providerName} “õ–∞–∑—ñ—Ä –±–æ—Å –µ–º–µ—Å.`);
        }
    });
</script>
</body>
</html>
