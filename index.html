<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        :root { --primary: #007bff; --success: #28a745; --warning: #ffc107; --danger: #dc3545; }
        body { font-family: sans-serif; margin: 0; background: #f4f7f6; }
        .header-box { position: sticky; top: 0; z-index: 1000; text-align: center; padding-top: 10px; background: rgba(244,247,246,0.95); }
        .search-input { width: 90%; padding: 12px; border-radius: 25px; border: 2px solid var(--primary); outline: none; }
        #map { height: 50vh; width: 100%; border-bottom: 3px solid var(--primary); z-index: 1; }
        #visible-list-container { background: white; margin: 10px; border-radius: 12px; height: 25vh; overflow-y: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .list-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .container { padding: 15px; display: grid; gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 10px; border-top: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, textarea, button { width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; }
        button { color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
    </style>
</head>
<body>

<div class="header-box">
    <input type="text" id="searchInput" class="search-input" placeholder="–Ü–∑–¥–µ—É (–ú–∞–º–∞–Ω–¥—ã“õ, —Ç–∞—É–∞—Ä)..." oninput="filterMarkers()">
    <div style="margin-top:5px; font-size:12px; color:gray;">–ë–∞–∑–∞ —Ç–æ–ª—ã“õ –∂–∞“£–∞—Ä—Ç—ã–ª–¥—ã. “ö–∞–π—Ç–∞ –µ–Ω–≥—ñ–∑—ñ–ø –∫”©—Ä—ñ“£—ñ–∑.</div>
</div>

<div id="map"></div>

<div id="visible-list-container">
    <div style="padding:10px; font-weight:bold; background:#eee;">üìç –¢—ñ–∑—ñ–º (<span id="item-count">0</span>)</div>
    <div id="dynamic-list-content"></div>
</div>

<div class="container">
    <div class="card" style="border-color: var(--primary);">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç –∂–∞—Ä–∏—è–ª–∞—É</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ (–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫)">
        <input id="w_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+77...)">
        <button onclick="saveItem('worker', false)" style="background:var(--primary)">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
        <button onclick="initVIP('worker')" style="background:#0056b3">üíé VIP –∂–∞—Ä–∏—è–ª–∞—É</button>
    </div>

    <div class="card" style="border-color: var(--warning);">
        <h4>üì¶ –¢–∞—É–∞—Ä —Å–∞—Ç—É</h4>
        <input id="g_name" placeholder="–°–∞—Ç—É—à—ã –∞—Ç—ã">
        <input id="g_prod" placeholder="–¢–∞—É–∞—Ä –∞—Ç—ã (–°“Ø—Ç, –ï—Ç)">
        <input id="g_price" placeholder="–ë–∞“ì–∞—Å—ã">
        <input id="g_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+77...)">
        <button onclick="saveItem('good', false)" style="background:var(--warning)">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
        <button onclick="initVIP('good')" style="background:#d39e00">üíé VIP –∂–∞—Ä–∏—è–ª–∞—É</button>
    </div>

    <div class="card" style="border-color: var(--success);">
        <h4>üìã –¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É</h4>
        <input id="c_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <textarea id="c_desc" placeholder="–ù–µ –∫–µ—Ä–µ–∫? (–¢–æ–ª—ã“õ –∂–∞–∑—ã“£—ã–∑)"></textarea>
        <input id="c_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+77...)">
        <button onclick="saveItem('order', false)" style="background:var(--success)">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
        <button onclick="initVIP('order')" style="background:#1e7e34">üíé VIP —Ç–∞–ø—Å—ã—Ä—ã—Å</button>
    </div>
</div>

<div id="admin-modal">
    <h3>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h3>
    <button onclick="location.hash=''" style="background:red; width:auto; padding:5px 15px;">–ñ–∞–±—É</button>
    <div style="margin:10px 0;">
        <button onclick="resetDatabaseDanger()" style="background:black; color:red; border:1px solid red;">‚ö†Ô∏è –ë–ê–ó–ê–ù–´ –¢–ê–ó–ê–õ–ê–£ (RESET)</button>
    </div>
    <div id="admin-content">Loading...</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
    const API = "https://sk-joba.onrender.com"; 
    const myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    const map = L.map('map').setView([43.2389, 76.8897], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const markersGroup = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        maxClusterRadius: 40 
    });
    map.addLayer(markersGroup);

    let rawData = [];
    let adminData = null;

    setInterval(() => {
        fetch(API + '/user-ping', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token:myToken})});
    }, 20000);

    function loadMarkers() {
        fetch(API + '/get-all')
            .then(r => r.json())
            .then(data => {
                adminData = data.admin_all;
                const newData = [];
                // –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –¥“±—Ä—ã—Å –∂–∏–Ω–∞—É
                if(data.workers) data.workers.forEach(x => newData.push({...x, type:'worker', info: x.job, title: x.name, phone: x.phone}));
                if(data.goods) data.goods.forEach(x => newData.push({...x, type:'good', info: x.product_name, title: x.seller_name, phone: x.phone}));
                if(data.orders) data.orders.forEach(x => newData.push({...x, type:'order', info: x.description, title: x.client_name, phone: x.phone}));

                if(JSON.stringify(rawData) !== JSON.stringify(newData)) {
                    rawData = newData;
                    filterMarkers();
                }
                if(document.getElementById('admin-modal').style.display === 'block') renderAdmin();
            })
            .catch(e => console.error(e));
    }

    function filterMarkers() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        markersGroup.clearLayers();
        let listHtml = '';
        let count = 0;

        rawData.forEach(i => {
            if((i.info && i.info.toLowerCase().includes(term)) || (i.title && i.title.toLowerCase().includes(term))) {
                count++;
                const color = i.type==='worker'?'#007bff':(i.type==='good'?'#ffc107':'#28a745');
                const isVIP = i.is_active;

                const m = L.marker([i.lat, i.lon], {
                    icon: L.divIcon({ html: `<div style="background:${color};width:16px;height:16px;border-radius:50%;border:2px solid white; box-shadow:0 0 5px black;"></div>` })
                });
                
                let delBtn = "";
                if (i.device_token === myToken || i.device_token === 'WAITING_VIP_' + myToken) {
                    delBtn = `<button onclick="deleteItem(${i.id},'${i.type}')" style="background:red; color:white; padding:5px; margin-top:5px;">–ñ–æ—é</button>`;
                }

                // –¢–ï–õ–ï–§–û–ù –ù”®–ú–Ü–†–Ü–ù –®–´“í–ê–†–£: i.phone –±–∞—Ä –º–∞ –µ–∫–µ–Ω—ñ–Ω —Ç–µ–∫—Å–µ—Ä–µ–º—ñ–∑
                const phoneLink = i.phone ? `<a href="tel:${i.phone}" style="display:block; background:green; color:white; padding:6px; border-radius:5px; text-decoration:none; margin-top:5px; text-align:center;">üìû ${i.phone}</a>` : '<span style="color:red">–ù”©–º—ñ—Ä –∂–æ“õ</span>';

                m.bindPopup(`
                    <div style="min-width:150px; text-align:center;">
                        <b style="color:${color}">${isVIP?'‚≠ê VIP<br>':''}${i.type.toUpperCase()}</b><br>
                        <b>${i.info}</b><br>
                        ${i.title || ''}<br>
                        ${phoneLink}
                        ${delBtn}
                    </div>
                `);
                markersGroup.addLayer(m);

                listHtml += `
                    <div class="list-item">
                        <div>
                            <b style="color:${color}">${isVIP?'‚≠ê ':''}${i.info}</b>
                            <span style="font-size:12px; display:block;">${i.title || 'User'}</span>
                        </div>
                        <a href="tel:${i.phone}" style="text-decoration:none; font-weight:bold;">üìû Call</a>
                    </div>
                `;
            }
        });
        document.getElementById('dynamic-list-content').innerHTML = listHtml;
        document.getElementById('item-count').innerText = count;
    }

    function saveItem(type, isVip) {
        let d = { is_vip: isVip };
        if(type==='worker') { d.name=v('w_name'); d.job=v('w_job'); d.phone=v('w_phone'); }
        if(type==='good') { d.name=v('g_name'); d.product=v('g_prod'); d.price=v('g_price'); d.phone=v('g_phone'); }
        if(type==='order') { d.name=v('c_name'); d.description=v('c_desc'); d.phone=v('c_phone'); }

        if(!d.phone) return alert("–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ–Ω –∂–∞–∑—ã“£—ã–∑!");

        navigator.geolocation.getCurrentPosition(pos => {
            d.lat = pos.coords.latitude;
            d.lon = pos.coords.longitude;
            d.device_token = myToken;

            const endpoint = type==='worker'?'/save-worker':(type==='good'?'/save-goods':'/save-order');

            fetch(API + endpoint, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(d)
            }).then(r=>r.json()).then(res => {
                if(res.success) {
                    alert(isVip ? "VIP ”©—Ç—ñ–Ω—ñ–º “õ–∞–±—ã–ª–¥–∞–Ω–¥—ã! –¢”©–ª–µ–º —Ä–∞—Å—Ç–∞–ª“ì–∞–Ω —Å–æ“£ —à—ã“ì–∞–¥—ã." : "–°”ô—Ç—Ç—ñ! (–¢–µ–≥—ñ–Ω —Ö–∞–±–∞—Ä–ª–∞–º–∞ 1 –º–∏–Ω—É—Ç —ñ—à—ñ–Ω–¥–µ —à—ã“ì–∞–¥—ã)");
                    loadMarkers();
                } else {
                    alert("“ö–∞—Ç–µ: " + res.error);
                }
            });
        }, () => alert("GPS “õ–æ—Å—ã“£—ã–∑!"));
    }

    function initVIP(type) {
        if(confirm("VIP –°–¢–ê–¢–£–° (490‚Ç∏). OK –±–∞—Å—ã“£—ã–∑.")) {
            saveItem(type, true);
            window.location.href = `mailto:sk-joba@outlook.com?subject=VIP&body=Type: ${type}`;
        }
    }

    function deleteItem(id, type) {
        if(!confirm("”®—à—ñ—Ä–µ—Å—ñ–∑ –±–µ?")) return;
        fetch(API + '/delete-item', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, type, token:myToken})})
        .then(() => { loadMarkers(); alert("”®—à—ñ—Ä—ñ–ª–¥—ñ"); });
    }

    // –ë–ê–ó–ê–ù–´ –¢–ê–ó–ê–õ–ê–£ (RESET)
    function resetDatabaseDanger() {
        if(prompt("–ë–∞—Ä–ª—ã“õ –¥–µ—Ä–µ–∫—Ç–µ—Ä ”©—à–µ–¥—ñ! –ö–µ–ª—ñ—Å—Å–µ“£—ñ–∑ 'DELETE' –¥–µ–ø –∂–∞–∑—ã“£—ã–∑:") === "DELETE") {
            fetch(API + '/reset-database-danger').then(r=>r.text()).then(msg => alert(msg));
        }
    }

    function renderAdmin() {
        if(!adminData) return;
        let h = `<table border="1"><tr><th>Type</th><th>Info</th><th>Status</th><th>Action</th></tr>`;
        const list = [
            ...adminData.workers.map(x=>({...x, t:'worker', i:x.job})),
            ...adminData.goods.map(x=>({...x, t:'good', i:x.product_name})),
            ...adminData.orders.map(x=>({...x, t:'order', i:x.description}))
        ];
        list.forEach(item => {
            const btn = `<button onclick="toggleActive(${item.id},'${item.t}', ${!item.is_active})" style="background:${item.is_active?'orange':'green'}">${item.is_active?'VIP ”®—à—ñ—Ä—É':'VIP “ö–û–°–£'}</button>`;
            const del = `<button onclick="admDel(${item.id},'${item.t}')" style="background:red;">Del</button>`;
            h += `<tr><td>${item.t}</td><td>${item.i}</td><td>${item.is_active?'VIP':'Free'}</td><td>${btn}${del}</td></tr>`;
        });
        document.getElementById('admin-content').innerHTML = h + "</table>";
    }

    function toggleActive(id, type, val) {
        fetch(API + '/admin/toggle-active', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, type, active:val})})
        .then(()=>renderAdmin());
    }
    function admDel(id, type) {
        fetch(API + '/delete-item', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, type, token:'admin777'})})
        .then(()=>renderAdmin());
    }

    window.onhashchange = () => {
        if(location.hash==='#admin777') {
            if(prompt('Password')==='admin777') {
                document.getElementById('admin-modal').style.display='block';
                renderAdmin();
            }
        } else {
            document.getElementById('admin-modal').style.display='none';
        }
    }
    
    function v(id){ return document.getElementById(id).value; }
    
    loadMarkers();
    setInterval(loadMarkers, 10000); 

</script>
</body>
</html>
