<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace | SK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 40vh; width: 100%; border-bottom: 2px solid #007bff; }
        .container { padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input, select, textarea, button { width: 100%; margin: 8px 0; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .kaspi-btn { display: block; background: #f00; color: white; text-align: center; padding: 10px; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 5px 0; }
        #admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10000; padding:20px; overflow-y:auto; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 13px; }
        .admin-table th { background: #333; color: white; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="container">
    <div class="card">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç “±—Å—ã–Ω—É</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑ (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <input id="w_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <select id="w_dur" onchange="updPrice()">
            <option value="1">1 —Å–∞“ì–∞—Ç (49‚Ç∏)</option>
            <option value="24">1 —Ç”ô—É–ª—ñ–∫ (490‚Ç∏)</option>
        </select>
        <a id="w_link" href="https://kaspi.kz/pay/_/transfer?number=77000000000&amount=49" target="_blank" class="kaspi-btn">Kaspi-–º–µ–Ω —Ç”©–ª–µ—É 49‚Ç∏</a>
        <button onclick="saveWorker(this)">–¢”©–ª–µ–¥—ñ–º –∂”ô–Ω–µ –¢—ñ—Ä–∫–µ–ª—É</button>
    </div>

    <div class="card">
        <h4>üì¶ –¢–∞—É–∞—Ä —Å–∞—Ç—É</h4>
        <input id="g_name" placeholder="–ê—Ç—ã“£—ã–∑ (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <input id="g_prod" placeholder="–¢–∞—É–∞—Ä –∞—Ç—ã (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <input id="g_price" placeholder="–ë–∞“ì–∞—Å—ã (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <input id="g_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <a href="https://kaspi.kz/pay/_/transfer?number=77000000000&amount=490" target="_blank" class="kaspi-btn" style="background:#ffc107; color:black;">Kaspi-–º–µ–Ω —Ç”©–ª–µ—É 490‚Ç∏</a>
        <button onclick="saveGoods(this)" style="background:#ffc107; color:black;">–¢”©–ª–µ–¥—ñ–º –∂”ô–Ω–µ “ö–æ—Å—É</button>
    </div>
</div>

<div id="admin-modal">
    <button onclick="window.location.hash=''" style="width:auto; float:right; background:#333;">‚ùå –ñ–∞–±—É</button>
    <h2>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h2>
    <div id="admin-list">–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
    const API = "https://sk-joba.onrender.com";
    const myToken = localStorage.getItem('t') || Math.random().toString(36).substr(2);
    localStorage.setItem('t', myToken);

    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function updPrice() {
        const val = document.getElementById('w_dur').value;
        const price = val === "1" ? 49 : 490;
        document.getElementById('w_link').innerText = `Kaspi-–º–µ–Ω —Ç”©–ª–µ—É ${price}‚Ç∏`;
        document.getElementById('w_link').href = `https://kaspi.kz/pay/_/transfer?number=77000000000&amount=${price}`;
    }

    // “ö–ê–¢–ê“¢ –í–ê–õ–ò–î–ê–¶–ò–Ø
    function isInvalid(ids) {
        let err = false;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(!el.value.trim()) { el.style.borderColor = "red"; err = true; }
            else { el.style.borderColor = "#ccc"; }
        });
        if(err) alert("–ë–∞—Ä–ª—ã“õ –∂–æ–ª–¥—ã —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑!");
        return err;
    }

    function saveWorker(btn) {
        if(isInvalid(['w_name', 'w_job', 'w_phone'])) return; // –û–°–´ –ñ–ï–†–î–ï –¢–û“ö–¢–ê–¢–ê–î–´
        btn.disabled = true;
        navigator.geolocation.getCurrentPosition(p => {
            fetch(API+'/save-worker', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
                name: v('w_name'), job: v('w_job'), phone: v('w_phone'), durationHours: v('w_dur'),
                lat: p.coords.latitude, lon: p.coords.longitude, device_token: myToken
            })}).then(() => { alert("–¢”©–ª–µ–º —Ç–µ–∫—Å–µ—Ä—ñ–ª—É–¥–µ!"); location.reload(); });
        }, () => { alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è “õ–∞–∂–µ—Ç!"); btn.disabled = false; });
    }

    function saveGoods(btn) {
        if(isInvalid(['g_name', 'g_prod', 'g_price', 'g_phone'])) return;
        btn.disabled = true;
        navigator.geolocation.getCurrentPosition(p => {
            fetch(API+'/save-goods', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
                name: v('g_name'), product: v('g_prod'), price: v('g_price'), phone: v('g_phone'),
                lat: p.coords.latitude, lon: p.coords.longitude, device_token: myToken
            })}).then(() => { alert("–¢–∞—É–∞—Ä —Ç–µ–∫—Å–µ—Ä—ñ–ª—É–¥–µ!"); location.reload(); });
        }, () => { btn.disabled = false; });
    }

    function v(id) { return document.getElementById(id).value; }

    // –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨
    async function loadAdmin() {
        const res = await fetch(API+'/admin/pending');
        const data = await res.json();
        const list = Array.isArray(data) ? data : [];
        let html = `<table class="admin-table"><tr><th>–ö“Ø–Ω—ñ</th><th>–ê—Ç—ã/–¢–µ–ª</th><th>–ê“õ–ø–∞—Ä–∞—Ç</th><th>–¢”©–ª–µ–º —Å–æ–º–∞—Å—ã</th><th>”ò—Ä–µ–∫–µ—Ç</th></tr>`;
        list.forEach(i => {
            html += `<tr>
                <td>${i.date_text}</td>
                <td>${i.name}<br>${i.phone}</td>
                <td>${i.info}</td>
                <td style="color:red; font-weight:bold;">${i.payment_info}</td>
                <td><button onclick="act('${i.id}','${i.type}')" style="background:green; padding:5px;">‚úÖ –†–∞—Å—Ç–∞—É</button></td>
            </tr>`;
        });
        document.getElementById('admin-list').innerHTML = list.length ? html + '</table>' : '–ñ–∞“£–∞ ”©—Ç—ñ–Ω—ñ–º –∂–æ“õ.';
    }

    async function act(id, type) {
        await fetch(API+'/admin/activate', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, type}) });
        loadAdmin();
    }

    window.onhashchange = () => {
        if(window.location.hash === "#admin777") {
            const p = prompt("Pass:");
            if(p === "admin777") { document.getElementById('admin-modal').style.display='block'; loadAdmin(); }
        } else { document.getElementById('admin-modal').style.display='none'; }
    };
    if(window.location.hash === "#admin777") window.onhashchange();
</script>
</body>
</html>
