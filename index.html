<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root { --blue: #007bff; --gold: #ffd700; --red: #dc3545; --green: #28a745; }
        body { font-family: sans-serif; margin: 0; background: #f8f9fa; }
        #map { height: 45vh; width: 100%; transition: filter 0.4s; }
        .grayscale { filter: grayscale(100%); }
        .header-box { padding: 10px; background: white; text-align: center; border-bottom: 1px solid #ddd; }
        .card { background: white; padding: 10px; margin: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        .contact-item { background: #eef2f7; padding: 4px 8px; margin: 3px 0; border-radius: 4px; font-size: 13px; border-left: 3px solid var(--blue); }
        .btn-del { background: var(--red); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; float: right; }
        .admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10000; padding:20px; overflow-y:auto; }
        .online-mark { color: var(--green); font-size: 10px; font-weight: bold; }
        input, select { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; }
        .v-list { height: 25vh; overflow-y: auto; background: #fff; border-top: 2px solid #eee; }
    </style>
</head>
<body>

<div class="header-box">
    <button onclick="toggleMap()">üåì –¢“Ø—Å—Ç—ñ/–ê“õ-“õ–∞—Ä–∞</button>
    <input type="text" id="searchInput" placeholder="üîç –Ü–∑–¥–µ—É (–ú–∞–º–∞–Ω–¥—ã“õ, —Ç–∞—É–∞—Ä, –±”©–ª—ñ–º...)" oninput="filterMarkers()">
    <select id="catFilter" onchange="filterMarkers()"><option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option></select>
</div>

<div id="map"></div>

<div class="v-list">
    <div style="padding:10px; font-weight:bold; background:#f0f0f0;">üìç –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞: (<span id="item-count">0</span>)</div>
    <div id="list-content"></div>
</div>

<div class="card">
    <h4>üì¢ –•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É –∂–∞—Ä–∏—è–ª–∞—É</h4>
    <select id="p_type"><option value="“ö—ã–∑–º–µ—Ç">üë∑ “ö—ã–∑–º–µ—Ç (–ú–∞–º–∞–Ω–¥—ã“õ)</option><option value="–¢–∞—É–∞—Ä">üì¶ –¢–∞—É–∞—Ä (–°–∏–ø–∞—Ç—Ç–∞–º–∞)</option><option value="–¢–∞–ø—Å—ã—Ä—ã—Å">üõí –¢–∞–ø—Å—ã—Ä—ã—Å (–ë”©–ª—ñ–º)</option></select>
    <input id="p_name" placeholder="–ê—Ç—ã“£—ã–∑ (–º–∏–Ω. 2 —Ç–∞“£–±–∞)">
    <input id="p_job" placeholder="–ù–µ–≥—ñ–∑–≥—ñ –∞“õ–ø–∞—Ä–∞—Ç (–º–∞–º–∞–Ω–¥—ã“õ/—Ç–∞—É–∞—Ä)">
    <div id="c_list"><div class="c-row" style="display:flex;gap:5px;"><select class="ct" style="width:30%"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option></select><input class="cv" style="width:70%" placeholder="–î–µ—Ä–µ–∫"></div></div>
    <button onclick="addCRow()" style="width:auto;font-size:12px;">+ –ë–∞–π–ª–∞–Ω—ã—Å</button>
    <div style="display:flex; gap:5px; margin-top:10px;">
        <button onclick="send(false)" style="background:var(--green);color:white;flex:1;border:none;padding:10px;">–¢–µ–≥—ñ–Ω (–õ–µ–∑–¥–µ)</button>
        <button onclick="send(true)" style="background:var(--blue);color:white;flex:1;border:none;padding:10px;">üíé VIP (–¢”©–ª–µ–º–º–µ–Ω)</button>
    </div>
</div>

<div id="adminPanel" class="admin-modal">
    <button onclick="closeAdmin()" style="float:right;background:var(--red);color:white;">–ñ–∞–±—É</button>
    <h3>üõ° –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h3>
    <div id="admin-data"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
    const API = "https://sk-joba.onrender.com";
    let myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    let map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let markers = [];
    let rawData = [];
    let isAdmin = location.hash === "#admin777";

    // 1. –í–ê–õ–ò–î–ê–¶–ò–Ø (12 —Ç–∞“£–±–∞ —Ç–µ–ª, @ email, 2 —Ç–∞“£–±–∞ –º”ô—Ç—ñ–Ω)
    function check(t, v) {
        if (t === '–¢–µ–ª') return /^\+7\d{10}$/.test(v.replace(/\s+/g, ''));
        if (t === 'Email') return v.includes('@') && v.includes('.');
        return v.trim().length >= 2;
    }

    function toggleMap() { document.getElementById('map').classList.toggle('grayscale'); }
    function addCRow() { document.getElementById('c_list').innerHTML += `<div class="c-row" style="display:flex;gap:5px;margin-top:5px;"><select class="ct" style="width:30%"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option></select><input class="cv" style="width:70%" placeholder="–î–µ—Ä–µ–∫"></div>`; }

    // 2. –ñ–ê–†–ò–Ø–õ–ê–£ (GPS –ü–ï–ù VIP –¢–ï–ö–°–ï–†–£)
    function send(isVip) {
        const n = document.getElementById('p_name').value;
        const j = document.getElementById('p_job').value;
        const type = document.getElementById('p_type').value;
        if (!check('M', n) || !check('M', j)) return alert("–ê—Ç—ã –º–µ–Ω –∞“õ–ø–∞—Ä–∞—Ç 2 —Ç–∞“£–±–∞–¥–∞–Ω –∫–µ–º –±–æ–ª–º–∞—Å—ã–Ω!");

        let c = [];
        document.querySelectorAll('.c-row').forEach(r => {
            let ct = r.querySelector('.ct').value, cv = r.querySelector('.cv').value;
            if (check(ct, cv)) c.push({type: ct, val: cv});
        });
        if (c.length === 0) return alert("–ë–∞–π–ª–∞–Ω—ã—Å –¥–µ—Ä–µ–≥—ñ “õ–∞—Ç–µ! (–¢–µ–ª: +77...)");

        if (isVip) alert("VIP –¢”©–ª–µ–º: 1000 ‚Ç∏. –¢”©–ª–µ–º–Ω–µ–Ω –∫–µ–π—ñ–Ω –∞–¥–º–∏–Ω –º–∞“õ“±–ª–¥–∞–π–¥—ã.");

        navigator.geolocation.getCurrentPosition(pos => {
            fetch(API + '/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name:n, job:j, type, is_vip:isVip, lat:pos.coords.latitude, lon:pos.coords.longitude, contacts:JSON.stringify(c), token:myToken})
            }).then(() => { alert("–ñ—ñ–±–µ—Ä—ñ–ª–¥—ñ!"); loadData(); });
        }, () => alert("GPS “õ–æ—Å—ã“£—ã–∑!"));
    }

    // 3. –ú”ò–õ–Ü–ú–ï–¢–¢–ï–†–î–Ü –ö”®–†–°–ï–¢–£ (24 –°–ê“í–ê–¢ –¢–ï–ö–°–ï–†–Ü–°–Ü)
    function loadData() {
        fetch(API + '/get-all').then(r => r.json()).then(data => {
            rawData = Array.isArray(data) ? data : [];
            updateCats(); filterMarkers();
        }).catch(e => console.error("JSON “õ–∞—Ç–µ—Å—ñ:", e));
    }

    function updateCats() {
        let s = document.getElementById('catFilter');
        let cats = [...new Set(rawData.map(i => i.job))];
        s.innerHTML = '<option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option>';
        cats.forEach(c => s.innerHTML += `<option value="${c}">${c}</option>`);
    }

    function filterMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        let lH = "", count = 0, now = Date.now();
        let search = document.getElementById('searchInput').value.toLowerCase();
        let cat = document.getElementById('catFilter').value;
        let b = map.getBounds();

        rawData.forEach(i => {
            // 24 —Å–∞“ì–∞—Ç—Ç—ã“õ —Ç–µ–∫—Å–µ—Ä—ñ—Å
            if ((now - new Date(i.created_at).getTime()) / 3600000 > 24) return;

            let isOn = (now - (i.last_ping || 0)) < 300000;
            let isOwn = i.token === myToken;

            // –ö”©—Ä—ñ–Ω—É –ª–æ–≥–∏–∫–∞—Å—ã
            if (!i.is_active && !i.is_vip && !isOn) return;
            if (i.is_vip && !i.is_active && !isAdmin && !isOwn) return;
            if (cat && i.job !== cat) return;
            if (search && !i.job.toLowerCase().includes(search) && !i.name.toLowerCase().includes(search)) return;

            const m = L.circleMarker([i.lat, i.lon], {color: i.is_vip ? 'gold' : 'blue', radius: 10}).addTo(map);
            
            // “ö–∞—Ç–µ–¥–µ–Ω —Å–∞“õ—Ç–∞–Ω—É: JSON.parse-—Ç—ã try-catch —ñ—à—ñ–Ω–¥–µ –∂–∞—Å–∞–π–º—ã–∑
            let cH = "";
            try {
                let cArr = JSON.parse(i.contacts);
                cH = cArr.map(c => `<div class="contact-item"><b>${c.type}:</b> ${c.val}</div>`).join('');
            } catch(e) { cH = "–î–µ—Ä–µ–∫ —Ñ–æ—Ä–º–∞—Ç—ã “õ–∞—Ç–µ"; }

            let dBtn = isOwn ? `<button class="btn-del" onclick="del(${i.id})">”®—à—ñ—Ä—É</button>` : "";
            m.bindPopup(`<b>${i.job}</b><br><small>${i.name}</small> ${isOn ? '<span class="online-mark">‚óè –æ–Ω–ª</span>' : ''}<hr>${cH}${dBtn}`);
            markers.push(m);

            if (b.contains([i.lat, i.lon])) {
                count++;
                lH += `<div class="card"><b>${i.job}</b><br>${cH}${dBtn}</div>`;
            }
        });
        document.getElementById('item-count').innerText = count;
        document.getElementById('list-content').innerHTML = lH;
    }

    function del(id) { if(confirm("”®—à—ñ—Ä—É?")) fetch(API+'/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,token:myToken})}).then(loadData); }
    function closeAdmin() { document.getElementById('adminPanel').style.display='none'; }
    if(isAdmin) { 
        setInterval(() => {
            let h = "";
            rawData.forEach(i => h += `<div class="card"><b>${i.job}</b> [${new Date(i.created_at).toLocaleString()}]<br>–°—Ç–∞—Ç—É—Å: ${i.is_active?'–ê–∫—Ç–∏–≤':'–ö“Ø—Ç—É–¥–µ'}<br><button onclick="tgl(${i.id},${!i.is_active})">“ö–æ—Å—É/VIP</button><button onclick="del(${i.id})">–ñ–æ—é</button></div>`);
            document.getElementById('admin-data').innerHTML = h;
        }, 2000);
        document.body.innerHTML += `<button onclick="document.getElementById('adminPanel').style.display='block'" style="position:fixed;bottom:5px;right:5px;opacity:0.5;">üõ°</button>`;
    }
    function tgl(id,a) { fetch(API+'/admin-toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,active:a,pass:"admin777"})}).then(loadData); }

    setInterval(() => fetch(API+'/ping',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:myToken})}), 30000);
    map.on('moveend', filterMarkers);
    loadData();
</script>
</body>
</html>
