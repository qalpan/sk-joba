<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba | –¢”©–ª–µ–º –∂”ô–Ω–µ –ö–∞—Ä—Ç–∞</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 50vh; width: 100%; border-bottom: 2px solid #007bff; background: #eee; }
        .search-box { padding: 10px; background: white; text-align: center; }
        .search-box input { width: 90%; padding: 12px; border-radius: 25px; border: 2px solid #007bff; outline: none; }
        .container { padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, select, textarea, button { width: 100%; margin: 5px 0; padding: 12px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 14px; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #0056b3; }
        #admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto; }
        
        /* –ú–∞—Ä–∫–µ—Ä “Ø—Å—Ç—ñ–Ω–¥–µ–≥—ñ —Ç“±—Ä–∞“õ—Ç—ã –∂–∞–∑—É —Å—Ç–∏–ª—ñ */
        .marker-label {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #007bff;
            border-radius: 4px;
            padding: 2px 5px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div class="search-box">
    <input type="text" id="searchInput" placeholder="–Ü–∑–¥–µ—É (“ö—ã–∑–º–µ—Ç, –¢–∞—É–∞—Ä, –¢–∞–ø—Å—ã—Ä—ã—Å)..." oninput="filterMarkers()">
</div>

<div id="map"></div>

<div id="admin-modal">
    <button onclick="window.location.hash=''" style="background:red; width:100px; color:white;">‚ùå –ñ–∞–±—É</button>
    <h2>–¢”©–ª–µ–º–¥–µ—Ä–¥—ñ —Ä–∞—Å—Ç–∞—É</h2>
    <div id="admin-list"></div>
</div>

<div class="container">
    <div class="card">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç (–ê“õ—ã–ª—ã)</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ (–º—ã—Å: –°–∞–Ω—Ç–µ—Ö–Ω–∏–∫)">
        <input id="w_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (8700...)">
        <select id="w_dur">
            <option value="1">1 —Å–∞“ì–∞—Ç ‚Äî 49‚Ç∏</option>
            <option value="24">1 —Ç”ô—É–ª—ñ–∫ ‚Äî 490‚Ç∏</option>
        </select>
        <button onclick="saveItem('worker')">–¢”©–ª–µ–º –∂–∞—Å–∞–ø —Ç—ñ—Ä–∫–µ–ª—É</button>
    </div>

    <div class="card">
        <h4>üì¶ –¢–∞—É–∞—Ä (–ê“õ—ã–ª—ã)</h4>
        <input id="g_name" placeholder="–°–∞—Ç—É—à—ã –∞—Ç—ã">
        <input id="g_prod" placeholder="–¢–∞—É–∞—Ä –∞—Ç—ã">
        <input id="g_price" placeholder="–ë–∞“ì–∞—Å—ã">
        <input id="g_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <select id="g_dur">
            <option value="1">1 —Å–∞“ì–∞—Ç ‚Äî 49‚Ç∏</option>
            <option value="24">1 —Ç”ô—É–ª—ñ–∫ ‚Äî 490‚Ç∏</option>
        </select>
        <button onclick="saveItem('good')" style="background:#ffc107; color:black;">–¢”©–ª–µ–º –∂–∞—Å–∞–ø –∂–∞—Ä–∏—è–ª–∞—É</button>
    </div>

    <div class="card">
        <h4>üìã –¢–∞–ø—Å—ã—Ä—ã—Å (–¢–µ–≥—ñ–Ω)</h4>
        <input id="c_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <textarea id="c_desc" placeholder="–ù–µ “õ–∞–∂–µ—Ç?"></textarea>
        <input id="c_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <button onclick="saveItem('order')" style="background:#28a745;">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
    const API = "https://sk-joba.onrender.com";
    const KASPI_PHONE = "7017398309"; // –¢–µ–∫ —Å–∞–Ω–¥–∞—Ä
    const ADMIN_EMAIL = "sk-joba@outlook.com";

    const myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markersGroup = L.markerClusterGroup();
    map.addLayer(markersGroup);

    setTimeout(() => map.invalidateSize(), 500);

    let allData = { workers: [], goods: [], orders: [] };

    function v(id){ return document.getElementById(id).value.trim(); }

    function saveItem(type) {
        let d = {}, path = '';
        if(type==='worker'){ path='/save-worker'; d={name:v('w_name'), job:v('w_job'), phone:v('w_phone'), durationHours:v('w_dur')}; }
        if(type==='good'){ path='/save-goods'; d={name:v('g_name'), product:v('g_prod'), price:v('g_price'), phone:v('g_phone'), durationHours:v('g_dur')}; }
        if(type==='order'){ path='/save-order'; d={name:v('c_name'), description:v('c_desc'), phone:v('c_phone')}; }

        if(!d.phone) return alert("–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ–Ω —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑!");

        navigator.geolocation.getCurrentPosition(p => {
            d.lat=p.coords.latitude; d.lon=p.coords.longitude; d.device_token=myToken;
            
            fetch(API+path, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)})
            .then(() => {
                if(type === 'order') {
                    alert("–¢–∞–ø—Å—ã—Ä—ã—Å —Å”ô—Ç—Ç—ñ –∂–∞—Ä–∏—è–ª–∞–Ω–¥—ã!");
                } else {
                    const amount = d.durationHours === "1" ? "49" : "490";
                    
                    // –ö–ª–∏–µ–Ω—Ç–∫–µ —Ç“Ø—Å—ñ–Ω—ñ–∫—Ç—ñ –Ω“±—Å“õ–∞—É–ª—ã“õ
                    const confirmPayment = confirm(
                        `–ù“∞–°“ö–ê–£–õ–´“ö:\n\n` +
                        `1. “ö–∞–∑—ñ—Ä Kaspi –∞—à—ã–ª–∞–¥—ã.\n` +
                        `2. –ù”©–º—ñ—Ä–≥–µ: ${KASPI_PHONE} —Å–æ–º–∞–Ω—ã (${amount}‚Ç∏) –∞—É–¥–∞—Ä—ã“£—ã–∑.\n` +
                        `3. –¢”©–ª–µ–º–Ω–µ–Ω –∫–µ–π—ñ–Ω Email –∞—Ä“õ—ã–ª—ã —á–µ–∫ –∂—ñ–±–µ—Ä—ñ“£—ñ–∑.\n\n` +
                        `Kaspi-–≥–µ ”©—Ç—É–¥—ñ —Ä–∞—Å—Ç–∞–π—Å—ã–∑ –±–∞?`
                    );

                    if(confirmPayment) {
                        // –¢—ñ–∫–µ–ª–µ–π –∞—É–¥–∞—Ä—ã–º –±–µ—Ç—ñ–Ω–µ —Å—ñ–ª—Ç–µ–º–µ
                        window.open(`https://kaspi.kz/pay/Transfer?phone=${KASPI_PHONE}`, '_blank');
                        
                        setTimeout(() => {
                            const subject = encodeURIComponent(`SK-Joba –¢”©–ª–µ–º: ${d.phone}`);
                            const body = encodeURIComponent(`–°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ! –¢”©–ª–µ–º –∂–∞—Å–∞–¥—ã–º (${amount}‚Ç∏). –ú–µ–Ω—ñ“£ –Ω”©–º—ñ—Ä—ñ–º: ${d.phone}. –ß–µ–∫ —Ç—ñ—Ä–∫–µ–ª–¥—ñ.`);
                            window.location.href = `mailto:${ADMIN_EMAIL}?subject=${subject}&body=${body}`;
                        }, 5000);
                    }
                }
                loadMarkers();
            });
        }, () => alert("GPS-—Ç—ñ “õ–æ—Å—ã“£—ã–∑!"));
    }

    function loadMarkers() {
        fetch(API+'/get-all').then(r => r.json()).then(data => {
            allData = data;
            filterMarkers();
        });
    }

    function filterMarkers() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        markersGroup.clearLayers();
        
        allData.workers.forEach(w => { 
            if(w.job.toLowerCase().includes(term)) addM(w.lat, w.lon, `üë∑ ${w.job}<br>–ê—Ç—ã: ${w.name}<br>–¢–µ–ª: ${w.phone}`, w.job, w.id, 'worker', w.device_token, '#007bff'); 
        });
        allData.goods.forEach(g => { 
            if(g.product_name.toLowerCase().includes(term)) addM(g.lat, g.lon, `üì¶ ${g.product_name}<br>–ë–∞“ì–∞—Å—ã: ${g.price}‚Ç∏<br>–¢–µ–ª: ${g.phone}`, g.product_name, g.id, 'good', g.device_token, '#ffc107'); 
        });
        allData.orders.forEach(o => { 
            if(o.description.toLowerCase().includes(term)) addM(o.lat, o.lon, `üìã ${o.description}<br>–¢–µ–ª: ${o.phone}`, o.description, o.id, 'order', o.device_token, '#28a745'); 
        });
    }

    function addM(lat, lon, txt, mini, id, type, token, color) {
        // –î–∏–Ω–∞–º–∏–∫–∞–ª—ã“õ –º–∞—Ä–∫–µ—Ä (–Ω“Ø–∫—Ç–µ)
        const icon = L.divIcon({
            html: `<div style="background:${color};width:14px;height:14px;border-radius:50%;border:2px solid white;box-shadow:0 0 4px rgba(0,0,0,0.4);"></div>`,
            className: ''
        });
        
        const m = L.marker([lat, lon], {icon});
        const delBtn = token === myToken ? `<br><button onclick="delItem(${id},'${type}')" style="background:red;color:white;border:none;margin-top:5px;width:100%;padding:4px;font-size:10px;">”®—à—ñ—Ä—É ‚ùå</button>` : "";
        
        m.bindPopup(txt + delBtn);

        // –ú–ò–ù–ò-–ê“ö–ü–ê–†–ê–¢ (”ò—Ä“õ–∞—à–∞–Ω –º–∞—Ä–∫–µ—Ä–¥—ñ“£ “Ø—Å—Ç—ñ–Ω–¥–µ –∫”©—Ä—ñ–Ω—ñ–ø —Ç“±—Ä–∞–¥—ã)
        m.bindTooltip(mini, {
            permanent: true, 
            direction: 'top', 
            offset: [0, -10],
            className: 'marker-label'
        });

        markersGroup.addLayer(m);
    }

    function delItem(id, type, admin=false) {
        if(!confirm("–ë“±–ª —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–¥—ã ”©—à—ñ—Ä–µ—Å—ñ–∑ –±–µ?")) return;
        fetch(API+'/delete-item', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, type, token: admin ? 'ADMIN' : myToken})})
        .then(() => admin ? loadAdmin() : loadMarkers());
    }

    window.onhashchange = () => {
        if(location.hash === "#admin777") {
            const p = prompt("–ê–¥–º–∏–Ω –ø–∞—Ä–æ–ª—å:");
            if(p === "admin777") { document.getElementById('admin-modal').style.display='block'; loadAdmin(); }
        } else { document.getElementById('admin-modal').style.display='none'; }
    };

    function loadAdmin() {
        fetch(API+'/admin/pending').then(r => r.json()).then(list => {
            let h = `<table border="1" style="width:100%; border-collapse:collapse; font-size:12px;"><tr><th>–ò–Ω—Ñ–æ</th><th>–ê“õ—ã—Å—ã</th><th>”ò—Ä–µ–∫–µ—Ç</th></tr>`;
            list.forEach(i => {
                h += `<tr><td>${i.info}<br>${i.phone}</td><td style="color:red; font-weight:bold">${i.fee}</td><td><button onclick="act(${i.id},'${i.type}')">‚úÖ “ö–æ—Å</button></td></tr>`;
            });
            document.getElementById('admin-list').innerHTML = list.length ? h + "</table>" : "–ö“Ø—Ç—É–¥–µ–≥—ñ —Ç”©–ª–µ–º–¥–µ—Ä –∂–æ“õ.";
        });
    }

    function act(id, type) {
        fetch(API+'/admin/activate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, type})}).then(() => loadAdmin());
    }

    setInterval(loadMarkers, 30000);
    loadMarkers();
</script>
</body>
</html>
