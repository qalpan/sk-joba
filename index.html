<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba | Marketplace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 45vh; width: 100%; }
        .container { padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, select, textarea, button { width: 100%; margin: 5px 0; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .invalid { border: 2px solid red !important; }
        #admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto; }
        .admin-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="container">
    <div class="card" id="form-worker">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç “±—Å—ã–Ω—É</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑ (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <input id="w_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <select id="w_dur"><option value="1">1 —Å–∞“ì–∞—Ç (49—Ç–≥)</option><option value="24">1 —Ç”ô—É–ª—ñ–∫ (490—Ç–≥)</option></select>
        <button onclick="saveWorker(this)">–¢—ñ—Ä–∫–µ–ª—É</button>
    </div>

    <div class="card" id="form-good">
        <h4>üì¶ –¢–∞—É–∞—Ä —Å–∞—Ç—É</h4>
        <input id="g_name" placeholder="–ê—Ç—ã“£—ã–∑ (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <input id="g_prod" placeholder="–¢–∞—É–∞—Ä –∞—Ç—ã (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <input id="g_price" placeholder="–ë–∞“ì–∞—Å—ã (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <input id="g_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <button onclick="saveGoods(this)">–¢–∞—É–∞—Ä–¥—ã “õ–æ—Å—É</button>
    </div>

    <div class="card" id="form-order">
        <h4>üìã –¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É</h4>
        <input id="c_name" placeholder="–ê—Ç—ã“£—ã–∑ (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <textarea id="c_desc" placeholder="–ù–µ “õ–∞–∂–µ—Ç? (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)"></textarea>
        <input id="c_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–ú—ñ–Ω–¥–µ—Ç—Ç—ñ)">
        <button onclick="saveOrder(this)">–ñ–∞—Ä–∏—è–ª–∞—É</button>
    </div>
</div>

<div id="admin-modal">
    <button onclick="closeAdmin()" style="width:auto; float:right; background:#333;">‚ùå –ñ–∞–±—É</button>
    <h3>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å: –¢”©–ª–µ–º–¥–µ—Ä</h3>
    <div id="admin-content">–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
    const API = "https://sk-joba.onrender.com";
    const myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // “ö–ê–¢–ê“¢ –í–ê–õ–ò–î–ê–¶–ò–Ø –§–£–ù–ö–¶–ò–Ø–°–´
    function validateForm(fields) {
        let isValid = true;
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (!el.value.trim()) {
                el.classList.add('invalid');
                isValid = false;
            } else {
                el.classList.remove('invalid');
            }
        });
        if(!isValid) alert("“ö—ã–∑—ã–ª–º–µ–Ω –±–µ–ª–≥—ñ–ª–µ–Ω–≥–µ–Ω –∂–æ–ª–¥–∞—Ä–¥—ã —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑!");
        return isValid;
    }

    function saveWorker(btn) {
        if (!validateForm(['w_name', 'w_job', 'w_phone'])) return; // –ë–æ—Å –±–æ–ª—Å–∞ —Ç–æ“õ—Ç–∞—Ç–∞–¥—ã
        btn.disabled = true;
        navigator.geolocation.getCurrentPosition(p => {
            const data = { name: v('w_name'), job: v('w_job'), phone: v('w_phone'), durationHours: v('w_dur'), lat: p.coords.latitude, lon: p.coords.longitude, device_token: myToken };
            post('/save-worker', data, btn);
        }, () => { alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è—Å—ã–∑ —Ç—ñ—Ä–∫–µ–ª—É –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å!"); btn.disabled = false; });
    }

    function saveGoods(btn) {
        if (!validateForm(['g_name', 'g_prod', 'g_price', 'g_phone'])) return;
        btn.disabled = true;
        navigator.geolocation.getCurrentPosition(p => {
            const data = { name: v('g_name'), product: v('g_prod'), price: v('g_price'), phone: v('g_phone'), durationHours: 24, lat: p.coords.latitude, lon: p.coords.longitude, device_token: myToken };
            post('/save-goods', data, btn);
        }, () => { btn.disabled = false; });
    }

    function saveOrder(btn) {
        if (!validateForm(['c_name', 'c_desc', 'c_phone'])) return;
        btn.disabled = true;
        navigator.geolocation.getCurrentPosition(p => {
            const data = { name: v('c_name'), description: v('c_desc'), phone: v('c_phone'), lat: p.coords.latitude, lon: p.coords.longitude, device_token: myToken };
            post('/save-order', data, btn);
        }, () => { btn.disabled = false; });
    }

    function post(path, data, btn) {
        fetch(API + path, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })
        .then(res => {
            if(!res.ok) throw new Error();
            alert("–°”ô—Ç—Ç—ñ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ! –ê–¥–º–∏–Ω —Ä–∞—Å—Ç–∞—É—ã–Ω –∫“Ø—Ç—ñ“£—ñ–∑.");
            location.reload();
        })
        .catch(() => {
            alert("–°–µ—Ä–≤–µ—Ä–¥–µ “õ–∞—Ç–µ! “ö–∞–π—Ç–∞ –∫”©—Ä—ñ“£—ñ–∑.");
            btn.disabled = false;
        });
    }

    function v(id) { return document.getElementById(id).value; }

    // –ê–î–ú–ò–ù –õ–û–ì–ò–ö–ê–°–´ (HASH –¢–ï–ö–°–ï–†–£)
    function handleAdmin() {
        if (window.location.hash === "#admin777") {
            const pass = prompt("“ö“±–ø–∏—è—Å”©–∑:");
            if (pass === "admin777") {
                document.getElementById('admin-modal').style.display = 'block';
                loadAdmin();
            } else {
                alert("“ö–∞—Ç–µ!");
                window.location.hash = "";
            }
        } else {
            document.getElementById('admin-modal').style.display = 'none';
        }
    }

    window.addEventListener('hashchange', handleAdmin);
    window.addEventListener('load', handleAdmin);

    function closeAdmin() { window.location.hash = ""; }

    function loadAdmin() {
        const cont = document.getElementById('admin-content');
        cont.innerHTML = "–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...";
        fetch(API + '/admin/pending')
        .then(res => res.json())
        .then(list => {
            if(!list.length) { cont.innerHTML = "–ñ–∞“£–∞ ”©—Ç—ñ–Ω—ñ–º –∂–æ“õ."; return; }
            let h = `<table class="admin-table"><tr><th>–ö“Ø–Ω—ñ</th><th>–ê—Ç—ã</th><th>–¢–∞—Ä–∏—Ñ</th><th>”ò—Ä–µ–∫–µ—Ç</th></tr>`;
            list.forEach(i => {
                h += `<tr><td>${i.date_text}</td><td>${i.name}<br>${i.phone}</td><td>${i.duration}</td>
                <td><button onclick="activate('${i.id}','${i.type}')" style="padding:5px;">‚úÖ –†–∞—Å—Ç–∞—É</button></td></tr>`;
            });
            cont.innerHTML = h + `</table>`;
        });
    }

    function activate(id, type) {
        fetch(API + '/admin/activate', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id, type}) })
        .then(() => loadAdmin());
    }
</script>
</body>
</html>
