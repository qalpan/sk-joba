<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba: Super System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root { --blue: #007bff; --gold: #ffd700; --red: #dc3545; --green: #28a745; --dark: #343a40; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; height: 100%; background: #f0f2f5; }
        
        /* 2. –ö–∞—Ä—Ç–∞ —Ä–µ–∂–∏–º–¥–µ—Ä—ñ */
        #map { height: 45vh; width: 100%; background: #e0e0e0; border-bottom: 3px solid var(--blue); }
        .grayscale { filter: grayscale(100%) invert(10%) contrast(90%); }
        
        .ui-panel { padding: 10px; background: white; }
        .search-box { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        
        /* 5 & 6. –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞ —Ç—ñ–∑—ñ–º—ñ */
        .v-list { height: 25vh; overflow-y: auto; background: white; border-top: 1px solid #ddd; }
        .card { background: white; padding: 12px; margin: 8px; border-radius: 8px; border-left: 5px solid var(--blue); box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        .card.vip { border-left-color: var(--gold); }
        
        .contact-item { background: #f8f9fa; padding: 4px 8px; margin: 3px 0; border-radius: 4px; font-size: 13px; border-left: 2px solid var(--blue); }
        
        /* –í–∞–ª–∏–¥–∞—Ü–∏—è–ª—ã“õ —Å—Ç–∏–ª—å–¥–µ—Ä */
        input, select, button { padding: 12px; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; font-size: 14px; }
        button { cursor: pointer; font-weight: bold; transition: 0.3s; }
        
        .admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10000; padding:20px; overflow-y:auto; }
        .btn-del { background: var(--red); color: white; border: none; padding: 5px 10px; border-radius: 4px; float: right; font-size: 11px; }
        .online-tag { color: var(--green); font-size: 11px; font-weight: bold; }
    </style>
</head>
<body>

<div class="ui-panel">
    <div class="search-box">
        <button onclick="toggleMap()" style="background: var(--dark); color: white;">üåì –¢“Ø—Å—Ç—ñ / –ê“õ-“õ–∞—Ä–∞ –∫–∞—Ä—Ç–∞</button>
        <input type="text" id="searchInput" placeholder="üîç –Ü–∑–¥–µ—É (–ú–∞–º–∞–Ω–¥—ã“õ, —Ç–∞—É–∞—Ä, —Å–∏–ø–∞—Ç—Ç–∞–º–∞...)" oninput="filterMarkers()">
        <select id="catFilter" onchange="filterMarkers()"><option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option></select>
    </div>
</div>

<div id="map"></div>

<div class="v-list">
    <div style="padding:10px; font-weight:bold; background:#e9ecef; display:flex; justify-content:space-between;">
        <span>üìç –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞:</span>
        <span id="item-count" style="color:var(--blue)">0</span>
    </div>
    <div id="list-content"></div>
</div>

<div class="card" style="margin-bottom: 50px;">
    <h4>üìù –ñ–∞“£–∞ —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É</h4>
    <select id="p_type" onchange="updatePlaceholder()">
        <option value="“ö—ã–∑–º–µ—Ç">üë∑ “ö—ã–∑–º–µ—Ç “±—Å—ã–Ω—É (–ú–∞–º–∞–Ω–¥—ã“õ)</option>
        <option value="–¢–∞—É–∞—Ä">üì¶ –¢–∞—É–∞—Ä “±—Å—ã–Ω—É (–¢“Ø—Ä—ñ, —Å–∏–ø–∞—Ç—ã)</option>
        <option value="–¢–∞–ø—Å—ã—Ä—ã—Å">üõí –¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É (–ë”©–ª—ñ–º–¥–µ—Ä)</option>
    </select>
    <input id="p_name" placeholder="–ê—Ç—ã“£—ã–∑ (–º–∏–Ω. 2 —Ç–∞“£–±–∞)">
    <input id="p_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ –Ω–µ–º–µ—Å–µ –¢–∞—É–∞—Ä –∞—Ç—ã">
    
    <div id="c_list" style="margin-top: 10px;">
        <div class="c-row" style="display:flex; gap:5px; margin-bottom:5px;">
            <select class="ct" style="width:35%"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option></select>
            <input class="cv" style="width:65%" placeholder="–î–µ—Ä–µ–∫">
        </div>
    </div>
    <button onclick="addCRow()" style="background:#eee; color:#333; margin-top:5px; padding:5px;">+ –ë–∞–π–ª–∞–Ω—ã—Å</button>
    
    <div style="display:flex; gap:10px; margin-top:15px;">
        <button onclick="submitData(false)" style="background:var(--green); color:white; flex:1;">–¢–µ–≥—ñ–Ω (–õ–µ–∑–¥–µ)</button>
        <button onclick="submitData(true)" style="background:var(--gold); color:black; flex:1;">üíé VIP (–ê–¥–º–∏–Ω)</button>
    </div>
</div>

<div id="adminPanel" class="admin-modal">
    <div style="display:flex; justify-content:space-between;">
        <h3>üõ° –ë–∞—Å“õ–∞—Ä—É –ø–∞–Ω–µ–ª—ñ</h3>
        <button onclick="closeAdmin()" style="width:auto; background:var(--red); color:white;">–ñ–∞–±—É</button>
    </div>
    <div id="admin-data"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<script>
    const API = "https://sk-joba.onrender.com";
    let myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    let map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let markers = [];
    let rawData = [];
    let isAdmin = location.hash === "#admin777";

    // 1. –í–ê–õ–ò–î–ê–¶–ò–Ø (–¢–µ–ª 12 —Ç–∞“£–±–∞, Email @.)
    function validate(type, val) {
        val = val.trim();
        if (type === '–¢–µ–ª') return /^\+7\d{10}$/.test(val.replace(/\s+/g, ''));
        if (type === 'Email') return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
        return val.length >= 2;
    }

    function toggleMap() { document.getElementById('map').classList.toggle('grayscale'); }
    function addCRow() {
        const div = document.createElement('div');
        div.className = 'c-row'; div.style = "display:flex; gap:5px; margin-top:5px;";
        div.innerHTML = `<select class="ct" style="width:35%"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option></select><input class="cv" style="width:65%" placeholder="–î–µ—Ä–µ–∫">`;
        document.getElementById('c_list').appendChild(div);
    }

    // 3 & 4. –ñ–ê–†–ò–Ø–õ–ê–£ –õ–û–ì–ò–ö–ê–°–´
    async function submitData(isVip) {
        const name = document.getElementById('p_name').value;
        const job = document.getElementById('p_job').value;
        const type = document.getElementById('p_type').value;

        if (!validate('Text', name) || !validate('Text', job)) return alert("–ê—Ç—ã“£—ã–∑ –±–µ–Ω —Å–∏–ø–∞—Ç—Ç–∞–º–∞ 2 —Ç–∞“£–±–∞–¥–∞–Ω –∫–µ–º –±–æ–ª–º–∞—Å—ã–Ω!");

        let contacts = [];
        document.querySelectorAll('.c-row').forEach(row => {
            let t = row.querySelector('.ct').value, v = row.querySelector('.cv').value;
            if (validate(t, v)) contacts.push({type: t, val: v});
        });

        if (contacts.length === 0) return alert("–ë–∞–π–ª–∞–Ω—ã—Å –¥–µ—Ä–µ–≥—ñ “õ–∞—Ç–µ! (–¢–µ–ª: +7... 12 —Ç–∞“£–±–∞, Email: @ –º–µ–Ω .)");

        if (isVip) alert("VIP: –ê–¥–º–∏–Ω —Ç”©–ª–µ–º–¥—ñ —Ç–µ–∫—Å–µ—Ä–≥–µ–Ω —Å–æ“£ 24 —Å–∞“ì–∞—Ç“õ–∞ “õ–æ—Å–∞–¥—ã.");

        // –ñ–∞—Ä–∏—è–ª–∞–Ω“ì–∞–Ω –æ—Ä—ã–Ω “õ–∞—Ç–µ –±–æ–ª–º–∞—É—ã “Ø—à—ñ–Ω –∂–æ“ì–∞—Ä—ã –¥”ô–ª–¥—ñ–∫ (High Accuracy)
        navigator.geolocation.getCurrentPosition(async pos => {
            const body = {
                name, job, type, is_vip: isVip,
                lat: pos.coords.latitude, lon: pos.coords.longitude,
                contacts: JSON.stringify(contacts),
                token: myToken
            };
            await fetch(API + '/save', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            loadData();
        }, () => alert("GPS —Ä“±“õ—Å–∞—Ç –µ—Ç—ñ“£—ñ–∑!"), {enableHighAccuracy: true});
    }

    async function loadData() {
        try {
            const r = await fetch(API + '/get-all');
            rawData = await r.json();
            updateCategories();
            filterMarkers();
        } catch(e) { console.error("Data error"); }
    }

    function updateCategories() {
        const sel = document.getElementById('catFilter');
        const cats = [...new Set(rawData.map(i => i.job))].filter(Boolean);
        sel.innerHTML = '<option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option>';
        cats.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
    }

    // –ú–ê–†–ö–ï–†–õ–ï–† “ö–ê–ë–ê–¢–¢–ê–°–ü–ê–°–´ “Æ–®–Ü–ù (Jitter)
    function jitter(coord) { return coord + (Math.random() - 0.5) * 0.0003; }

    function filterMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        let listHtml = "", count = 0;
        const now = Date.now();
        const search = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('catFilter').value;
        const bounds = map.getBounds();

        rawData.forEach(i => {
            //
