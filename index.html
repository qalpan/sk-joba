<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞—Ä—Ç–∞ –•–∞–±–∞—Ä–ª–∞–º–∞ - SK Joba</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        /* –ú–æ–±–∏–ª—å–¥—ñ —Å—Ç–∏–ª—å–¥–µ—Ä */
        body { margin: 0; background: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 16px; }
        
        #map { height: 50vh; width: 100%; z-index: 1; } /* –ö–∞—Ä—Ç–∞ —ç–∫—Ä–∞–Ω–Ω—ã“£ –∂–∞—Ä—Ç—ã—Å—ã–Ω –∞–ª–∞–¥—ã */
        
        .container { padding: 15px; background: white; border-top-left-radius: 15px; border-top-right-radius: 15px; position: relative; top: -15px; z-index: 2; }

        .grayscale { filter: grayscale(1) brightness(0.8); }
        
        /* 5-—Ç–∞–ª–∞–ø: –ú–∏–Ω–∏ –∞“õ–ø–∞—Ä–∞—Ç —Å—Ç–∏–ª—ñ (—ñ—Ä—ñ—Ä–µ–∫ –∂–∞—Å–∞–ª–¥—ã) */
        .mini-label { 
            background: white; border: 1px solid #666; padding: 4px 8px; 
            border-radius: 5px; font-size: 12px; font-weight: bold; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); text-align: center; white-space: nowrap;
        }

        .card { border-left: 5px solid #007bff; padding: 15px; margin: 10px 0; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 8px; }
        .card.vip { border-left-color: gold; background: #fffef0; }
        
        /* –ë–∞—Ç—ã—Ä–º–∞–ª–∞—Ä –º–µ–Ω –∏–Ω–ø—É—Ç—Ç–∞—Ä —Å–∞—É—Å–∞“õ–ø–µ–Ω –±–∞—Å—É“ì–∞ —ã“£“ì–∞–π–ª—ã –±–æ–ª—É—ã “Ø—à—ñ–Ω “Ø–ª–∫–µ–π—Ç—ñ–ª–¥—ñ */
        input, select, button { 
            width: 100%; padding: 14px; margin-top: 10px; 
            border-radius: 8px; border: 1px solid #ccc; 
            font-size: 16px; box-sizing: border-box; 
        }
        
        /* –¢“Ø—Å ”©–∑–≥–µ—Ä—Ç—É –±–∞—Ç—ã—Ä–º–∞—Å—ã */
        .btn-toggle { background: #333; color: #fff; border: none; font-weight: bold; }
        
        .btn-post { background: #28a745; color: #fff; border: none; font-weight: bold; cursor: pointer; }
        .btn-vip { background: gold; color: #000; border: none; font-weight: bold; cursor: pointer; }
        .del-btn { background: #ff4d4d; color: white; border: none; padding: 8px 12px; font-size: 12px; cursor: pointer; float: right; border-radius: 4px; }

        #adminPanel { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:3000; padding:20px; overflow:auto; }
        
        /* Popup —ñ—à—ñ–Ω–¥–µ–≥—ñ –º”ô—Ç—ñ–Ω–¥—ñ “Ø–ª–∫–µ–π—Ç—É */
        .leaflet-popup-content { font-size: 14px; line-height: 1.5; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="container">
    <button onclick="document.getElementById('map').classList.toggle('grayscale')" class="btn-toggle">üåì –ö–∞—Ä—Ç–∞ —Ç“Ø—Å—ñ–Ω ”©–∑–≥–µ—Ä—Ç—É</button>

    <input type="text" id="search" placeholder="üîç –Ü–∑–¥–µ—É (–ú–∞–º–∞–Ω–¥—ã“õ, —Ç–∞—É–∞—Ä...)" oninput="render()">

    <h4 style="margin:15px 0 5px;">üìç –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞: (<span id="count">0</span>)</h4>
    <div id="list" style="max-height: 30vh; overflow-y: auto;"></div>

    <hr style="margin: 20px 0;">
    
    <h3 style="text-align:center;">üì¢ –•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É –±–µ—Ä—É</h3>
    <select id="p_type"><option>“ö—ã–∑–º–µ—Ç</option><option>–¢–∞—É–∞—Ä</option><option>–¢–∞–ø—Å—ã—Ä—ã—Å</option></select>
    <input id="p_name" placeholder="–°—ñ–∑–¥—ñ“£ –∞—Ç—ã“£—ã–∑ (–º–∏–Ω. 2 ”ô—Ä—ñ–ø)">
    <input id="p_job" placeholder="–ù–µ “±—Å—ã–Ω–∞—Å—ã–∑? (“ö—ã–∑–º–µ—Ç/–¢–∞—É–∞—Ä)">
    <input id="p_tel" type="tel" placeholder="–¢–µ–ª: +77001234567">
    <input id="p_email" type="email" placeholder="Email: example@mail.kz">
    
    <div style="display:flex; gap:10px; margin-top:10px;">
        <button onclick="saveAd(false)" class="btn-post">–¢–µ–≥—ñ–Ω (–õ–µ–∑–¥–µ)</button>
        <button onclick="saveAd(true)" class="btn-vip">üíé VIP (–ê–¥–º–∏–Ω)</button>
    </div>
</div>

<div id="adminPanel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>üõ° –ê–¥–º–∏–Ω</h2>
        <button onclick="location.hash=''" style="width:auto; background:#333; color:white;">–ñ–∞–±—É</button>
    </div>
    <div id="admin-table" style="overflow-x:auto;"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    const API = "https://sk-joba.onrender.com"; 
    let myToken = localStorage.getItem('token') || "U" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('token', myToken);

    let map = L.map('map', {zoomControl: false}).setView([43.2389, 76.8897], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let markerCluster = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        maxClusterRadius: 40 // –¢–µ–ª–µ—Ñ–æ–Ω–¥–∞ –∂–∏–Ω–∞“õ—ã –±–æ–ª—É “Ø—à—ñ–Ω
    });
    map.addLayer(markerCluster);

    let rawData = [];

    // 1-—Ç–∞–ª–∞–ø: –í–∞–ª–∏–¥–∞—Ü–∏—è
    function checkValid() {
        const n = document.getElementById('p_name').value.trim();
        const j = document.getElementById('p_job').value.trim();
        const t = document.getElementById('p_tel').value.trim();
        const e = document.getElementById('p_email').value.trim();

        if (n.length < 2 || j.length < 2) return alert("–ê—Ç—ã“£—ã–∑ –Ω–µ–º–µ—Å–µ –º”ô—Ç—ñ–Ω –∫–µ–º—ñ–Ω–¥–µ 2 —Ç–∞“£–±–∞!");
        if (!/^\+7\d{10}$/.test(t)) return alert("–¢–µ–ª –Ω”©–º—ñ—Ä—ñ “õ–∞—Ç–µ! +77001234567 —Ñ–æ—Ä–º–∞—Ç—ã–Ω–¥–∞ –∂–∞–∑—ã“£—ã–∑.");
        if (!e.includes('@') || !e.includes('.')) return alert("Email “õ–∞—Ç–µ! (@ –±–µ–ª–≥—ñ—Å—ñ –∫–µ—Ä–µ–∫)");
        return true;
    }

    function render() {
        markerCluster.clearLayers();
        let listH = "", count = 0;
        const search = document.getElementById('search').value.toLowerCase();
        const bounds = map.getBounds();

        rawData.forEach(i => {
            const isOwner = i.token === myToken;
            
            // 4-—Ç–∞–ª–∞–ø: VIP –±–æ–ª—Å–∞ –∂”ô–Ω–µ –ê–î–ú–ò–ù “ö–û–°–ü–ê–°–ê -> –¢–µ–∫ –∏–µ—Å—ñ–Ω–µ –∫”©—Ä—ñ–Ω–µ–¥—ñ
            if (i.is_vip && !i.is_active && !isOwner) return;
            
            // 3-—Ç–∞–ª–∞–ø: –¢–µ–≥—ñ–Ω –±–æ–ª—Å–∞ –∂”ô–Ω–µ –û–§–õ–ê–ô–ù –±–æ–ª—Å–∞ -> –¢–µ–∫ –∏–µ—Å—ñ–Ω–µ –∫”©—Ä—ñ–Ω–µ–¥—ñ
            if (!i.is_vip && !i.is_online && !isOwner) return;

            // 7-—Ç–∞–ª–∞–ø: –Ü–∑–¥–µ—É
            if (search && !i.job.toLowerCase().includes(search) && !i.name.toLowerCase().includes(search)) return;

            // 5-—Ç–∞–ª–∞–ø: –ú–∏–Ω–∏ –∞“õ–ø–∞—Ä–∞—Ç
            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="mini-label" style="border-left: 4px solid ${i.is_vip?'gold':'blue'}">${i.job.substring(0,12)}..</div>`,
                iconSize: [100, 30], iconAnchor: [50, 0]
            });

            const m = L.marker([i.lat, i.lon], {icon: icon});
            
            let statusText = "";
            if(i.is_vip && !i.is_active) statusText = "<br><b style='color:orange'>‚è≥ –¢–µ–∫—Å–µ—Ä—ñ–ª—É–¥–µ...</b>";
            
            m.bindPopup(`<b>${i.name}</b>${statusText}<br>${i.job}<br><a href="tel:${i.tel}" style="font-size:14px; font-weight:bold;">üìû ${i.tel}</a><br>üìß ${i.email}`);
            markerCluster.addLayer(m);

            if (bounds.contains([i.lat, i.lon])) {
                count++;
                listH += `<div class="card ${i.is_vip?'vip':''}">
                    ${isOwner ? `<button onclick="deleteAd(${i.id})" class="del-btn">”®—à—ñ—Ä—É</button>` : ''}
                    <b>${i.job}</b> <small>(${i.type})</small> ${i.is_online ? 'üü¢' : '‚ö™'}<br>
                    <small>üìû ${i.tel}</small>
                    ${i.is_vip && !i.is_active ? '<br><small style="color:red">–ê–¥–º–∏–Ω —Ä“±“õ—Å–∞—Ç—ã–Ω –∫“Ø—Ç—É–¥–µ (–±–∞—Å“õ–∞–ª–∞—Ä“ì–∞ –∫”©—Ä—ñ–Ω–±–µ–π–¥—ñ)</small>' : ''}
                </div>`;
            }
        });
        document.getElementById('count').innerText = count;
        document.getElementById('list').innerHTML = listH;
    }

    async function saveAd(isVip) {
        if (!checkValid()) return;
        if (isVip && !confirm("VIP –∂–∞—Ä–∏—è–ª–∞—É –∞“õ—ã–ª—ã. –¢”©–ª–µ–º —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞–Ω—ã—Å –∂—ñ–±–µ—Ä—ñ–ª—Å—ñ–Ω –±–µ?")) return;

        navigator.geolocation.getCurrentPosition(async (p) => {
            const body = {
                name: document.getElementById('p_name').value,
                job: document.getElementById('p_job').value,
                type: document.getElementById('p_type').value,
                tel: document.getElementById('p_tel').value,
                email: document.getElementById('p_email').value,
                lat: p.coords.latitude,
                lon: p.coords.longitude,
                is_vip: isVip,
                token: myToken
            };
            await fetch(API + '/save', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            alert(isVip ? "VIP —Å“±—Ä–∞–Ω—ã—Å—ã –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ. –ê–¥–º–∏–Ω —Ä–∞—Å—Ç–∞“ì–∞–Ω —Å–æ“£ –∫–∞—Ä—Ç–∞–¥–∞ –±–∞—Ä—à–∞“ì–∞ –∫”©—Ä—ñ–Ω–µ–¥—ñ." : "–ñ–∞—Ä–∏—è–ª–∞–Ω–¥—ã!");
            load();
        }, () => alert("GPS “õ–æ—Å—ã“£—ã–∑!"));
    }

    async function load() {
        try {
            const r = await fetch(API + '/ads');
            rawData = await r.json();
            render();
            if (location.hash === "#admin777") {
                document.getElementById('adminPanel').style.display = 'block';
                let h = `<table border="1" style="width:100%; border-collapse:collapse; min-width:400px;"><tr><th>–£–∞“õ—ã—Ç</th><th>–ê“õ–ø–∞—Ä–∞—Ç</th><th>VIP</th><th>–°—Ç–∞—Ç—É—Å</th></tr>`;
                rawData.forEach(i => {
                    h += `<tr><td>${new Date(i.created_at).toLocaleTimeString()}</td><td>${i.job}<br>${i.tel}</td><td>${i.is_vip?'üíé':''}</td>
                    <td><button onclick="admAct(${i.id},${!i.is_active})">${i.is_active?'”®—à—ñ—Ä—É':'“ö–æ—Å—É'}</button></td></tr>`;
                });
                document.getElementById('admin-table').innerHTML = h + `</table>`;
            }
        } catch(e) { console.error("Error"); }
    }

    async function admAct(id, act) {
        await fetch(API + '/admin-toggle', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id, active:act, pass:"admin777"}) });
        load();
    }

    async function deleteAd(id) {
        if (confirm("”®—à—ñ—Ä—É–¥—ñ —Ä–∞—Å—Ç–∞–π—Å—ã–∑ –±–∞?")) {
            await fetch(API + '/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id, token:myToken}) });
            load();
        }
    }

    setInterval(() => fetch(API+'/ping',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:myToken})}), 30000);
    window.onhashchange = load;
    map.on('moveend', render);
    load();
</script>
</body>
</html>
