<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qalpan Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        .nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 10px; background: white; padding: 10px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .admin-btn { position: fixed; top: 10px; right: 10px; z-index: 1000; opacity: 0.1; } /* –ñ–∞—Å—ã—Ä—ã–Ω –∞–¥–º–∏–Ω –±–∞—Ç—ã—Ä–º–∞—Å—ã */
        .order-panel { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 20px; border-radius: 15px; z-index: 2000; box-shadow: 0 5px 25px rgba(0,0,0,0.3); text-align: center; }
    </style>
</head>
<body>

    <button class="admin-btn" onclick="openAdmin()">Admin</button>
    <button style="position:fixed; top:20px; left:20px; z-index:1000;" onclick="startTracking()">üü¢ –ñ“±–º—ã—Å“õ–∞ —à—ã“ì—É</button>

    <div id="map"></div>

    <div class="nav">
        <button onclick="filter('üõ†')">üõ† –°–µ—Ä–≤–∏—Å</button>
        <button onclick="filter('üõí')">üõí –¢–∞—É–∞—Ä</button>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const socket = io("https://sk-joba.onrender.com");
        const map = L.map('map').setView([43.238, 76.889], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let myName, myPhone, markers = {};

        function startTracking() {
            myName = prompt("–ê—Ç—ã“£—ã–∑:");
            myPhone = prompt("–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ“£—ñ–∑:");
            let role = prompt("–†”©–ª—ñ“£—ñ–∑ (üõ† –Ω–µ–º–µ—Å–µ üõí):", "üõ†");
            
            navigator.geolocation.watchPosition(pos => {
                socket.emit('send_location', { id: myName, phone: myPhone, role: role, lat: pos.coords.latitude, lng: pos.coords.longitude });
            });
        }

        socket.on('receive_location', data => {
            if (markers[data.id]) { markers[data.id].setLatLng([data.lat, data.lng]); }
            else {
                markers[data.id] = L.marker([data.lat, data.lng]).addTo(map)
                    .bindPopup(`<b>${data.id}</b><br><button onclick="order('${data.id}')">–¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É</button>`);
            }
        });

        function order(id) {
            socket.emit('order_request', { to: id, from: myName, fromPhone: myPhone });
            alert("–°“±—Ä–∞–Ω—ã—Å –∫–µ—Ç—Ç—ñ...");
        }

        socket.on('order_received', data => {
            if (confirm(`–¢–∞–ø—Å—ã—Ä—ã—Å: ${data.from}. –¢–µ–ª: ${data.fromPhone}. “ö–∞–±—ã–ª–¥–∞–π—Å—ã–∑ –±–∞?`)) {
                socket.emit('order_response', { toClient: data.from, from: myName, fromPhone: myPhone, status: 'accepted' });
            }
        });

        socket.on('error_message', msg => alert(msg));

        // –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨
        function openAdmin() {
            let pass = prompt("“ö“±–ø–∏—è —Å”©–∑:");
            if (pass === "2025") {
                let user = prompt("–ö—ñ–º–Ω—ñ“£ –±–∞–ª–∞–Ω—Å—ã–Ω —Ç–æ–ª—Ç—ã—Ä–∞–º—ã–∑?");
                let amount = prompt("“ö–∞–Ω—à–∞ —Å–æ–º–º–∞?");
                socket.emit('admin_add_balance', { id: user, amount: parseInt(amount) });
            }
        }
    </script>
</body>
</html>
