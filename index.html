<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ –•–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É –ñ“Ø–π–µ—Å—ñ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root { --blue: #007bff; --gold: #ffd700; --red: #dc3545; --green: #28a745; }
        body, html { margin: 0; padding: 0; font-family: sans-serif; height: 100%; overflow: hidden; background: #f4f4f4; }
        
        /* 2. –ö–∞—Ä—Ç–∞ —Ä–µ–∂–∏–º–¥–µ—Ä—ñ */
        #map { height: 45vh; width: 100%; transition: 0.3s; }
        .grayscale { filter: grayscale(100%) brightness(0.9); }
        
        .panel { height: 55vh; overflow-y: auto; padding: 15px; box-sizing: border-box; }
        .card { background: white; border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 5px solid var(--blue); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card.vip { border-left-color: var(--gold); background: #fffef0; }
        
        /* 5. –¢–æ–ª—ã“õ –∞“õ–ø–∞—Ä–∞—Ç —Å—Ç–∏–ª—ñ */
        .info-row { font-size: 13px; margin: 5px 0; display: flex; gap: 10px; flex-wrap: wrap; }
        .info-row span { background: #eee; padding: 2px 6px; border-radius: 4px; border: 1px solid #ddd; }

        input, select, button { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
        .btn-post { background: var(--green); color: white; border: none; font-weight: bold; }
        .btn-vip { background: var(--gold); color: black; border: none; font-weight: bold; }
        .btn-del { background: var(--red); color: white; width: auto; padding: 4px 10px; font-size: 11px; float: right; border: none; }
        
        #adminPanel { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
    <button onclick="document.getElementById('map').classList.toggle('grayscale')" style="background:#333; color:white;">üåì –ö–∞—Ä—Ç–∞ —Ç“Ø—Å—ñ–Ω –∞—É—ã—Å—Ç—ã—Ä—É</button>

    <div style="display:flex; gap:5px;">
        <input type="text" id="search" placeholder="üîç –ù–µ —ñ–∑–¥–µ–π—Å—ñ–∑? (–º–∞–º–∞–Ω–¥—ã“õ, —Ç–∞—É–∞—Ä...)" oninput="filter()">
        <select id="catFilter" onchange="filter()" style="width:40%"></select>
    </div>

    <h4 style="margin:15px 0 5px 0; color:var(--blue);">üìç –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞: <span id="count">0</span></h4>
    <div id="list"></div>

    <hr>

    <div id="form">
        <h4>üì¢ –ñ–∞“£–∞ —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É</h4>
        <select id="p_type">
            <option value="“ö—ã–∑–º–µ—Ç">üë∑ “ö—ã–∑–º–µ—Ç (–ú–∞–º–∞–Ω–¥—ã“õ)</option>
            <option value="–¢–∞—É–∞—Ä">üì¶ –¢–∞—É–∞—Ä (–°–∏–ø–∞—Ç—Ç–∞–º–∞)</option>
            <option value="–¢–∞–ø—Å—ã—Ä—ã—Å">üõí –¢–∞–ø—Å—ã—Ä—ã—Å (–ë”©–ª—ñ–º)</option>
        </select>
        <input id="p_name" placeholder="–ê—Ç—ã“£—ã–∑ (–º–∏–Ω. 2 —Ç–∞“£–±–∞)">
        <input id="p_job" placeholder="–°–∞–Ω–∞—Ç –Ω–µ–º–µ—Å–µ —Ç–∞—É–∞—Ä –∞—Ç—ã">
        <input id="p_tel" placeholder="–¢–µ–ª: +77001112233 (12 —Ç–∞“£–±–∞)">
        <input id="p_email" placeholder="Email: test@mail.kz">
        
        <div style="display:flex; gap:5px;">
            <button onclick="save(false)" class="btn-post">–¢–µ–≥—ñ–Ω (–õ–µ–∑–¥–µ)</button>
            <button onclick="save(true)" class="btn-vip">üíé VIP (–ê–¥–º–∏–Ω–Ω–µ–Ω —Å–æ“£)</button>
        </div>
    </div>
</div>

<div id="adminPanel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>üõ° –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å (VIP –ë–∞—Å“õ–∞—Ä—É)</h2>
        <button onclick="location.hash=''" style="width:auto;">–ñ–∞–±—É</button>
    </div>
    <div id="admin-data"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
    const API = "https://your-backend-url.com"; // –°–µ—Ä–≤–µ—Ä –∞–¥—Ä–µ—Å—ñ
    let myToken = localStorage.getItem('token') || "U" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('token', myToken);

    let map = L.map('map', {zoomControl: false}).setView([43.2389, 76.8897], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let markers = [];
    let allData = [];

    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–∫—Å–µ—Ä—É—ñ
    function isValid() {
        const n = document.getElementById('p_name').value, j = document.getElementById('p_job').value;
        const t = document.getElementById('p_tel').value, e = document.getElementById('p_email').value;
        if (n.length < 2 || j.length < 2) return alert("–ê—Ç—ã“£—ã–∑ –±–µ–Ω —Å–∞–Ω–∞—Ç –∫–µ–º—ñ–Ω–¥–µ 2 —Ç–∞“£–±–∞ –±–æ–ª—É—ã –∫–µ—Ä–µ–∫!");
        if (!/^\+7\d{10}$/.test(t)) return alert("–¢–µ–ª “õ–∞—Ç–µ! –§–æ—Ä–º–∞—Ç: +77001234567 (12 —Ç–∞“£–±–∞)");
        if (!e.includes('@') || !e.includes('.')) return alert("Email “õ–∞—Ç–µ! (@ –∂”ô–Ω–µ . –±–æ–ª—É—ã –∫–µ—Ä–µ–∫)");
        return true;
    }

    async function load() {
        const r = await fetch(API + '/ads');
        allData = await r.json();
        
        // 7. –°–∞–Ω–∞—Ç—Ç–∞—Ä–¥—ã –∞–≤—Ç–æ–º–∞—Ç—Ç—ã –∂–∏–Ω–∞—É
        const cats = [...new Set(allData.map(i => i.job))];
        document.getElementById('catFilter').innerHTML = '<option value="">–ë–∞—Ä–ª—ã“õ –±”©–ª—ñ–º–¥–µ—Ä</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
        
        checkAdmin();
        filter();
    }

    // 5. –ú–∞—Ä–∫–µ—Ä “õ–∞–±–∞—Ç—Ç–∞—Å—É—ã–Ω —à–µ—à—É (Jitter)
    const jitter = () => (Math.random() - 0.5) * 0.0007;

    function filter() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        let listH = "", count = 0;
        const search = document.getElementById('search').value.toLowerCase();
        const cat = document.getElementById('catFilter').value;
        const bounds = map.getBounds();
        const now = Date.now();

        allData.forEach(i => {
            const isOnline = (now - (i.last_ping || 0)) < 40000;
            const isOwner = i.token === myToken;

            // 4. VIP –ê–¥–º–∏–Ω —Ä“±“õ—Å–∞—Ç—ã–Ω—Å—ã–∑ –∫”©—Ä—ñ–Ω–±–µ–π–¥—ñ
            if (i.is_vip && !i.is_active && !isOwner) return;
            // 3. –¢–µ–≥—ñ–Ω —Ç–µ–∫ –æ–Ω–ª–∞–π–Ω –±–æ–ª—Å–∞ –∫”©—Ä—ñ–Ω–µ–¥—ñ
            if (!i.is_vip && !isOnline && !isOwner) return;

            if (cat && i.job !== cat) return;
            if (search && !i.job.toLowerCase().includes(search) && !i.name.toLowerCase().includes(search)) return;

            const lat = i.lat + jitter(), lon = i.lon + jitter();
            const m = L.circleMarker([lat, lon], { radius: 10, color: i.is_vip ? 'gold' : 'blue', fillColor: isOnline ? 'green' : 'gray', fillOpacity: 0.8 }).addTo(map);

            // 5. –ú–∏–Ω–∏ –∞“õ–ø–∞—Ä–∞—Ç (–ú–∞—Ä–∫–µ—Ä–¥–µ)
            m.bindPopup(`<b>${i.job}</b><br><small>${i.name}</small><hr>üìû ${i.tel}<br>üìß ${i.email}`);
            markers.push(m);

            // 6. –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞“ì—ã —Ç–æ–ª—ã“õ –∞“õ–ø–∞—Ä–∞—Ç—Ç–∞—Ä
            if (bounds.contains([lat, lon])) {
                count++;
                listH += `
                    <div class="card ${i.is_vip ? 'vip' : ''}">
                        ${isOwner ? `<button onclick="del(${i.id})" class="btn-del">”®—à—ñ—Ä—É</button>` : ''}
                        <b>${i.job}</b> <small>(${i.type})</small> ${isOnline ? 'üü¢' : '‚ö™'}
                        <div style="font-size:12px; color:gray; margin-top:3px;">${i.name}</div>
                        <div class="info-row"><span>üìû ${i.tel}</span><span>üìß ${i.email}</span></div>
                    </div>`;
            }
        });
        document.getElementById('count').innerText = count;
        document.getElementById('list').innerHTML = listH || "<p style='text-align:center; color:gray;'>–ñ–æ“õ...</p>";
    }

    async function save(isVip) {
        if (!isValid()) return;
        if (isVip) alert("VIP —Ç”©–ª–µ–º —Ö–∞–±–∞—Ä–ª–∞–º–∞—Å—ã –∞–¥–º–∏–Ω–≥–µ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ. –¢–µ–∫—Å–µ—Ä—É–¥–µ–Ω —Å–æ“£ —à—ã“ì–∞–¥—ã.");

        navigator.geolocation.getCurrentPosition(async p => {
            await fetch(API + '/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: document.getElementById('p_name').value, job: document.getElementById('p_job').value,
                    type: document.getElementById('p_type').value, tel: document.getElementById('p_tel').value,
                    email: document.getElementById('p_email').value, is_vip: isVip, token: myToken,
                    lat: p.coords.latitude, lon: p.coords.longitude
                })
            });
            load();
        }, () => alert("GPS —Ä“±“õ—Å–∞—Ç –±–µ—Ä—ñ“£—ñ–∑!"), { enableHighAccuracy: true });
    }

    async function del(id) { if(confirm("”®—à—ñ—Ä—É?")) fetch(API+'/del',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id, token:myToken})}).then(load); }

    // 5. –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å –ª–æ–≥–∏–∫–∞—Å—ã
    function checkAdmin() {
        if (location.hash === "#admin777") {
            document.getElementById('adminPanel').style.display = 'block';
            let h = `<table border="1" style="width:100%; border-collapse:collapse; font-size:12px;"><tr><th>–£–∞“õ—ã—Ç</th><th>–î–µ—Ä–µ–∫</th><th>–¢–µ–ª</th><th>–°—Ç–∞—Ç—É—Å</th><th>”ò—Ä–µ–∫–µ—Ç</th></tr>`;
            allData.forEach(i => {
                h += `<tr>
                    <td>${new Date(i.created_at).toLocaleString()}</td>
                    <td><b>${i.job}</b><br>${i.name}</td>
                    <td>${i.tel}</td>
                    <td>${i.is_active ? '‚úÖ' : (i.is_vip ? '‚è≥ –¢”©–ª–µ–º' : '–¢–µ–≥—ñ–Ω')}</td>
                    <td><button onclick="admAct(${i.id},${!i.is_active})">${i.is_active?'”®—à—ñ—Ä—É':'“ö–æ—Å—É'}</button></td>
                </tr>`;
            });
            document.getElementById('admin-data').innerHTML = h + `</table>`;
        } else { document.getElementById('adminPanel').style.display = 'none'; }
    }

    async function admAct(id, act) {
        await fetch(API + '/admin-toggle', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id, active: act, pass: "admin777"}) });
        load();
    }

    window.onhashchange = checkAdmin;
    map.on('moveend', filter);
    setInterval(() => fetch(API+'/ping',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:myToken})}), 30000);
    load();
</script>
</body>
</html>
