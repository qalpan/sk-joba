<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root { --blue: #007bff; --gold: #ffd700; --red: #dc3545; --green: #28a745; --dark: #212529; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100%; overflow: hidden; }
        
        /* 2. –¢“Ø—Å—Ç—ñ –∂”ô–Ω–µ –ê“õ-“õ–∞—Ä–∞ –∫–∞—Ä—Ç–∞ —Å—Ç–∏–ª—ñ */
        #map { height: 45vh; width: 100%; background: #e9ecef; }
        .grayscale { filter: grayscale(100%) brightness(90%); }
        
        .panel { height: 55vh; overflow-y: auto; background: white; padding: 15px; box-sizing: border-box; }
        .card { background: #fff; border: 1px solid #dee2e6; padding: 10px; margin-bottom: 10px; border-radius: 8px; position: relative; }
        .card.vip-card { border-left: 5px solid var(--gold); background: #fffdf5; }
        .card.free-card { border-left: 5px solid var(--blue); }
        
        .contact-tag { display: inline-block; background: #f1f3f5; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin: 2px; border: 1px solid #ced4da; }
        .btn-del { background: var(--red); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; float: right; font-size: 11px; }
        
        input, select, button { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #ced4da; box-sizing: border-box; }
        button { cursor: pointer; font-weight: 600; }
        .admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10001; padding:20px; overflow-y:auto; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
    <div style="display:flex; gap:5px;">
        <button onclick="toggleMap()" style="background:var(--dark); color:white; flex:1;">üåì –ö–∞—Ä—Ç–∞ —Å—Ç–∏–ª—ñ</button>
        <button onclick="checkAdmin()" style="background:#eee; flex:0.2;">üõ°</button>
    </div>

    <div style="margin-top:10px;">
        <input type="text" id="searchInput" placeholder="üîç –ú–∞–º–∞–Ω–¥—ã“õ –Ω–µ–º–µ—Å–µ —Ç–∞—É–∞—Ä —ñ–∑–¥–µ—É..." oninput="filterMarkers()">
        <select id="catFilter" onchange="filterMarkers()"><option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option></select>
    </div>

    <div id="nearby-section" style="margin-top:15px;">
        <div style="font-weight:bold; color:var(--blue); border-bottom: 2px solid #eee; padding-bottom:5px;">
            üìç –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞: <span id="item-count">0</span>
        </div>
        <div id="list-content" style="margin-top:10px;"></div>
    </div>

    <hr>

    <div class="form-section">
        <h4 style="margin:10px 0;">üì¢ –ñ–∞“£–∞ —Ö–∞–±–∞—Ä–ª–∞–º–∞</h4>
        <select id="p_type">
            <option value="“ö—ã–∑–º–µ—Ç">üë∑ “ö—ã–∑–º–µ—Ç (–ú–∞–º–∞–Ω–¥—ã“õ)</option>
            <option value="–¢–∞—É–∞—Ä">üì¶ –¢–∞—É–∞—Ä (–°–∏–ø–∞—Ç—Ç–∞–º–∞)</option>
            <option value="–¢–∞–ø—Å—ã—Ä—ã—Å">üõí –¢–∞–ø—Å—ã—Ä—ã—Å (–ë”©–ª—ñ–º)</option>
        </select>
        <input id="p_name" placeholder="–ê—Ç—ã“£—ã–∑ (–º–∏–Ω. 2 —Ç–∞“£–±–∞)">
        <input id="p_job" placeholder="–ù–µ –Ω–µ–º–µ—Å–µ –∫—ñ–º? (–º—ã—Å–∞–ª—ã: –°–∞–Ω—Ç–µ—Ö–Ω–∏–∫)">
        
        <div id="contacts_area">
            <div class="c-row" style="display:flex; gap:5px;">
                <select class="ct" style="width:35%"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option></select>
                <input class="cv" style="width:65%" placeholder="–î–µ—Ä–µ–∫">
            </div>
        </div>
        <button onclick="addCRow()" style="background:#f8f9fa; color:#495057; font-size:12px; border-style:dashed;">+ –ë–∞–π–ª–∞–Ω—ã—Å “õ–æ—Å—É</button>
        
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="submitData(false)" style="background:var(--green); color:white; flex:1;">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
            <button onclick="submitData(true)" style="background:var(--gold); flex:1;">üíé VIP –∂–∞—Ä–∏—è–ª–∞—É</button>
        </div>
    </div>
</div>

<div id="adminPanel" class="admin-modal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>üõ° –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h2>
        <button onclick="closeAdmin()" style="width:auto; background:var(--red); color:white; padding:5px 15px;">–ñ–∞–±—É</button>
    </div>
    <div id="admin-data"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<script>
    // 1. –ë–ê–†–õ–´“ö –§–£–ù–ö–¶–ò–Ø–õ–ê–†–î–´ –¢“Æ–ó–ï–¢–£ –ñ”ò–ù–ï –ê–ù–´“ö–¢–ê–£
    const API = "https://sk-joba.onrender.com";
    let myToken = localStorage.getItem('token') || "T" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('token', myToken);

    // –ö–∞—Ä—Ç–∞–Ω—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è–ª–∞—É
    let map = L.map('map', { zoomControl: false }).setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let markers = [];
    let rawData = [];

    // 2. –¢“Ø—Å—Ç—ñ/–ê“õ-“õ–∞—Ä–∞ –∞—É—ã—Å—Ç—ã—Ä—É
    function toggleMap() {
        document.getElementById('map').classList.toggle('grayscale');
    }

    // –ë–∞–π–ª–∞–Ω—ã—Å –∂–æ–ª—ã–Ω “õ–æ—Å—É
    function addCRow() {
        const div = document.createElement('div');
        div.className = 'c-row'; div.style = "display:flex; gap:5px; margin-top:5px;";
        div.innerHTML = `<select class="ct" style="width:35%"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option></select><input class="cv" style="width:65%" placeholder="–î–µ—Ä–µ–∫">`;
        document.getElementById('contacts_area').appendChild(div);
    }

    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è (–¢–µ–ª: 12 —Ç–∞“£–±–∞, Email: @., –ú”ô—Ç—ñ–Ω: 2 —Ç–∞“£–±–∞)
    function validate(type, val) {
        val = val.trim();
        if (type === '–¢–µ–ª') return /^\+7\d{10}$/.test(val.replace(/\s+/g, ''));
        if (type === 'Email') return val.includes('@') && val.includes('.');
        return val.length >= 2;
    }

    // 3, 4, 5. –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∂“Ø–∫—Ç–µ—É –∂”ô–Ω–µ –∫”©—Ä—Å–µ—Ç—É
    async function loadData() {
        try {
            const r = await fetch(API + '/get-all');
            const data = await r.json();
            rawData = Array.isArray(data) ? data : [];
            updateCats();
            filterMarkers();
        } catch(e) { console.error("–ñ“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ"); }
    }

    function updateCats() {
        const s = document.getElementById('catFilter');
        const cats = [...new Set(rawData.map(i => i.job))].filter(Boolean);
        s.innerHTML = '<option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option>';
        cats.forEach(c => s.innerHTML += `<option value="${c}">${c}</option>`);
    }

    // –ú–∞—Ä–∫–µ—Ä–ª–µ—Ä–¥—ñ“£ –±—ñ—Ä –Ω“Ø–∫—Ç–µ–¥–µ “õ–∞–±–∞—Ç—Ç–∞—Å—É—ã–Ω –±–æ–ª–¥—ã—Ä–º–∞—É (Jitter)
    function jitter() { return (Math.random() - 0.5) * 0.0004; }

    function filterMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        let listH = "", count = 0, now = Date.now();
        const search = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('catFilter').value;
        const bounds = map.getBounds();

        rawData.forEach(i => {
            const timeDiff = (now - new Date(i.created_at).getTime()) / 3600000;
            if (timeDiff > 24) return; // 24 —Å–∞“ì–∞—Ç—Ç—ã“õ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã ”©—à—ñ—Ä—É

            const isOnline = (now - (i.last_ping || 0)) < 40000;
            const isOwner = i.token === myToken;

            // 4. VIP —Ç–µ–∫—Å–µ—Ä—ñ—Å—ñ: —Ç–µ–∫ –∞–¥–º–∏–Ω –º–∞“õ“±–ª–¥–∞“ì–∞–Ω–¥–∞ –Ω–µ–º–µ—Å–µ –∏–µ—Å—ñ–Ω–µ –∫”©—Ä—ñ–Ω–µ–¥—ñ
            if (i.is_vip && !i.is_active && !isOwner && location.hash !== "#admin777") return;
            // 3. –¢–µ–≥—ñ–Ω: —Ç–µ–∫ –∏–µ—Å—ñ –æ–Ω–ª–∞–π–Ω –±–æ–ª“ì–∞–Ω–¥–∞ –∫”©—Ä—ñ–Ω–µ–¥—ñ
            if (!i.is_vip && !isOnline && !isOwner) return;

            // 7. –°“±—Ä—ã–ø—Ç–∞—É
            if (cat && i.job !== cat) return;
            if (search && !i.job.toLowerCase().includes(search) && !i.name.toLowerCase().includes(search)) return;

            // –ö–∞—Ä—Ç–∞“ì–∞ –º–∞—Ä–∫–µ—Ä “õ–æ—é (“õ–∞–±–∞—Ç—Ç–∞—Å–ø–∞—Å “Ø—à—ñ–Ω —Å”ô–ª –∂—ã–ª–∂—ã—Ç–∞–º—ã–∑)
            const mLat = i.lat + jitter();
            const mLon = i.lon + jitter();
            
            const marker = L.circleMarker([mLat, mLon], {
                color: i.is_vip ? 'gold' : 'blue',
                fillColor: isOnline ? 'green' : (i.is_vip ? 'gold' : 'blue'),
                fillOpacity: 0.8, radius: 10, weight: 3
            }).addTo(map);

            let contacts = []; try { contacts = JSON.parse(i.contacts); } catch(e) {}
            const cH = contacts.map(c => `<span class="contact-tag"><b>${c.type}:</b> ${c.val}</span>`).join('');
            const dBtn = isOwner ? `<button class="btn-del" onclick="deleteItem(${i.id})">”®—à—ñ—Ä—É</button>` : "";
            
            // 5. –ú–∏–Ω–∏ –∞“õ–ø–∞—Ä–∞—Ç
            marker.bindPopup(`<b>${i.job}</b><br><small>${i.name}</small> ${isOnline ? 'üü¢':''} <hr>${cH}${dBtn}`);
            markers.push(marker);

            // 6. –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞ —Ç—ñ–∑—ñ–º—ñ
            if (bounds.contains([mLat, mLon])) {
                count++;
                listH += `
                    <div class="card ${i.is_vip?'vip-card':'free-card'}">
                        ${dBtn}
                        <b>${i.job}</b> <small>(${i.type})</small><br>
                        <small style="color:gray">${i.name}</small> ${isOnline ? 'üü¢ online':''}<br>
                        <div style="margin-top:5px;">${cH}</div>
                    </div>`;
            }
        });
        document.getElementById('item-count').innerText = count;
        document.getElementById('list-content').innerHTML = listH || "<p style='color:gray; font-size:13px;'>–ë“±–ª –∞—É–º–∞“õ—Ç–∞ –µ—à—Ç–µ“£–µ –∂–æ“õ.</p>";
    }

    // 1. –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∂—ñ–±–µ—Ä—É
    async function submitData(isVip) {
        const n = document.getElementById('p_name').value;
        const j = document.getElementById('p_job').value;
        const t = document.getElementById('p_type').value;

        if (!validate('T', n) || !validate('T', j)) return alert("–ê—Ç—ã“£—ã–∑ –±–µ–Ω –º–∞–º–∞–Ω–¥—ã“õ 2 —Ç–∞“£–±–∞–¥–∞–Ω –∫–µ–º –±–æ–ª–º–∞—Å—ã–Ω!");

        let c = [];
        let error = false;
        document.querySelectorAll('.c-row').forEach(row => {
            const ct = row.querySelector('.ct').value, cv = row.querySelector('.cv').value;
            if (cv) {
                if (validate(ct, cv)) c.push({type: ct, val: cv});
                else { error = true; alert(`${ct} “õ–∞—Ç–µ! (–¢–µ–ª: +7... 12 —Ç–∞“£–±–∞)`); }
            }
        });

        if (error || c.length === 0) return;
        if (isVip) alert("VIP —Ç”©–ª–µ–º —Ö–∞–±–∞—Ä–ª–∞–º–∞—Å—ã –∞–¥–º–∏–Ω–≥–µ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ. –¢”©–ª–µ–º–Ω–µ–Ω —Å–æ“£ 24 —Å–∞“ì–∞—Ç“õ–∞ “õ–æ—Å—ã–ª–∞–¥—ã.");

        navigator.geolocation.getCurrentPosition(async pos => {
            await fetch(API + '/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: n, job: j, type: t, is_vip: isVip,
                    lat: pos.coords.latitude, lon: pos.coords.longitude,
                    contacts: JSON.stringify(c), token: myToken
                })
            });
            loadData();
        }, () => alert("GPS “õ–æ—Å—ã“£—ã–∑!"), {enableHighAccuracy: true});
    }

    function deleteItem(id) {
        if(confirm("”®—à—ñ—Ä—É–¥—ñ —Ä–∞—Å—Ç–∞–π—Å—ã–∑ –±–∞?")) {
            fetch(API+'/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,token:myToken})}).then(loadData);
        }
    }

    // 5. –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å
    function checkAdmin() {
        const p = prompt("“ö“±–ø–∏—è —Å”©–∑:");
        if (p === "admin777") {
            document.getElementById('adminPanel').style.display = 'block';
            let h = "";
            rawData.forEach(i => {
                let contacts = []; try { contacts = JSON.parse(i.contacts); } catch(e) {}
                h += `
                    <div class="card">
                        <b>${i.job}</b> [${i.is_vip ? 'üíé VIP' : '–¢–µ–≥—ñ–Ω'}]<br>
                        –£–∞“õ—ã—Ç—ã: ${new Date(i.created_at).toLocaleString()}<br>
                        –ë–∞–π–ª–∞–Ω—ã—Å: ${contacts.map(x=>x.val).join(', ')}<br>
                        –°—Ç–∞—Ç—É—Å: ${i.is_active ? '‚úÖ –ê–∫—Ç–∏–≤' : '‚è≥ –ö“Ø—Ç—É–¥–µ'}<br>
                        <button onclick="tgl(${i.id},${!i.is_active})" style="width:auto; background:var(--green); color:white; padding:5px;">${i.is_active?'”®—à—ñ—Ä—É':'“ö–æ—Å—É'}</button>
                        <button onclick="deleteItem(${i.id})" style="width:auto; background:var(--red); color:white; padding:5px;">–ñ–æ—é</button>
                    </div>`;
            });
            document.getElementById('admin-data').innerHTML = h;
        }
    }

    async function tgl(id, a) {
        await fetch(API + '/admin-toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id, active: a, pass: "admin777"})
        });
        loadData();
        checkAdmin(); // –ñ–∞“£–∞—Ä—Ç—É
    }

    function closeAdmin() { document.getElementById('adminPanel').style.display='none'; }

    // –¢“±—Ä–∞“õ—Ç—ã –∂–∞“£–∞—Ä—Ç—É–ª–∞—Ä
    setInterval(() => {
        fetch(API + '/ping', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({token: myToken}) });
    }, 25000);

    map.on('moveend', filterMarkers);
    loadData();
</script>
</body>
</html>
