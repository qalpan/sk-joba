<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba: –¢–æ–ª—ã“õ –ñ”©–Ω–¥–µ–ª–≥–µ–Ω –ù“±—Å“õ–∞</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root { --blue: #007bff; --gold: #ffd700; --red: #dc3545; --green: #28a745; }
        body, html { margin: 0; padding: 0; font-family: sans-serif; height: 100%; }

        /* –ö–ê–†–¢–ê –ö”®–†–Ü–ù–£–Ü “Æ–®–Ü–ù –ú–ê“¢–´–ó–î–´ */
        #map { height: 45vh; width: 100%; background: #e0e0e0; position: relative; display: block; }
        .grayscale { filter: grayscale(100%); }
        
        .ui-panel { padding: 10px; background: white; border-bottom: 2px solid var(--blue); }
        .card { background: white; padding: 12px; margin: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 5px solid var(--blue); }
        .v-list { height: 25vh; overflow-y: auto; background: #fff; }
        input, select, button { padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; }
        .admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto; }
    </style>
</head>
<body>

<div class="ui-panel">
    <button onclick="toggleMap()" style="background:#333; color:white;">üåì –ö–∞—Ä—Ç–∞ —Å—Ç–∏–ª—ñ–Ω ”©–∑–≥–µ—Ä—Ç—É</button>
    <input type="text" id="searchInput" placeholder="üîç –Ü–∑–¥–µ—É (–ú–∞–º–∞–Ω–¥—ã“õ, —Ç–∞—É–∞—Ä...)" oninput="filterMarkers()">
    <select id="catFilter" onchange="filterMarkers()"><option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option></select>
</div>

<div id="map"></div>

<div class="v-list">
    <div style="padding:10px; font-weight:bold; background:#f8f9fa;">üìç –ê—É–º–∞“õ—Ç–∞: <span id="item-count">0</span></div>
    <div id="list-content"></div>
</div>

<div class="card">
    <h4>üì¢ –ñ–∞“£–∞ —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É</h4>
    <select id="p_type">
        <option value="“ö—ã–∑–º–µ—Ç">üë∑ “ö—ã–∑–º–µ—Ç (–ú–∞–º–∞–Ω–¥—ã“õ)</option>
        <option value="–¢–∞—É–∞—Ä">üì¶ –¢–∞—É–∞—Ä (–°–∏–ø–∞—Ç—Ç–∞–º–∞)</option>
        <option value="–¢–∞–ø—Å—ã—Ä—ã—Å">üõí –¢–∞–ø—Å—ã—Ä—ã—Å (–ë”©–ª—ñ–º)</option>
    </select>
    <input id="p_name" placeholder="–ê—Ç—ã“£—ã–∑ (–º–∏–Ω. 2 —Ç–∞“£–±–∞)">
    <input id="p_job" placeholder="–ù–µ–≥—ñ–∑–≥—ñ –∞“õ–ø–∞—Ä–∞—Ç">
    <div id="c_list">
        <div class="c-row" style="display:flex; gap:5px;">
            <select class="ct" style="width:30%"><option>–¢–µ–ª</option><option>Email</option></select>
            <input class="cv" style="width:70%" placeholder="–î–µ—Ä–µ–∫">
        </div>
    </div>
    <button onclick="addCRow()" style="background:#eee; font-size:12px;">+ –ë–∞–π–ª–∞–Ω—ã—Å</button>
    <div style="display:flex; gap:5px; margin-top:10px;">
        <button onclick="submitData(false)" style="background:var(--green); color:white;">–¢–µ–≥—ñ–Ω</button>
        <button onclick="submitData(true)" style="background:var(--gold);">üíé VIP</button>
    </div>
</div>

<div id="adminPanel" class="admin-modal">
    <button onclick="closeAdmin()" style="float:right; background:var(--red); color:white; width:auto;">–ñ–∞–±—É</button>
    <h2>üõ° –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h2>
    <div id="admin-data"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<script>
    // 1. –ë–ê–†–õ–´“ö –§–£–ù–ö–¶–ò–Ø–õ–ê–†–î–´ –ê–ù–´“ö–¢–ê–£ (toggleMap –æ—Å—ã–Ω–¥–∞ –±–æ–ª—É—ã —Ç–∏—ñ—Å)
    const API = "https://sk-joba.onrender.com";
    let myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    // –ö–ê–†–¢–ê –Ü–°–ö–ï “ö–û–°–£
    let map;
    try {
        map = L.map('map').setView([43.2389, 76.8897], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    } catch(e) { console.error("–ö–∞—Ä—Ç–∞ “õ–∞—Ç–µ—Å—ñ:", e); }

    let markers = [];
    let rawData = [];

    // “ö–∞—Ç–µ –∫–µ—Ç–∫–µ–Ω —Ñ—É–Ω–∫—Ü–∏—è–Ω—ã –∞–Ω—ã“õ—Ç–∞—É:
    function toggleMap() {
        document.getElementById('map').classList.toggle('grayscale');
    }

    function addCRow() {
        const div = document.createElement('div');
        div.className = 'c-row'; div.style = "display:flex; gap:5px; margin-top:5px;";
        div.innerHTML = `<select class="ct" style="width:30%"><option>–¢–µ–ª</option><option>Email</option></select><input class="cv" style="width:70%" placeholder="–î–µ—Ä–µ–∫">`;
        document.getElementById('c_list').appendChild(div);
    }

    // –í–ê–õ–ò–î–ê–¶–ò–Ø (12 —Ç–∞“£–±–∞ —Ç–µ–ª, @ email)
    function validate(type, val) {
        if (type === '–¢–µ–ª') return /^\+7\d{10}$/.test(val.replace(/\s+/g, ''));
        if (type === 'Email') return val.includes('@') && val.includes('.');
        return val.trim().length >= 2;
    }

    async function loadData() {
        try {
            const r = await fetch(API + '/get-all');
            rawData = await r.json();
            updateCats();
            filterMarkers();
        } catch(e) { console.log("–î–µ—Ä–µ–∫ –∂“Ø–∫—Ç–µ–ª–º–µ–¥—ñ"); }
    }

    function updateCats() {
        const s = document.getElementById('catFilter');
        const cats = [...new Set(rawData.map(i => i.job))].filter(Boolean);
        s.innerHTML = '<option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option>';
        cats.forEach(c => s.innerHTML += `<option value="${c}">${c}</option>`);
    }

    function filterMarkers() {
        if(!map) return;
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        let listH = "", count = 0, now = Date.now();
        const search = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('catFilter').value;
        const bounds = map.getBounds();

        rawData.forEach(i => {
            if ((now - new Date(i.created_at).getTime()) / 3600000 > 24) return;
            const isOn = (now - (i.last_ping || 0)) < 300000;
            const isOwn = i.token === myToken;

            if (!i.is_active && !i.is_vip && !isOn) return;
            if (i.is_vip && !i.is_active && !isOwn && location.hash !== "#admin777") return;
            if (cat && i.job !== cat) return;
            if (search && !i.job.toLowerCase().includes(search) && !i.name.toLowerCase().includes(search)) return;

            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—Ç–∞—Ä–¥—ã —Å”ô–ª –∂—ã–ª–∂—ã—Ç—É (“õ–∞–±–∞—Ç—Ç–∞—Å–ø–∞—Å “Ø—à—ñ–Ω)
            const lat = i.lat + (Math.random() - 0.5) * 0.0002;
            const lon = i.lon + (Math.random() - 0.5) * 0.0002;

            const m = L.circleMarker([lat, lon], {
                color: i.is_vip ? 'gold' : 'blue',
                fillColor: isOn ? 'green' : (i.is_vip ? 'gold' : 'blue'),
                fillOpacity: 0.8, radius: 10
            }).addTo(map);

            let contacts = []; try { contacts = JSON.parse(i.contacts); } catch(e) {}
            const cH = contacts.map(c => `<div style="font-size:12px; border-left:2px solid blue; padding-left:5px; margin:2px 0;">${c.type}: ${c.val}</div>`).join('');
            
            m.bindPopup(`<b>${i.job}</b><br><small>${i.name}</small><hr>${cH}`);
            markers.push(m);

            if (bounds.contains([lat, lon])) {
                count++;
                listH += `<div class="card" style="border-left-color:${i.is_vip?'gold':'blue'}"><b>${i.job}</b><br>${cH}</div>`;
            }
        });
        document.getElementById('item-count').innerText = count;
        document.getElementById('list-content').innerHTML = listH;
    }

    async function submitData(isVip) {
        const n = document.getElementById('p_name').value;
        const j = document.getElementById('p_job').value;
        let c = [];
        let vAll = true;
        document.querySelectorAll('.c-row').forEach(r => {
            const t = r.querySelector('.ct').value, v = r.querySelector('.cv').value;
            if(validate(t,v)) c.push({type:t, val:v}); else vAll = false;
        });

        if(!vAll || c.length === 0 || !validate('M',n) || !validate('M',j)) return alert("–î–µ—Ä–µ–∫—Ç–µ—Ä “õ–∞—Ç–µ! –¢–µ–ª: +7... (12 —Ç–∞“£–±–∞), Email: @ –º–µ–Ω . –±–æ–ª—É—ã –∫–µ—Ä–µ–∫.");

        navigator.geolocation.getCurrentPosition(async pos => {
            await fetch(API + '/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name:n, job:j, type: document.getElementById('p_type').value,
                    is_vip:isVip, lat:pos.coords.latitude, lon:pos.coords.longitude,
                    contacts: JSON.stringify(c), token:myToken
                })
            });
            alert("–ñ—ñ–±–µ—Ä—ñ–ª–¥—ñ!"); loadData();
        }, () => alert("GPS “õ–æ—Å—ã“£—ã–∑!"));
    }

    // –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨
    function checkAdmin() {
        if(prompt("“ö“±–ø–∏—è —Å”©–∑:") === "admin777") {
            document.getElementById('adminPanel').style.display='block';
            let h = "";
            rawData.forEach(i => {
                h += `<div class="card"><b>${i.job}</b><br>–°—Ç–∞—Ç—É—Å: ${i.is_active?'–ê–∫—Ç–∏–≤':'–ö“Ø—Ç—É–¥–µ'}<br>
                <button onclick="tgl(${i.id},${!i.is_active})" style="width:auto;">“ö–æ—Å—É/”®—à—ñ—Ä—É</button></div>`;
            });
            document.getElementById('admin-data').innerHTML = h;
        }
    }
    async function tgl(id, a) { await fetch(API+'/admin-toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,active:a,pass:"admin777"})}); loadData(); }
    function closeAdmin() { document.getElementById('adminPanel').style.display='none'; }

    // –ü–∏–Ω–≥ –∂”ô–Ω–µ –∫–∞—Ä—Ç–∞ “õ–æ–∑“ì–∞–ª—ã—Å—ã
    setInterval(() => fetch(API+'/ping',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:myToken})}), 30000);
    if(map) map.on('moveend', filterMarkers);
    loadData();
</script>

<div style="position:fixed; bottom:5px; right:5px; opacity:0.1;"><button onclick="checkAdmin()">üõ°</button></div>

</body>
</html>
