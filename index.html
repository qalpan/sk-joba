<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba: –ñ“Ø–π–µ–ª—ñ –ö–∞—Ä—Ç–∞</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root { --blue: #007bff; --gold: #ffd700; --red: #dc3545; --green: #28a745; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
        
        /* –ö–ê–†–¢–ê –ú–Ü–ù–î–ï–¢–¢–Ü –¢“Æ–†–î–ï –ö”®–†–Ü–ù–£–Ü “Æ–®–Ü–ù –ë–ò–Ü–ö–¢–Ü–ö –ü–ï–ù –ï–ù–Ü–ù –ë–ï–ö–Ü–¢–£ */
        #map { height: 50vh; width: 100%; background: #e0e0e0; position: relative; }
        .grayscale { filter: grayscale(100%); }
        
        .header-box { padding: 10px; background: white; text-align: center; border-bottom: 2px solid var(--blue); }
        .card { background: white; padding: 12px; margin: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .contact-item { background: #f8f9fa; padding: 5px; margin: 3px 0; border-radius: 4px; border-left: 3px solid var(--blue); font-size: 13px; }
        .btn-del { background: var(--red); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; float: right; font-size: 11px; }
        .v-list { height: 30vh; overflow-y: auto; background: #fff; }
        .search-bar { display: flex; flex-direction: column; gap: 5px; padding: 10px; }
        input, select, button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div class="header-box">
    <div class="search-bar">
        <button onclick="toggleMap()" style="background:#444; color:white;">üåì –¢“Ø—Å—Ç—ñ / –ê“õ-“õ–∞—Ä–∞ –∫–∞—Ä—Ç–∞</button>
        <input type="text" id="searchInput" placeholder="üîç –Ü–∑–¥–µ—É (–ú–∞–º–∞–Ω–¥—ã“õ, —Ç–∞—É–∞—Ä...)" oninput="filterMarkers()">
        <select id="catFilter" onchange="filterMarkers()"><option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option></select>
    </div>
</div>

<div id="map"></div>

<div class="v-list">
    <div style="padding:10px; font-weight:bold; background:#eee;">üìç –ê—É–º–∞“õ—Ç–∞“ì—ã —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–ª–∞—Ä: (<span id="item-count">0</span>)</div>
    <div id="list-content"></div>
</div>

<div class="card" style="border-top: 5px solid var(--blue);">
    <h4>üì¢ –ñ–∞“£–∞ —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É</h4>
    <select id="p_type">
        <option value="“ö—ã–∑–º–µ—Ç">üë∑ “ö—ã–∑–º–µ—Ç (–ú–∞–º–∞–Ω–¥—ã“õ)</option>
        <option value="–¢–∞—É–∞—Ä">üì¶ –¢–∞—É–∞—Ä (–°–∏–ø–∞—Ç—Ç–∞–º–∞)</option>
        <option value="–¢–∞–ø—Å—ã—Ä—ã—Å">üõí –¢–∞–ø—Å—ã—Ä—ã—Å (–ë”©–ª—ñ–º)</option>
    </select>
    <input id="p_name" placeholder="–ê—Ç—ã“£—ã–∑ (–º–∏–Ω. 2 —Ç–∞“£–±–∞)">
    <input id="p_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ –Ω–µ–º–µ—Å–µ –¢–∞—É–∞—Ä –∞—Ç—ã">
    
    <div id="c_list">
        <div class="c-row" style="display:flex; gap:5px; margin-bottom:5px;">
            <select class="ct" style="width:35%"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option><option>Skype</option></select>
            <input class="cv" style="width:65%" placeholder="–î–µ—Ä–µ–∫">
        </div>
    </div>
    <button onclick="addCRow()" style="font-size:12px; background:#f0f0f0;">+ –ë–∞–π–ª–∞–Ω—ã—Å “õ–æ—Å—É</button>
    
    <div style="display:flex; gap:10px; margin-top:15px;">
        <button onclick="send(false)" style="background:var(--green); color:white; flex:1; border:none;">–¢–µ–≥—ñ–Ω (–õ–µ–∑–¥–µ)</button>
        <button onclick="send(true)" style="background:var(--blue); color:white; flex:1; border:none;">üíé VIP (–¢”©–ª–µ–º)</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<script>
    // –°–ï–†–í–ï–† –ú–ï–ö–ï–ù–ñ–ê–ô–´ - –û–°–´–ù–´ –¢–ï–ö–°–ï–†–Ü“¢–Ü–ó!
    const API = "https://sk-joba.onrender.com";
    let myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    // –ö–ê–†–¢–ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø–°–´
    let map;
    try {
        map = L.map('map').setView([43.2389, 76.8897], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);
    } catch (e) {
        console.error("–ö–∞—Ä—Ç–∞ –∂“Ø–∫—Ç–µ–ª–º–µ–¥—ñ:", e);
    }

    let markers = [];
    let rawData = [];
    const isAdmin = location.hash === "#admin777";

    // 1. –í–ê–õ–ò–î–ê–¶–ò–Ø –¢–ï–ö–°–ï–†–Ü–°–Ü
    function check(t, v) {
        if (t === '–¢–µ–ª') return /^\+7\d{10}$/.test(v.replace(/\s+/g, '')); // 12 —Ç–∞“£–±–∞
        if (t === 'Email') return v.includes('@') && v.includes('.');
        return v.trim().length >= 2;
    }

    function toggleMap() { document.getElementById('map').classList.toggle('grayscale'); }
    
    function addCRow() {
        const div = document.createElement('div');
        div.className = 'c-row';
        div.style = "display:flex; gap:5px; margin-top:5px;";
        div.innerHTML = `<select class="ct" style="width:35%"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option><option>Skype</option></select><input class="cv" style="width:65%" placeholder="–î–µ—Ä–µ–∫">`;
        document.getElementById('c_list').appendChild(div);
    }

    // 2. –î–ï–†–ï–ö–¢–ï–†–î–Ü –ñ“Æ–ö–¢–ï–£ (TRY-CATCH –ü–ï–ù “ö–û–†“í–ê–õ“í–ê–ù)
    async function loadData() {
        try {
            const res = await fetch(API + '/get-all');
            const data = await res.json();
            rawData = Array.isArray(data) ? data : [];
            updateCats();
            filterMarkers();
        } catch (e) {
            console.error("–î–µ—Ä–µ–∫ –∂“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ:", e);
        }
    }

    function updateCats() {
        const s = document.getElementById('catFilter');
        const uniqueCats = [...new Set(rawData.map(i => i.job))];
        s.innerHTML = '<option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option>';
        uniqueCats.forEach(c => { if(c) s.innerHTML += `<option value="${c}">${c}</option>`; });
    }

    // 3. –§–ò–õ–¨–¢–† –ñ”ò–ù–ï –ö–ê–†–¢–ê–î–ê –ö”®–†–°–ï–¢–£
    function filterMarkers() {
        if (!map) return;
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        
        let lH = "", count = 0, now = Date.now();
        const search = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('catFilter').value;
        const bounds = map.getBounds();

        rawData.forEach(i => {
            // 24 —Å–∞“ì–∞—Ç—Ç—ã“õ —Ç–µ–∫—Å–µ—Ä—ñ—Å
            const createdTime = new Date(i.created_at).getTime();
            if ((now - createdTime) / 3600000 > 24) return;

            const isOn = (now - (i.last_ping || 0)) < 300000; // 5 –º–∏–Ω—É—Ç
            const isOwn = i.token === myToken;

            // –ö”©—Ä—ñ–Ω—É –ª–æ–≥–∏–∫–∞—Å—ã (‚Ññ3 –∂”ô–Ω–µ ‚Ññ4 —Ç–∞–ª–∞–ø—Ç–∞—Ä)
            if (!i.is_active && !i.is_vip && !isOn) return; // –¢–µ–≥—ñ–Ω: —Ç–µ–∫ –∏–µ—Å—ñ –æ–Ω–ª–∞–π–Ω –±–æ–ª—Å–∞
            if (i.is_vip && !i.is_active && !isAdmin && !isOwn) return; // VIP: —Ç–µ–∫ –º–∞“õ“±–ª–¥–∞–Ω—Å–∞ –Ω–µ–º–µ—Å–µ –∏–µ—Å—ñ–Ω–µ

            // –Ü–∑–¥–µ—É –∂”ô–Ω–µ
