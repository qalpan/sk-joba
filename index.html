<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba: –ê“õ—ã–ª–¥—ã –ö–∞—Ä—Ç–∞</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root { --blue: #007bff; --gold: #ffd700; --red: #dc3545; --green: #28a745; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f8f9fa; }
        #map { height: 50vh; width: 100%; transition: filter 0.4s ease; border-bottom: 2px solid #ddd; }
        .grayscale { filter: grayscale(100%); }
        .header-box { padding: 10px; background: white; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card { background: white; padding: 12px; margin: 8px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
        .contact-item { background: #f1f3f5; padding: 4px 8px; margin: 2px 0; border-radius: 4px; font-size: 13px; border-left: 3px solid var(--blue); }
        .btn-delete { background: var(--red); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 5px; }
        .online-status { font-size: 10px; font-weight: bold; color: var(--green); }
        .admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10000; padding:20px; overflow-y:auto; }
        .search-row { display: flex; gap: 5px; padding: 10px; flex-wrap: wrap; justify-content: center; }
        select, input { padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>

<div class="header-box">
    <div class="search-row">
        <button onclick="toggleMapMode()">üåì –¢“Ø—Å—Ç—ñ/–ê“õ-“õ–∞—Ä–∞</button>
        <input type="text" id="searchInput" placeholder="üîç –Ü–∑–¥–µ—É (–ú–∞–º–∞–Ω–¥—ã“õ, —Ç–∞—É–∞—Ä...)" oninput="filterMarkers()">
        <select id="categoryFilter" onchange="filterMarkers()">
            <option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option>
        </select>
    </div>
</div>

<div id="map"></div>

<div id="visible-list-container">
    <div style="padding:10px; font-weight:bold; background:#e9ecef;">üìç –ê—É–º–∞“õ—Ç–∞“ì—ã —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É–ª–∞—Ä: (<span id="item-count">0</span>)</div>
    <div id="dynamic-list-content"></div>
</div>

<div class="card" style="border-top: 4px solid var(--blue);">
    <h4>üìù –ñ–∞“£–∞ —Ö–∞–±–∞—Ä–ª–∞–Ω–¥—ã—Ä—É</h4>
    <select id="p_type" onchange="updateSubLabels()">
        <option value="“ö—ã–∑–º–µ—Ç">üë∑ “ö—ã–∑–º–µ—Ç “±—Å—ã–Ω—É (–ú–∞–º–∞–Ω–¥—ã“õ)</option>
        <option value="–¢–∞—É–∞—Ä">üì¶ –¢–∞—É–∞—Ä “±—Å—ã–Ω—É (–°–∏–ø–∞—Ç—Ç–∞–º–∞)</option>
        <option value="–¢–∞–ø—Å—ã—Ä—ã—Å">üõí –¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É (–ë”©–ª—ñ–º)</option>
    </select>
    <input id="p_name" placeholder="–ê—Ç—ã“£—ã–∑ (–º–∏–Ω. 2 —Ç–∞“£–±–∞)">
    <input id="p_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ –Ω–µ–º–µ—Å–µ –¢–∞—É–∞—Ä –∞—Ç—ã">
    
    <div id="contacts_list" style="margin-top:10px;">
        <div class="contact-row" style="display:flex; gap:5px; margin-bottom:5px;">
            <select class="c-type"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option><option>Skype</option></select>
            <input class="c-val" placeholder="–î–µ—Ä–µ–∫">
        </div>
    </div>
    <button onclick="addContactRow()" style="background:#6c757d; color:white; border:none; padding:5px; border-radius:4px; font-size:12px;">+ –ë–∞–π–ª–∞–Ω—ã—Å</button>
    
    <div style="margin-top:15px; display:flex; gap:10px;">
        <button onclick="processPost(false)" style="background:var(--green); color:white; flex:1; padding:10px; border-radius:5px; border:none;">–¢–µ–≥—ñ–Ω (–õ–µ–∑–¥–µ)</button>
        <button onclick="processPost(true)" style="background:var(--blue); color:white; flex:1; padding:10px; border-radius:5px; border:none;">üíé VIP (1000 ‚Ç∏)</button>
    </div>
</div>

<div id="adminPanel" class="admin-modal">
    <div style="display:flex; justify-content:space-between;">
        <h3>üõ° –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h3>
        <button onclick="closeAdmin()" style="background:var(--red); color:white; border:none; padding:10px;">–ñ–∞–±—É</button>
    </div>
    <div id="admin-data"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
    const API = "https://sk-joba.onrender.com";
    let myToken = localStorage.getItem('token') || (Math.random().toString(36).substr(2) + Date.now().toString(36));
    localStorage.setItem('token', myToken);

    let map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let markers = [];
    let rawData = [];
    let isAdmin = false;

    // 1. –í–ê–õ–ò–î–ê–¶–ò–Ø (“ö–∞—Ç–∞“£ —Ç–µ–∫—Å–µ—Ä—É)
    function validate(type, val) {
        if (type === '–¢–µ–ª') return /^\+7\d{10}$/.test(val.replace(/\s+/g, ''));
        if (type === 'Email') return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
        return val.trim().length >= 2;
    }

    function toggleMapMode() { document.getElementById('map').classList.toggle('grayscale'); }

    function addContactRow() {
        let div = document.createElement('div');
        div.className = 'contact-row';
        div.style = "display:flex; gap:5px; margin-bottom:5px;";
        div.innerHTML = `<select class="c-type"><option>–¢–µ–ª</option><option>Email</option><option>WhatsApp</option><option>Skype</option></select><input class="c-val" placeholder="–î–µ—Ä–µ–∫">`;
        document.getElementById('contacts_list').appendChild(div);
    }

    // 2. –ñ–ê–†–ò–Ø–õ–ê–£ –õ–û–ì–ò–ö–ê–°–´
    function processPost(isVip) {
        const name = document.getElementById('p_name').value;
        const job = document.getElementById('p_job').value;
        const type = document.getElementById('p_type').value;

        if (!validate('Text', name) || !validate('Text', job)) {
            alert("–ê—Ç—ã“£—ã–∑ –±–µ–Ω —Å–∏–ø–∞—Ç—Ç–∞–º–∞ 2 —Ç–∞“£–±–∞–¥–∞–Ω –∫–µ–º –±–æ–ª–º–∞—É—ã –∫–µ—Ä–µ–∫!");
            return;
        }

        let contacts = [];
        document.querySelectorAll('.contact-row').forEach(row => {
            let t = row.querySelector('.c-type').value;
            let v = row.querySelector('.c-val').value;
            if (validate(t, v)) contacts.push({type: t, val: v});
        });

        if (contacts.length === 0) {
            alert("–ë–∞–π–ª–∞–Ω—ã—Å –¥–µ—Ä–µ–≥—ñ “õ–∞—Ç–µ! –¢–µ–ª: +77xxxxxxxxx (12 —Ç–∞“£–±–∞)");
            return;
        }

        if (isVip) {
            const pay = confirm("VIP –∂–∞—Ä–∏—è–ª–∞—É “Ø—à—ñ–Ω 1000 ‚Ç∏ —Ç”©–ª–µ–º “õ–∞–∂–µ—Ç. –¢”©–ª–µ–º–¥—ñ —Ä–∞—Å—Ç–∞–π—Å—ã–∑ –±–∞?");
            if (!pay) return;
        }

        navigator.geolocation.getCurrentPosition(pos => {
            const body = {
                name, job, type, is_vip: isVip,
                lat: pos.coords.latitude, lon: pos.coords.longitude,
                contacts: JSON.stringify(contacts),
                token: myToken
            };

            fetch(API + '/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            }).then(() => {
                alert(isVip ? "–ö“Ø—Ç—É–¥–µ... –ê–¥–º–∏–Ω —Ç”©–ª–µ–º–¥—ñ —Ç–µ–∫—Å–µ—Ä—ñ–ø, 24 —Å–∞“ì–∞—Ç“õ–∞ “õ–æ—Å–∞–¥—ã." : "–ñ–∞—Ä–∏—è–ª–∞–Ω–¥—ã!");
                loadData();
            });
        }, (err) => alert("GPS —Ä“±“õ—Å–∞—Ç –µ—Ç—ñ“£—ñ–∑!"), {enableHighAccuracy: true});
    }

    // 3. –ú”ò–õ–Ü–ú–ï–¢–¢–ï–†–î–Ü –ö”®–†–°–ï–¢–£ (24 —Å–∞“ì–∞—Ç –∂”ô–Ω–µ –ê–π–º–∞“õ –±–æ–π—ã–Ω—à–∞)
    function loadData() {
        fetch(API + '/get-all').then(r => r.json()).then(data => {
            rawData = Array.isArray(data) ? data : [];
            updateCategories();
            filterMarkers();
        });
    }

    function updateCategories() {
        const categories = [...new Set(rawData.map(i => i.job))];
        const sel = document.getElementById('categoryFilter');
        sel.innerHTML = '<option value="">–ë–∞—Ä–ª—ã“õ —Å–∞–Ω–∞—Ç—Ç–∞—Ä</option>';
        categories.forEach(c => {
            if(c) sel.innerHTML += `<option value="${c}">${c}</option>`;
        });
    }

    function filterMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        let listHtml = "";
        let count = 0;
        const now = Date.now();
        const search = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('categoryFilter').value;
        const bounds = map.getBounds();

        rawData.forEach(item => {
            const createdTime = new Date(item.created_at).getTime();
            if ((now - createdTime) / 3600000 > 24) return; // 24 —Å–∞“ì–∞—Ç —Ç–µ–∫—Å–µ—Ä—ñ—Å—ñ

            const isOnline = (now - (item.last_ping || 0)) < 300000;
            const isOwner = item.token === myToken;

            // –ö”©—Ä—ñ–Ω—É —à–∞—Ä—Ç—ã: –¢–µ–≥—ñ–Ω –±–æ–ª—Å–∞ - —Ç–µ–∫ –æ–Ω–ª–∞–π–Ω –∏–µ—Å—ñ. VIP –±–æ–ª—Å–∞ - —Ç–µ–∫ –∞–¥–º–∏–Ω —Ä“±“õ—Å–∞—Ç—ã.
            if (!item.is_active && !item.is_vip && !isOnline) return;
            if (item.is_vip && !item.is_active && !isAdmin && !isOwner) return;

            // –Ü–∑–¥–µ—É –∂”ô–Ω–µ –°“±—Ä—ã–ø—Ç–∞—É
            if (cat && item.job !== cat) return;
            if (search && !item.job.toLowerCase().includes(search) && !item.name.toLowerCase().includes(search)) return;

            const latLng = [item.lat, item.lon];
            const marker = L.circleMarker(latLng, {
                color: item.is_vip ? 'gold' : 'blue',
                radius: 10, fillOpacity: 0.8
            }).addTo(map);

            const contacts = JSON.parse(item.contacts || '[]');
            const contactsHtml = contacts.map(c => `<div class="contact-item"><b>${c.type}:</b> ${c.val}</div>`).join('');
            
            // –ò–µ—Å—ñ–Ω–µ “ì–∞–Ω–∞ –∫”©—Ä—ñ–Ω–µ—Ç—ñ–Ω ”®—à—ñ—Ä—É –±–∞—Å–ø–∞—Å—ã
            const deleteBtn = isOwner ? `<button class="btn-delete" onclick="deleteItem(${item.id})">üóë ”®—à—ñ—Ä—É</button>` : "";

            marker.bindPopup(`
                <b>${item.job}</b> [${item.type}]<br>
                <small>${item.name}</small> ${isOnline ? '<span class="online-status">‚óè –æ–Ω–ª–∞–π–Ω</span>' : ''}
                <hr>${contactsHtml}${deleteBtn}
            `);
            markers.push(marker);

            // –¢–µ–∫ –∫–∞—Ä—Ç–∞ –∞—É–º–∞“ì—ã–Ω–¥–∞“ì—ã–ª–∞—Ä–¥—ã —Ç—ñ–∑—ñ–º–≥–µ —à—ã“ì–∞—Ä—É
            if (bounds.contains(latLng)) {
                count++;
                listHtml += `
                    <div class="card" style="border-left: 5px solid ${item.is_vip ? 'gold' : 'blue'}">
                        <b>${item.job}</b> <small>(${item.type})</small><br>
                        ${contactsHtml}${deleteBtn}
                    </div>`;
            }
        });
        document.getElementById('item-count').innerText = count;
        document.getElementById('dynamic-list-content').innerHTML = listHtml;
    }

    function deleteItem(id) {
        if(!confirm("”®—à—ñ—Ä—É–¥—ñ —Ä–∞—Å—Ç–∞–π—Å—ã–∑ –±–∞?")) return;
        fetch(API + '/delete', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({id, token: myToken})
        }).then(loadData);
    }

    // 4. –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨
    function checkAdmin() {
        const p = prompt("“ö“±–ø–∏—è —Å”©–∑:");
        if (p === "admin777") {
            isAdmin = true;
            document.getElementById('adminPanel').style.display = 'block';
            renderAdmin();
        }
    }

    function renderAdmin() {
        let h = "";
        rawData.forEach(i => {
            const time = new Date(i.created_at).toLocaleString();
            h += `<div class="card">
                <b>${i.job}</b> (ID: ${i.id}) - ${i.is_vip ? 'üíé VIP' : '–¢–µ–≥—ñ–Ω'}<br>
                –î–µ—Ä–µ–∫—Ç–µ—Ä: ${i.contacts}<br>
                –£–∞“õ—ã—Ç—ã: ${time}<br>
                –°—Ç–∞—Ç—É—Å: ${i.is_active ? '‚úÖ –ê–∫—Ç–∏–≤' : '‚è≥ –ö“Ø—Ç—É–¥–µ'}<br>
                <button onclick="toggleActive(${i.id}, ${!i.is_active})" style="background:var(--green); color:white; border:none; padding:5px;">“ö–æ—Å—É/VIP –†“±“õ—Å–∞—Ç</button>
                <button onclick="deleteItem(${i.id})" style="background:var(--red); color:white; border:none; padding:5px;">–ñ–æ—é</button>
            </div>`;
        });
        document.getElementById('admin-data').innerHTML = h;
    }

    function toggleActive(id, active) {
        fetch(API + '/admin-toggle', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({id, active, pass:"admin777"})
        }).then(loadData).then(renderAdmin);
    }

    function closeAdmin() { document.getElementById('adminPanel').style.display = 'none'; }
    
    // –ê–≤—Ç–æ-–∂–∞“£–∞—Ä—Ç—É
    setInterval(() => {
        fetch(API + '/ping', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token:myToken}) });
    }, 30000);

    map.on('moveend', filterMarkers);
    loadData();
</script>

<div style="position:fixed; bottom:10px; right:10px; z-index:1001;">
    <button onclick="checkAdmin()" style="opacity:0.3; border:none; background:none;">üõ°</button>
</div>

</body>
</html>
