<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        :root { --primary: #007bff; --success: #28a745; --warning: #ffc107; }
        body { font-family: sans-serif; margin: 0; background: #f4f7f6; }
        .header-box { position: sticky; top: 0; z-index: 1000; text-align: center; padding: 10px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-input { width: 90%; padding: 12px; border-radius: 25px; border: 2px solid var(--primary); outline: none; font-size: 16px; }
        #map { height: 45vh; width: 100%; border-bottom: 3px solid var(--primary); }
        #visible-list-container { background: white; margin: 10px; border-radius: 12px; height: 25vh; overflow-y: auto; }
        .card { background: white; padding: 15px; border-radius: 10px; margin: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, textarea, button, select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; }
        button { color: white; border: none; font-weight: bold; cursor: pointer; }
        .contact-row { display: flex; gap: 5px; margin-top: 5px; }
    </style>
</head>
<body>

<div class="header-box">
    <input type="text" id="searchInput" class="search-input" placeholder="üîç –Ü–∑–¥–µ—É..." oninput="filterMarkers()">
</div>

<div id="map"></div>

<div id="visible-list-container">
    <div style="padding:10px; font-weight:bold; background:#eee; position: sticky; top:0;">üìç –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞: (<span id="item-count">0</span>)</div>
    <div id="dynamic-list-content"></div>
</div>

<div class="container">
    <div class="card" style="border-top: 5px solid var(--primary);">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç –∂–∞—Ä–∏—è–ª–∞—É</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ">
        <div id="w_contacts_list">
            <div class="contact-row">
                <select style="width:35%" class="c-type"><option>–¢–µ–ª</option><option>WhatsApp</option></select>
                <input style="width:65%" class="c-val" placeholder="8707...">
            </div>
        </div>
        <button type="button" onclick="addContactRow('w_contacts_list')" style="background:#6c757d; width:auto; font-size:12px;">+ –ë–∞–π–ª–∞–Ω—ã—Å “õ–æ—Å—É</button>
        <button onclick="processPost('worker', false)" style="background:var(--primary); margin-top:10px;">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
        <button onclick="initVIP('worker')" style="background:#0056b3">üíé VIP –∂–∞—Ä–∏—è–ª–∞—É</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
    const API = "https://sk-joba.onrender.com"; 
    let myToken = localStorage.getItem('token') || (Math.random().toString(36).substr(2) + Date.now().toString(36));
    localStorage.setItem('token', myToken);
    let isAdmin = location.hash === "#admin777";

    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markersGroup = L.markerClusterGroup({ maxClusterRadius: 35 });
    map.addLayer(markersGroup);
    let rawData = [];

    function loadMarkers() {
        fetch(API + '/get-all')
            .then(r => r.json())
            .then(data => {
                const newData = [];
                if(data.workers) data.workers.forEach(x => newData.push({...x, type:'worker', info: x.job, title: x.name, uid: 'w'+x.id}));
                if(data.goods) data.goods.forEach(x => newData.push({...x, type:'good', info: x.product_name, title: x.seller_name, uid: 'g'+x.id}));
                if(data.orders) data.orders.forEach(x => newData.push({...x, type:'order', info: x.description, title: x.client_name, uid: 'o'+x.id}));
                rawData = newData; filterMarkers(); 
            }).catch(e => console.error("–ñ“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ:", e));
    }

    function filterMarkers() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        markersGroup.clearLayers();
        const processedUids = new Set(); 
        const bounds = map.getBounds();
        let listHtml = "", count = 0;

        rawData.forEach(i => {
            if(processedUids.has(i.uid)) return;
            processedUids.add(i.uid);

            const isOwner = (i.device_token === myToken || i.device_token === 'WAITING_VIP_' + myToken);
            if (i.device_token && i.device_token.includes('WAITING_VIP_') && !i.is_active && !isAdmin && !isOwner) return;
            if (!i.lat || parseFloat(i.lat) === 0) return;

            if(i.info.toLowerCase().includes(term) || i.title.toLowerCase().includes(term)) {
                const color = i.type === 'worker' ? '#007bff' : (i.type === 'good' ? '#ffc107' : '#28a745');
                const latLng = [parseFloat(i.lat), parseFloat(i.lon)];
                const m = L.marker(latLng, {
                    icon: L.divIcon({ html: `<div style="background:${color}; width:20px; height:20px; border-radius:50%; border:2px solid white;"></div>`, className: '' })
                });
                m.bindPopup(`<b>${i.info}</b><br>${i.title}`);
                markersGroup.addLayer(m);
                if (bounds.contains(latLng)) {
                    count++;
                    listHtml += `<div class="list-item"><b>${i.info}</b></div>`;
                }
            }
        });
        document.getElementById('item-count').innerText = count;
        document.getElementById('dynamic-list-content').innerHTML = listHtml;
    }

    function processPost(type, isVip) {
        const contactJson = validateForm(type);
        if (!contactJson) return;
        alert("GPS –∞–Ω—ã“õ—Ç–∞–ª—É–¥–∞...");
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude, lon = pos.coords.longitude;
            if (!lat || lat === 0) { alert("GPS “õ–∞—Ç–µ!"); return; }
            const d = { device_token: myToken, is_vip: isVip, lat, lon, contacts: contactJson };
            if(type==='worker') { d.name=v('w_name'); d.job=v('w_job'); }
            // ... –±–∞—Å“õ–∞ —Ç–∏–ø—Ç–µ—Ä
            fetch(API + (type==='worker'?'/save-worker':(type==='good'?'/save-goods':'/save-order')), { 
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d) 
            }).then(() => { alert("–ñ—ñ–±–µ—Ä—ñ–ª–¥—ñ!"); loadMarkers(); });
        }, (err) => alert("GPS —Ä“±“õ—Å–∞—Ç—Å—ã–∑ —ñ—Å—Ç–µ–º–µ–π–¥—ñ."), { enableHighAccuracy: true });
    }

    function addContactRow(listId) {
        const list = document.getElementById(listId);
        const div = document.createElement('div');
        div.className = 'contact-row';
        div.innerHTML = `<select style="width:35%" class="c-type"><option>–¢–µ–ª</option><option>WhatsApp</option></select><input style="width:65%" class="c-val" placeholder="–î–µ—Ä–µ–∫">`;
        list.appendChild(div);
    }

    function validateForm(type) {
        const name = v(type === 'worker' ? 'w_name' : 'g_name');
        if (name.length < 2) { alert("–ê—Ç—ã“£—ã–∑–¥—ã –∂–∞–∑—ã“£—ã–∑!"); return false; }
        return JSON.stringify([{type:'–¢–µ–ª', val:'8700...'}]); // –ú—ã—Å–∞–ª—ã
    }
    function v(id){ return document.getElementById(id)?.value.trim() || ""; }
    map.on('moveend', filterMarkers);
    loadMarkers();
</script>
</body>
</html>
