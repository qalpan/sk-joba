<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Marketplace</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; color: #333; }
        #map { height: 50vh; width: 100%; border-bottom: 3px solid #007bff; }
        .filter-bar { padding: 10px; background: white; display: flex; gap: 10px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; }
        .filter-bar input, .filter-bar select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        .container { padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid #eee; }
        .card.worker { border-top-color: #007bff; }
        .card.good { border-top-color: #ffc107; }
        .card.order { border-top-color: #dc3545; }
        input, textarea, select, button { width: 100%; margin: 8px 0; padding: 10px; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; border: none; transition: 0.3s; }
        button:hover { opacity: 0.8; }
        #admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10001; padding:20px; overflow-y:auto; }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    </style>
</head>
<body>

<div class="filter-bar">
    <select id="filter-type" onchange="loadAll()">
        <option value="all">–ë–∞—Ä–ª—ã“ì—ã</option>
        <option value="worker">–ú–∞–º–∞–Ω–¥–∞—Ä</option>
        <option value="good">–¢–∞—É–∞—Ä–ª–∞—Ä</option>
        <option value="order">–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä</option>
    </select>
    <input type="text" id="search-input" placeholder="–Ü–∑–¥–µ—É (–º—ã—Å–∞–ª—ã: –ù–∞–Ω, –°–∞–Ω—Ç–µ—Ö–Ω–∏–∫)..." oninput="loadAll()">
</div>

<div id="map"></div>

<div class="container">
    <div class="card worker">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç “±—Å—ã–Ω—É</h4>
        <input type="text" id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input type="text" id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ">
        <input type="tel" id="w_phone" placeholder="+77XXXXXXXXX" pattern="\+7\d{10}">
        <select id="w_dur"><option value="1">1 —Å–∞“ì–∞—Ç (500—Ç–≥)</option><option value="24">1 —Ç”ô—É–ª—ñ–∫ (2000—Ç–≥)</option></select>
        <button style="background: #007bff; color: white;" onclick="saveWorker()">–¢—ñ—Ä–∫–µ–ª—É</button>
    </div>

    <div class="card good">
        <h4>üì¶ –¢–∞—É–∞—Ä —Å–∞—Ç—É</h4>
        <input type="text" id="g_name" placeholder="–°–∞—Ç—É—à—ã –∞—Ç—ã">
        <input type="text" id="g_prod" placeholder="–¢–∞—É–∞—Ä –∞—Ç—ã">
        <input type="text" id="g_price" placeholder="–ë–∞“ì–∞—Å—ã">
        <input type="tel" id="g_phone" placeholder="+77XXXXXXXXX" pattern="\+7\d{10}">
        <button style="background: #ffc107; color: black;" onclick="saveGoods()">–¢–∞—É–∞—Ä “õ–æ—Å—É</button>
    </div>

    <div class="card order">
        <h4>üìã –¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É (–ö–ª–∏–µ–Ω—Ç)</h4>
        <input type="text" id="c_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <textarea id="c_desc" placeholder="–ù–µ “õ–∞–∂–µ—Ç?"></textarea>
        <input type="tel" id="c_phone" placeholder="+77XXXXXXXXX" pattern="\+7\d{10}">
        <button style="background: #dc3545; color: white;" onclick="saveOrder()">–¢–∞–ø—Å—ã—Ä—ã—Å—Ç—ã –∂–∞—Ä–∏—è–ª–∞—É</button>
    </div>
</div>

<div id="admin-modal">
    <button onclick="closeAdmin()" style="width:auto; float:right;">‚ùå –ñ–∞–±—É</button>
    <h2>–ë–∞—Å“õ–∞—Ä—É –ø–∞–Ω–µ–ª—ñ</h2>
    <table class="admin-table" id="admin-table-body"></table>
</div>

<script>
    // 1. –ê–ô–ù–´–ú–ê–õ–´–õ–ê–†–î–´ –ï“¢ –ë–Ü–†–Ü–ù–®–Ü –ê–ù–´“ö–¢–ê–£ –ö–ï–†–ï–ö
    const API = "https://sk-joba.onrender.com";
    const myToken = localStorage.getItem('device_token') || Math.random().toString(36).substring(2);
    localStorage.setItem('device_token', myToken);

    // 2. –ö–ê–†–¢–ê–ù–´ –ñ”ò–ù–ï SPIDERFIER-–î–Ü –ë–ê–°–¢–ê–£
    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    // –ï–≥–µ—Ä OverlappingMarkerSpiderfier –∂“Ø–∫—Ç–µ–ª–º–µ—Å–µ, “õ–∞—Ç–µ –±–µ—Ä–º–µ—É—ñ “Ø—à—ñ–Ω —Ç–µ–∫—Å–µ—Ä—É
    let oms;
    if (typeof OverlappingMarkerSpiderfier !== 'undefined') {
        oms = new OverlappingMarkerSpiderfier(map, { keepSpiderfied: true, nearbyDistance: 20 });
    }

    function loadAll() {
        const typeF = document.getElementById('filter-type').value;
        const searchF = document.getElementById('search-input').value.toLowerCase();

        fetch(`${API}/get-all`)
            .then(res => res.json())
            .then(data => {
                map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });
                if(oms) oms.clearMarkers();

                if(typeF === 'all' || typeF === 'worker') {
                    data.workers.forEach(w => { if(w.job.toLowerCase().includes(searchF)) addM(w, 'worker', 'blue', w.job); });
                }
                if(typeF === 'all' || typeF === 'good') {
                    data.goods.forEach(g => { if(g.product_name.toLowerCase().includes(searchF)) addM(g, 'good', 'yellow', g.product_name); });
                }
                if(typeF === 'all' || typeF === 'order') {
                    data.orders.forEach(o => { if(o.description.toLowerCase().includes(searchF)) addM(o, 'order', 'red', '–¢–∞–ø—Å—ã—Ä—ã—Å'); });
                }
            })
            .catch(err => console.error("–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∂“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ:", err));
    }

    function addM(item, type, color, tool) {
        const icon = L.icon({ 
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`, 
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });
        
        const marker = L.marker([item.lat, item.lon], {icon}).addTo(map);
        
        let content = `<b>${item.name || item.seller_name || item.client_name}</b><br>${item.job || item.product_name || item.description}<br><a href="tel:${item.phone}">${item.phone}</a>`;
        
        if(item.device_token === myToken) {
            content += `<br><button onclick="delItem('${type}', ${item.id})" style="background:red; color:white; border:none; padding:5px; border-radius:3px; cursor:pointer; margin-top:5px;">”®—à—ñ—Ä—É</button>`;
        }
        
        marker.bindPopup(content).bindTooltip(tool, {direction: 'top'});
        if(oms) oms.addMarker(marker);
    }

    // –¢–µ–∫—Å–µ—Ä—É (Validation)
    function check(id) { 
        const el = document.getElementById(id);
        if(!el.value || (el.pattern && !el.checkValidity())) { 
            alert("–ú”ô–ª—ñ–º–µ—Ç “õ–∞—Ç–µ –Ω–µ–º–µ—Å–µ –±–æ—Å! –¢–µ–ª–µ—Ñ–æ–Ω +7XXXXXXXXXX —Ç“Ø—Ä—ñ–Ω–¥–µ –±–æ–ª—É—ã –∫–µ—Ä–µ–∫."); 
            return false; 
        }
        return true;
    }

    function saveWorker() {
        if(!check('w_phone') || !check('w_name')) return;
        navigator.geolocation.getCurrentPosition(p => {
            const body = { name: v('w_name'), job: v('w_job'), phone: v('w_phone'), durationHours: v('w_dur'), device_token: myToken, lat: p.coords.latitude, lon: p.coords.longitude };
            fetch(`${API}/save-worker`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(() => alert("–†–∞—Å—Ç–∞—É“ì–∞ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ."));
        }, () => alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è“ì–∞ —Ä“±“õ—Å–∞—Ç –±–µ—Ä—ñ“£—ñ–∑!"));
    }

    function saveGoods() {
        if(!check('g_phone') || !check('g_prod')) return;
        navigator.geolocation.getCurrentPosition(p => {
            const body = { name: v('g_name'), product: v('g_prod'), price: v('g_price'), phone: v('g_phone'), device_token: myToken, lat: p.coords.latitude, lon: p.coords.longitude };
            fetch(`${API}/save-goods`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(() => alert("–¢–∞—É–∞—Ä —Ä–∞—Å—Ç–∞—É“ì–∞ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ."));
        });
    }

    function saveOrder() {
        if(!check('c_phone') || !check('c_desc')) return;
        navigator.geolocation.getCurrentPosition(p => {
            const body = { name: v('c_name'), description: v('c_desc'), phone: v('c_phone'), device_token: myToken, lat: p.coords.latitude, lon: p.coords.longitude };
            fetch(`${API}/save-order`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(() => { alert("–¢–∞–ø—Å—ã—Ä—ã—Å —à—ã“õ—Ç—ã!"); loadAll(); });
        });
    }

    function delItem(type, id) {
        if(confirm("”®—à—ñ—Ä–µ—Å—ñ–∑ –±–µ?")) {
            fetch(`${API}/delete/${type}/${id}`, { 
                method: 'DELETE', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ device_token: myToken }) 
            }).then(() => loadAll());
        }
    }

    // –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–Ü
    window.onhashchange = function() { 
        if(location.hash === "#admin777") {
            const p = prompt("“ö“±–ø–∏—è—Å”©–∑:");
            if(p === "admin777") { 
                document.getElementById('admin-modal').style.display='block'; 
                loadPending(); 
            } else {
                location.hash = "";
            }
        }
    };

    function loadPending() {
        fetch(`${API}/admin/pending`).then(res => res.json()).then(list => {
            let html = `<tr><th>–¢“Ø—Ä—ñ</th><th>–ê—Ç—ã</th><th>–ú”ô–ª—ñ–º–µ—Ç</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>”ò—Ä–µ–∫–µ—Ç</th></tr>`;
            list.forEach(i => {
                html += `<tr><td>${i.type}</td><td>${i.name}</td><td>${i.info}</td><td>${i.phone}</td><td><button onclick="activate('${i.id}', '${i.type}')">–†–∞—Å—Ç–∞—É</button></td></tr>`;
            });
            document.getElementById('admin-table-body').innerHTML = html;
        });
    }

    function activate(id, type) {
        fetch(`${API}/admin/activate`, { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ id, type }) 
        }).then(() => loadPending());
    }

    function v(id) { return document.getElementById(id).value; }
    function closeAdmin() { document.getElementById('admin-modal').style.display='none'; location.hash = ""; }

    loadAll();
</script>
</body>
</html>
