<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qalpan Map - Fixed</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        .nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 10px; background: white; padding: 10px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .admin-btn { position: fixed; top: 10px; right: 10px; z-index: 1000; opacity: 0.1; border: none; background: none; cursor: pointer; }
        .work-btn { position: fixed; top: 20px; left: 20px; z-index: 1000; background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <button class="admin-btn" onclick="openAdmin()">Admin</button>
    <button class="work-btn" onclick="startTracking()">üü¢ –ñ“±–º—ã—Å“õ–∞ —à—ã“ì—É</button>

    <div id="map"></div>

    <div class="nav">
        <button onclick="filterMarkers('üõ†')">üõ† –°–µ—Ä–≤–∏—Å</button>
        <button onclick="filterMarkers('üõí')">üõí –¢–∞—É–∞—Ä</button>
        <button onclick="filterMarkers('all')">üåç –ë–∞—Ä–ª—ã“ì—ã</button>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const socket = io("https://sk-joba.onrender.com");
        const map = L.map('map').setView([43.238, 76.889], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let myName, myPhone, markers = {};

        function startTracking() {
            myName = prompt("–ê—Ç—ã“£—ã–∑:");
            myPhone = prompt("–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ“£—ñ–∑:");
            let role = prompt("–†”©–ª—ñ“£—ñ–∑ (üõ† –Ω–µ–º–µ—Å–µ üõí):", "üõ†");
            
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    const data = { id: myName, phone: myPhone, role: role, lat: pos.coords.latitude, lng: pos.coords.longitude };
                    socket.emit('send_location', data);
                }, err => alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è“ì–∞ —Ä“±“õ—Å–∞—Ç –±–µ—Ä—ñ“£—ñ–∑!"), { enableHighAccuracy: true });
            }
        }

        socket.on('receive_location', data => {
            console.log("–ú–∞—Ä–∫–µ—Ä –∫–µ–ª–¥—ñ:", data);
            if (markers[data.id]) {
                markers[data.id].setLatLng([data.lat, data.lng]);
            } else {
                let m = L.marker([data.lat, data.lng]).addTo(map)
                    .bindPopup(`<b>${data.id}</b><br>–¢–µ–ª: ${data.phone}<br><button onclick="order('${data.id}')">–¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É</button>`);
                m.role = data.role;
                markers[data.id] = m;
            }
        });

        function filterMarkers(role) {
            Object.values(markers).forEach(m => {
                if (role === 'all' || m.role === role) map.addLayer(m);
                else map.removeLayer(m);
            });
        }

        function order(id) {
            if(!myName) return alert("–ê–ª–¥—ã–º–µ–Ω '–ñ“±–º—ã—Å“õ–∞ —à—ã“ì—É' –∞—Ä“õ—ã–ª—ã —Ç—ñ—Ä–∫–µ–ª—ñ“£—ñ–∑!");
            socket.emit('order_request', { to: id, from: myName, fromPhone: myPhone });
            alert("–°“±—Ä–∞–Ω—ã—Å –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ...");
        }

        socket.on('order_received', data => {
            if (confirm(`–¢–∞–ø—Å—ã—Ä—ã—Å –∫–µ–ª–¥—ñ! –ö—ñ–º–Ω–µ–Ω: ${data.from}. “ö–∞–±—ã–ª–¥–∞–π—Å—ã–∑ –±–∞?`)) {
                socket.emit('order_response', { toClient: data.from, from: myName, fromPhone: myPhone, status: 'accepted' });
            }
        });

        socket.on('order_final_status', data => {
            alert(data.status === 'accepted' ? `‚úÖ –ú–∞–º–∞–Ω “õ–∞–±—ã–ª–¥–∞–¥—ã! –¢–µ–ª: ${data.fromPhone}` : "‚ùå –ë–∞—Å —Ç–∞—Ä—Ç—ã–ª–¥—ã");
        });

        socket.on('error_message', msg => alert("‚ö†Ô∏è " + msg));

        function openAdmin() {
            let pass = prompt("“ö“±–ø–∏—è —Å”©–∑:");
            if (pass === "2025") {
                let user = prompt("–ö—ñ–º–Ω—ñ“£ –±–∞–ª–∞–Ω—Å—ã–Ω —Ç–æ–ª—Ç—ã—Ä–∞–º—ã–∑?");
                let amount = prompt("“ö–∞–Ω—à–∞ —Å–æ–º–º–∞?");
                socket.emit('admin_add_balance', { id: user, amount: parseInt(amount) });
                alert("–ü”ô—Ä–º–µ–Ω –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ");
            }
        }
    </script>
</body>
</html>
