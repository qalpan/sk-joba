<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        :root { --primary: #007bff; --success: #28a745; --warning: #ffc107; }
        body { font-family: sans-serif; margin: 0; background: #f4f7f6; }
        .header-box { position: sticky; top: 0; z-index: 1000; text-align: center; padding: 10px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-input { width: 90%; padding: 12px; border-radius: 25px; border: 2px solid var(--primary); outline: none; font-size: 16px; }
        
        .style-switcher { display: flex; justify-content: center; gap: 10px; margin-top: 8px; }
        .style-btn { padding: 6px 14px; border-radius: 15px; border: 1px solid #ddd; background: #eee; cursor: pointer; font-size: 12px; }
        .style-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        #map { height: 45vh; width: 100%; border-bottom: 3px solid var(--primary); }
        
        /* –ú–∞—Ä–∫–µ—Ä –∂–∞–∑—É–ª–∞—Ä—ã–Ω—ã“£ “õ–∞–±–∞—Ç—Ç–∞—Å—É—ã–Ω —Ä–µ—Ç—Ç–µ—É */
.marker-label {
    background: white;
    border: 1px solid #999;
    border-radius: 3px;
    padding: 1px 4px;
    font-size: 10px;
    white-space: nowrap;
    position: relative;
    z-index: 1000; /* –ñ–∞–∑—É –º–∞—Ä–∫–µ—Ä–¥—ñ“£ –∞—Ä—Ç—ã–Ω–¥–∞ “õ–∞–ª–º–∞—É—ã “Ø—à—ñ–Ω */
    pointer-events: none; /* –ñ–∞–∑—É –º–∞—Ä–∫–µ—Ä–¥—ñ –±–∞—Å—É“ì–∞ –∫–µ–¥–µ—Ä–≥—ñ –∂–∞—Å–∞–º–∞—É—ã –∫–µ—Ä–µ–∫ */
}

/* –¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ –º–µ–Ω —Ç–∞“£–±–∞—Å—ã–Ω –±—ñ—Ä –∂–æ–ª“ì–∞ “õ–æ—é */
.contact-line {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px; /* –¢–∞“£–±–∞ –º–µ–Ω –Ω”©–º—ñ—Ä –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã “õ–∞—à—ã“õ—Ç—ã“õ */
    background: #f0fdf4; /* –°”ô–ª –∂–∞—Å—ã–ª–¥–∞—É —Ñ–æ–Ω */
    border: 1px solid #bbf7d0;
    border-radius: 6px;
    padding: 6px 12px;
    margin: 8px 0;
    color: #166534;
    font-weight: bold;
    font-size: 14px;
}

        #visible-list-container { background: white; margin: 10px; border-radius: 12px; height: 25vh; overflow-y: auto; }
        .list-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: flex-start; }
        
        /* –ë–ê–ô–õ–ê–ù–´–° –ë–ï–õ–ì–Ü–õ–ï–†–Ü–ù–Ü“¢ –°–¢–ò–õ–Ü - –ö–û–ú–ü–¨–Æ–¢–ï–† “Æ–®–Ü–ù –´“¢“í–ê–ô–õ–´ */
        .contact-badge {
            display: block; /* ”ò—Ä“õ–∞–π—Å—ã—Å—ã –∂–∞“£–∞ –∂–æ–ª–¥–∞–Ω —à—ã“ì–∞–¥—ã */
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 13px;
            margin-top: 4px;
            color: #212529;
            font-weight: bold;
        }

        .container { padding: 15px; display: grid; gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 10px; border-top: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, textarea, button, select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; }
        button { color: white; border: none; font-weight: bold; cursor: pointer; }
        
        .contact-row { display: flex; gap: 5px; margin-top: 5px; }
        .add-contact-btn { background: #6c757d; font-size: 12px; padding: 5px; width: auto; margin-top: 5px; }

/* –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å–¥—ñ“£ –Ω–µ–≥—ñ–∑–≥—ñ —Ç–µ—Ä–µ–∑–µ—Å—ñ */
#admin-modal { 
    display:none; 
    position:fixed; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%; 
    background:white; 
    z-index:10000; /* –ö–∞—Ä—Ç–∞–¥–∞–Ω –∂–æ“ì–∞—Ä—ã —Ç“±—Ä—É—ã “Ø—à—ñ–Ω */
    padding:15px; 
    overflow-y: scroll; /* –°–∫—Ä–æ–ª–ª –º—ñ–Ω–¥–µ—Ç—Ç—ñ —Ç“Ø—Ä–¥–µ –∂“±–º—ã—Å —ñ—Å—Ç–µ—É—ñ “Ø—à—ñ–Ω */
    -webkit-overflow-scrolling: touch;
    box-sizing: border-box;
}

/* –ñ–∞–±—É –±–∞—Ç—ã—Ä–º–∞—Å—ã –±–∞—Ä –∂–æ“ì–∞—Ä“ì—ã –±”©–ª—ñ–∫ */
.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky; /* –≠–∫—Ä–∞–Ω–Ω—ã“£ –∂–æ“ì–∞—Ä—ã –∂–∞“ì—ã–Ω–¥–∞ “õ–∞—Ç—ã–ø —Ç“±—Ä–∞–¥—ã */
    top: 0;
    background: white;
    padding: 10px 0;
    border-bottom: 2px solid #eee;
    z-index: 10001;
}

/* –ö–µ—Å—Ç–µ —Å—Ç–∏–ª—ñ */
table { 
    width: 100%; 
    border-collapse: collapse; 
    margin-top: 15px; 
    font-size: 12px; 
}

th, td { 
    border: 1px solid #ddd; 
    padding: 10px 8px; 
    text-align: left; 
}

th { background: #f8f9fa; position: sticky; top: 50px; } /* –ö–µ—Å—Ç–µ –±–∞—Å—ã –¥–∞ “õ–∞—Ç—ã–ø —Ç“±—Ä–∞–¥—ã */

/* –ë–∞—Ç—ã—Ä–º–∞–ª–∞—Ä —Å—Ç–∏–ª—ñ */
.adm-btn-del { background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
.adm-btn-vip { background: #ffa500; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-bottom: 3px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }

/* –ë–∞–π–ª–∞–Ω—ã—Å –¥–µ—Ä–µ–≥—ñ–Ω –±—ñ—Ä –∂–æ–ª“ì–∞ –∂–∏–Ω–∞—É */
.compact-contact {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    background: #f1f3f5;
    border: 1px solid #ced4da;
    border-radius: 20px;
    padding: 4px 12px;
    margin: 4px auto;
    text-decoration: none;
    color: #212529;
    font-weight: bold;
    font-size: 14px;
    width: fit-content; /* –ú”ô—Ç—ñ–Ω–≥–µ “õ–∞—Ä–∞–π —Å–æ–∑—ã–ª–∞–¥—ã */
}

/* –ê—Ç—ã-–∂”©–Ω—ñ–Ω –∂–µ–∫–µ –∂–æ–ª“ì–∞ –∂”ô–Ω–µ –∫—ñ—à—ñ—Ä–µ–∫ —à—ã“ì–∞—Ä—É */
.owner-name {
    display: block;
    font-size: 13px;
    color: #6c757d;
    margin-bottom: 5px;
    font-weight: normal;
}
        
    </style>
</head>
<body>

<div class="header-box">
    <input type="text" id="searchInput" class="search-input" placeholder="üîç –Ü–∑–¥–µ—É..." oninput="filterMarkers()">
    <div class="style-switcher">
        <button id="btn-color" class="style-btn active" onclick="changeMapStyle('color')">–¢“Ø—Å—Ç—ñ</button>
        <button id="btn-mono" class="style-btn" onclick="changeMapStyle('mono')">–ê“õ-“õ–∞—Ä–∞</button>
    </div>
</div>

<div id="map"></div>

<div id="visible-list-container">
    <div style="padding:10px; font-weight:bold; background:#eee; position: sticky; top:0;">üìç –ñ–∞“õ—ã–Ω –º–∞“£–¥–∞: (<span id="item-count">0</span>)</div>
    <div id="dynamic-list-content"></div>
</div>

<div class="container">
    <div class="card" style="border-color: var(--primary);">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç –∂–∞—Ä–∏—è–ª–∞—É</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ">
        <div id="w_contacts_list">
            <div class="contact-row">
                <select style="width:35%" class="c-type"><option>–¢–µ–ª</option><option>Email</option><option>Skype</option><option>WhatsApp</option></select>
                <input style="width:65%" class="c-val" placeholder="–î–µ—Ä–µ–∫ (–º—ã—Å–∞–ª—ã: 8707...)">
            </div>
        </div>
        <button type="button" class="add-contact-btn" onclick="addContactRow('w_contacts_list')">+ –ë–∞–π–ª–∞–Ω—ã—Å “õ–æ—Å—É</button>
        <button onclick="saveItem('worker', false)" style="background:var(--primary); margin-top:15px;">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
        <button onclick="initVIP('worker')" style="background:#0056b3">üíé VIP –∂–∞—Ä–∏—è–ª–∞—É</button>
    </div>

    <div class="card" style="border-color: var(--warning);">
        <h4>üì¶ –¢–∞—É–∞—Ä —Å–∞—Ç—É</h4>
        <input id="g_name" placeholder="–°–∞—Ç—É—à—ã –∞—Ç—ã">
        <input id="g_prod" placeholder="–¢–∞—É–∞—Ä –∞—Ç—ã">
        <input id="g_price" placeholder="–ë–∞“ì–∞—Å—ã">
        <div id="g_contacts_list">
            <div class="contact-row">
                <select style="width:35%" class="c-type"><option>–¢–µ–ª</option><option>Email</option><option>Skype</option><option>WhatsApp</option></select>
                <input style="width:65%" class="c-val" placeholder="–î–µ—Ä–µ–∫">
            </div>
        </div>
        <button type="button" class="add-contact-btn" onclick="addContactRow('g_contacts_list')">+ –ë–∞–π–ª–∞–Ω—ã—Å “õ–æ—Å—É</button>
        <button onclick="saveItem('good', false)" style="background:var(--warning); margin-top:15px;">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
        <button onclick="initVIP('good')" style="background:#d39e00">üíé VIP –∂–∞—Ä–∏—è–ª–∞—É</button>
    </div>

    <div class="card" style="border-color: var(--success);">
        <h4>üìã –¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É</h4>
        <input id="c_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <textarea id="c_desc" placeholder="–ù–µ –∫–µ—Ä–µ–∫?"></textarea>
        <div id="o_contacts_list">
            <div class="contact-row">
                <select style="width:35%" class="c-type"><option>–¢–µ–ª</option><option>Email</option><option>Skype</option><option>WhatsApp</option></select>
                <input style="width:65%" class="c-val" placeholder="–î–µ—Ä–µ–∫">
            </div>
        </div>
        <button type="button" class="add-contact-btn" onclick="addContactRow('o_contacts_list')">+ –ë–∞–π–ª–∞–Ω—ã—Å “õ–æ—Å—É</button>
        <button onclick="saveItem('order', false)" style="background:var(--success); margin-top:15px;">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
        <button onclick="initVIP('order')" style="background:#1e7e34">üíé VIP —Ç–∞–ø—Å—ã—Ä—ã—Å</button>
    </div>
</div>

<div id="admin-modal">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h3>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h3>
        <button onclick="location.hash=''" style="background:red; width: auto; padding: 5px 15px;">–ñ–∞–±—É</button>
    </div>
    <div id="admin-content"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
    const API = "https://sk-joba.onrender.com"; 
    
    // –¢–æ–∫–µ–Ω–¥—ñ —Ç–µ–∫—Å–µ—Ä–µ–º—ñ–∑ –Ω–µ–º–µ—Å–µ –∂–∞“£–∞—Å—ã–Ω “õ“±—Ä–∞–º—ã–∑
    let myToken = localStorage.getItem('token');
    if (!myToken) {
        myToken = Math.random().toString(36).substr(2) + Date.now().toString(36);
        localStorage.setItem('token', myToken);
    }
    console.log("My Token:", myToken); // –¢–µ–∫—Å–µ—Ä—É “Ø—à—ñ–Ω

    // 1. –ö–ê–†–¢–ê –ñ”ò–ù–ï –°–¢–ò–õ–¨–î–ï–†
    const map = L.map('map').setView([43.2389, 76.8897], 13);
    const baseLayers = {
        'color': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
        'mono': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png')
    };
    baseLayers.color.addTo(map);

    function changeMapStyle(s) {
        if(s === 'mono') { map.removeLayer(baseLayers.color); baseLayers.mono.addTo(map); }
        else { map.removeLayer(baseLayers.mono); baseLayers.color.addTo(map); }
    }

    const markersGroup = L.markerClusterGroup({ spiderfyOnMaxZoom: true, maxClusterRadius: 40 });
    map.addLayer(markersGroup);

    let rawData = [];
    let adminDataFull = null;

    // 2. –î–ï–†–ï–ö–¢–ï–†–î–Ü –ñ“Æ–ö–¢–ï–£ (Load Markers)
    function loadMarkers() {
        fetch(API + '/get-all')
            .then(r => r.json())
            .then(data => {
                adminDataFull = data.admin_all;
                const newData = [];
                
                // –ë–∞—Ä–ª—ã“õ –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –±—ñ—Ä –º–∞—Å—Å–∏–≤–∫–µ –∂–∏–Ω–∞—É –∂”ô–Ω–µ ID –±–µ—Ä—É
                if(data.workers) data.workers.forEach(x => newData.push({...x, type:'worker', info: x.job, title: x.name, uid: 'w'+x.id}));
                if(data.goods) data.goods.forEach(x => newData.push({...x, type:'good', info: x.product_name, title: x.seller_name, uid: 'g'+x.id}));
                if(data.orders) data.orders.forEach(x => newData.push({...x, type:'order', info: x.description, title: x.client_name, uid: 'o'+x.id}));
                
                rawData = newData; 
                filterMarkers(); // –î–µ—Ä–µ–∫ –∫–µ–ª–≥–µ–Ω —Å–æ“£ –±—ñ—Ä–¥–µ–Ω –∫–∞—Ä—Ç–∞–Ω—ã –∂–∞“£–∞—Ä—Ç—É
            })
            .catch(err => console.error("“ö–∞—Ç–µ:", err));
    }

    // 3. –ö–ê–†–¢–ê–ù–´ –°“Æ–ó–£ –ñ”ò–ù–ï –ö”®–†–°–ï–¢–£ (–ï“£ –º–∞“£—ã–∑–¥—ã –±”©–ª—ñ–∫)
    function filterMarkers() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const bounds = map.getBounds(); 
        
        // –ê: –ö–∞—Ä—Ç–∞–Ω—ã —Ç–æ–ª—ã“õ —Ç–∞–∑–∞–ª–∞–π–º—ã–∑
        markersGroup.clearLayers();
        
        let listHtml = '';
        const now = Date.now();
        let visibleCount = 0;

        // –ë: –î—É–±–ª–∏–∫–∞—Ç—Ç–∞—Ä–¥—ã –∂–æ—é (uid –∞—Ä“õ—ã–ª—ã)
        const uniqueData = [];
        const seenIds = new Set();
        
        rawData.forEach(item => {
            if (!seenIds.has(item.uid)) {
                seenIds.add(item.uid);
                uniqueData.push(item);
            }
        });

        // –í: –ú–∞—Ä–∫–µ—Ä–ª–µ—Ä–¥—ñ —Å–∞–ª—É
        uniqueData.forEach(i => {
            // --- VIP –ñ”ò–ù–ï –ò–ï–°–Ü–ù –ê–ù–´“ö–¢–ê–£ –õ–û–ì–ò–ö–ê–°–´ ---
            const serverToken = i.device_token || "";
            // –¢–æ–∫–µ–Ω –¥”ô–ª –∫–µ–ª—Å–µ –ù–ï–ú–ï–°–ï –∞–ª–¥—ã–Ω–¥–∞ 'WAITING_VIP_' –±–æ–ª—Å–∞ - –±“±–ª –º–µ–Ω—ñ“£ —Ö–∞–±–∞—Ä–ª–∞–º–∞–º
            const isOwner = (serverToken === myToken) || (serverToken === "WAITING_VIP_" + myToken);
            
            // –û–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å (15 –º–∏–Ω—É—Ç“õ–∞ –¥–µ–π—ñ–Ω –∂–∞—Å—ã–ª –±–æ–ª—ã–ø —Ç“±—Ä–∞–¥—ã)
            const lastPing = i.last_ping ? new Date(i.last_ping).getTime() : 0;
            const isOnline = (now - lastPing < 900000); 

            // –ö”©—Ä—Å–µ—Ç—É —à–∞—Ä—Ç—ã: (VIP) –Ω–µ–º–µ—Å–µ (–ò–µ—Å—ñ) –Ω–µ–º–µ—Å–µ (–û–Ω–ª–∞–π–Ω)
            if (i.is_active || isOwner || isOnline) {
                
                // –Ü–∑–¥–µ—É —Å”©–∑—ñ–Ω–µ —Å”ô–π–∫–µ—Å—Ç—ñ–∫
                if(i.info.toLowerCase().includes(term) || i.title.toLowerCase().includes(term)) {
                    
                    const latLng = L.latLng(i.lat, i.lon);
                    const isInBounds = bounds.contains(latLng);
                    
                    // –¢“Ø—Å—Ç–µ—Ä
                    let color = '#28a745'; // –¢–∞–ø—Å—ã—Ä—ã—Å (–∂–∞—Å—ã–ª)
                    if (i.type === 'worker') color = '#007bff'; // “ö—ã–∑–º–µ—Ç (–∫”©–∫)
                    if (i.type === 'good') color = '#ffc107'; // –¢–∞—É–∞—Ä (—Å–∞—Ä—ã)
                    
                    const contactsHtml = formatContacts(i);
                    
                    // --- ”®–®–Ü–†–£ –ë–ê–°–ü–ê–°–´ (–¢–ï–ö –ò–ï–°–Ü–ù–ï) ---
                    let delBtn = "";
                    if (isOwner) {
                        // VIP –±–æ–ª—Å–∞ –¥–∞, –∂–∞–π –±–æ–ª—Å–∞ –¥–∞, –∏–µ—Å—ñ–Ω–µ ”©—à—ñ—Ä—É –±–∞—Ç—ã—Ä–º–∞—Å—ã –∫”©—Ä—ñ–Ω–µ–¥—ñ
                        delBtn = `<button onclick="deleteItem(${i.id},'${i.type}')" style="background:#dc3545; color:white; border:none; padding:8px; border-radius:5px; width:100%; margin-top:8px; cursor:pointer; font-weight:bold;">üóëÔ∏è ”®—à—ñ—Ä—É</button>`;
                    }

                    // –ú–∞—Ä–∫–µ—Ä “õ“±—Ä–∞—Å—Ç—ã—Ä—É
                    const m = L.marker([i.lat, i.lon], {
                        icon: L.divIcon({ 
                            html: `<div style="display:flex;flex-direction:column;align-items:center;">
                                    <div style="background:${color}; width:20px; height:20px; border-radius:50%; border:2px solid white; 
                                        ${i.is_active ? 'box-shadow:0 0 15px gold; border:3px solid gold;' : ''}">
                                    </div>
                                    <div class="marker-label" style="background:white; padding:2px 5px; border-radius:3px; border:1px solid #ccc; font-size:11px; margin-top:2px;">
                                        ${i.info.substring(0,12)}
                                    </div>
                                   </div>`,
                            className: '', iconSize: [50, 50], iconAnchor: [25, 10] 
                        })
                    });

                    // –ü–æ–ø-–∞–ø (–±–∞—Å“õ–∞–Ω–¥–∞ —à—ã“ì–∞—Ç—ã–Ω —Ç–µ—Ä–µ–∑–µ)
                    m.bindPopup(`
                        <div style="text-align:center; min-width:180px;">
                            <b style="font-size:15px;">${i.info}</b><br>
                            <span style="color:gray; font-size:12px;">${i.title}</span>
                            ${i.is_active ? '<br><span style="background:gold; padding:2px 5px; font-size:10px; border-radius:3px;">‚≠ê VIP</span>' : ''}
                            <hr style="margin:8px 0; border:0; border-top:1px solid #eee;">
                            <div style="text-align:left; font-size:13px;">${contactsHtml}</div>
                            ${delBtn}
                        </div>
                    `);
                    markersGroup.addLayer(m);

                    // –¢—ñ–∑—ñ–º–≥–µ “õ–æ—Å—É (—Ç–µ–∫ —ç–∫—Ä–∞–Ω“ì–∞ —Å—ã–π—ã–ø —Ç“±—Ä“ì–∞–Ω–¥–∞—Ä)
                    if (isInBounds) {
                        visibleCount++;
                        listHtml += `
                            <div class="list-item" style="${i.is_active ? 'border-left:5px solid gold; background:#fffdf0;' : 'border-left:5px solid '+color+';'} padding:10px; border-bottom:1px solid #eee;">
                                <div style="display:flex; justify-content:space-between;">
                                    <div>
                                        <b>${i.info}</b> <br>
                                        <small>${i.title}</small>
                                        ${isOwner ? '<br><small style="color:green;">(–°—ñ–∑–¥—ñ“£ —Ö–∞–±–∞—Ä–ª–∞–º–∞“£—ã–∑)</small>' : ''}
                                    </div>
                                    <div style="text-align:right; font-size:12px;">${contactsHtml}</div>
                                </div>
                                ${isOwner ? delBtn : ''}
                            </div>`;
                    }
                }
            }
        });
        
        document.getElementById('item-count').innerText = visibleCount;
        document.getElementById('dynamic-list-content').innerHTML = listHtml || '<div style="padding:20px; text-align:center; color:#999;">–ë“±–ª –∞—É–º–∞“õ—Ç–∞ –µ—à—Ç–µ“£–µ –∂–æ“õ</div>';
    }

    // 4. –°–ê“ö–¢–ê–£ –§–£–ù–ö–¶–ò–Ø–°–´
    function saveItem(type, isVip) {
        if (isVip) {
            if(!confirm("üíé VIP —Å—Ç–∞—Ç—É—Å (490‚Ç∏)\n\n–ê–¥–º–∏–Ω —Ç”©–ª–µ–º–¥—ñ —Ç–µ–∫—Å–µ—Ä–≥–µ–Ω —Å–æ“£ —Ö–∞–±–∞—Ä–ª–∞–º–∞“£—ã–∑ 24 —Å–∞“ì–∞—Ç –∫–∞—Ä—Ç–∞–¥–∞ —Ç“±—Ä–∞–¥—ã.\n\n–ñ–∞–ª“ì–∞—Å—Ç—ã—Ä–∞—Å—ã–∑ –±–∞?")) return;
        }

        navigator.geolocation.getCurrentPosition(pos => {
            let d = { 
                device_token: myToken, 
                is_vip: isVip,
                lat: pos.coords.latitude, 
                lon: pos.coords.longitude 
            };
            
            if(type==='worker') { d.name=v('w_name'); d.job=v('w_job'); d.contacts=collectContacts('w_contacts_list'); }
            if(type==='good') { d.name=v('g_name'); d.product=v('g_prod'); d.price=v('g_price'); d.contacts=collectContacts('g_contacts_list'); }
            if(type==='order') { d.name=v('c_name'); d.description=v('c_desc'); d.contacts=collectContacts('o_contacts_list'); }

            const endpoint = type==='worker'?'/save-worker':(type==='good'?'/save-goods':'/save-order');
            
            fetch(API + endpoint, { 
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify(d) 
            }).then(() => {
                alert("–ñ—ñ–±–µ—Ä—ñ–ª–¥—ñ!");
                loadMarkers(); // –°–∞“õ—Ç–∞“ì–∞–Ω —Å–æ“£ –±—ñ—Ä–¥–µ–Ω –∂–∞“£–∞—Ä—Ç—É
            }).catch(e => alert("“ö–∞—Ç–µ –∫–µ—Ç—Ç—ñ: " + e));
        }, () => alert("GPS “õ–æ—Å—ã“£—ã–∑!"));
    }

    // 5. ”®–®–Ü–†–£ –§–£–ù–ö–¶–ò–Ø–°–´
    function deleteItem(id, type) {
        if(confirm("–û—Å—ã —Ö–∞–±–∞—Ä–ª–∞–º–∞–Ω—ã ”©—à—ñ—Ä–µ—Å—ñ–∑ –±–µ?")) {
            fetch(API + '/delete-item', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: id, type: type, token: myToken })
            }).then(res => res.json()).then(data => {
                if(data.success) {
                    alert("”®—à—ñ—Ä—ñ–ª–¥—ñ!");
                    loadMarkers();
                } else {
                    alert("”®—à—ñ—Ä—É –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å. “ö–∞–π—Ç–∞ –∫”©—Ä—ñ“£—ñ–∑.");
                }
            });
        }
    }

    // –ö”®–ú–ï–ö–®–Ü –§–£–ù–ö–¶–ò–Ø–õ–ê–†
    function v(id){ return document.getElementById(id).value; }
    
    function collectContacts(id) {
        let c = []; 
        document.getElementById(id).querySelectorAll('.contact-row').forEach(r => {
            let t = r.querySelector('.c-type').value; 
            let v = r.querySelector('.c-val').value;
            if(v) c.push({type:t, val:v});
        }); 
        return JSON.stringify(c);
    }
    
    function formatContacts(item) {
        let h = '';
        try {
            const arr = typeof item.contacts === 'string' ? JSON.parse(item.contacts || '[]') : item.contacts;
            if(Array.isArray(arr)) {
                arr.forEach(c => { h += `<div><b>${c.type}:</b> ${c.val}</div>`; });
            }
        } catch(e) { return '...'; }
        return h;
    }
    
    function addContactRow(id) {
        const div = document.createElement('div'); div.className = 'contact-row';
        div.innerHTML = `<select class="c-type" style="width:30%"><option>–¢–µ–ª</option><option>WhatsApp</option></select>
                         <input class="c-val" style="width:50%" placeholder="87..">
                         <button onclick="this.parentElement.remove()" style="width:15%; background:#ddd; color:black;">x</button>`;
        document.getElementById(id).appendChild(div);
    }
    
    // –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨–î–Ü –®–ê“ö–´–†–£
    function initVIP(type) { saveItem(type, true); }
    window.onhashchange = () => { if(location.hash === '#admin777' && prompt("Pass:") === 'admin777') renderAdmin(); else document.getElementById('admin-modal').style.display='none'; };

    // --- –ê–î–ú–ò–ù –§–£–ù–ö–¶–ò–Ø–õ–ê–†–´ ---
    function renderAdmin() {
        if(!adminDataFull) return;
        const modal = document.getElementById('admin-modal');
        modal.style.display = 'block';
        let h = '<button onclick="location.hash=\'\'" style="background:red; width:100%; margin-bottom:10px;">–ñ–∞–±—É</button>';
        
        ['workers', 'goods', 'orders'].forEach(cat => {
            h += `<h3>${cat.toUpperCase()}</h3>`;
            adminDataFull[cat].forEach(i => {
                h += `<div style="border:1px solid #ccc; padding:5px; margin-bottom:5px; background:${i.is_active?'#eaffea':'white'}">
                        <b>ID: ${i.id}</b> | ${i.name || ''} <br>
                        ${i.job || i.product_name || i.description}
                        <br>
                        <button onclick="toggleActive(${i.id}, '${cat.slice(0,-1)}', ${!i.is_active})">
                            ${i.is_active ? 'VIP ”®—à—ñ—Ä—É' : 'VIP “ö–æ—Å—É'}
                        </button>
                        <button onclick="admDel(${i.id}, '${cat.slice(0,-1)}')" style="background:red; color:white;">–ñ–æ—é</button>
                      </div>`;
            });
        });
        document.getElementById('admin-content').innerHTML = h;
    }

    function toggleActive(id, type, val) {
        fetch(API+'/admin/toggle-active', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id,type,active:val})})
        .then(() => { loadMarkers(); setTimeout(renderAdmin, 500); });
    }
    function admDel(id, type) {
        if(confirm("–ê–¥–º–∏–Ω: ”©—à—ñ—Ä–µ—Å—ñ–∑ –±–µ?")) {
            fetch(API+'/delete-item', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id,type,token:'admin777'})})
            .then(() => { loadMarkers(); setTimeout(renderAdmin, 500); });
        }
    }

    // –Ü–°–ö–ï “ö–û–°–£
    map.on('moveend', filterMarkers);
    loadMarkers();
    
    // –°–µ—Ä–≤–µ—Ä–≥–µ "–ú–µ–Ω –æ–Ω–ª–∞–π–Ω–º—ã–Ω" –¥–µ–ø —Ö–∞–±–∞—Ä–ª–∞–ø —Ç“±—Ä—É (”ô—Ä 20 —Å–µ–∫—É–Ω–¥)
    setInterval(() => { 
        fetch(API + '/user-ping', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ token: myToken }) 
        }).catch(()=>{}); 
        
        // –ö–∞—Ä—Ç–∞–Ω—ã –¥–∞ –∂–∞“£–∞—Ä—Ç—ã–ø —Ç“±—Ä—É
        loadMarkers();
    }, 20000);

</script>
</body>
</html>
