<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Marketplace</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 50vh; width: 100%; }
        .card { background: white; padding: 15px; border-radius: 8px; margin: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, button, select, textarea { width: 100%; margin: 5px 0; padding: 10px; border-radius: 5px; border: 1px solid #ddd; }
        .btn-w { background: #007bff; color: white; }
        .btn-c { background: #dc3545; color: white; }
        .btn-g { background: #ffc107; }
        #admin-panel { display: none; background: #333; color: white; padding: 20px; position: fixed; top: 0; width: 100%; z-index: 9999; height: 100%; overflow-y: auto; }
    </style>
</head>
<body>

<div id="map"></div>
<button onclick="showAdmin()" style="width: auto; position: absolute; top: 10px; right: 10px; z-index: 1000;">–ê–¥–º–∏–Ω</button>

<div style="display: flex; flex-wrap: wrap;">
    <div class="card" style="flex: 1;">
        <h4>üë∑ –û—Ä—ã–Ω–¥–∞—É—à—ã</h4>
        <input type="text" id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input type="text" id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ">
        <input type="tel" id="w_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value="+7">
        <select id="w_dur"><option value="1">1 —Å–∞“ì–∞—Ç (500—Ç–≥)</option><option value="24">1 —Ç”ô—É–ª—ñ–∫ (2000—Ç–≥)</option></select>
        <button class="btn-w" onclick="saveWorker()">–¢—ñ—Ä–∫–µ–ª—É</button>
    </div>
    <div class="card" style="flex: 1;">
        <h4>üì¶ –¢–∞—É–∞—Ä –°–∞—Ç—É</h4>
        <input type="text" id="g_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input type="text" id="g_prod" placeholder="–¢–∞—É–∞—Ä –∞—Ç—ã">
        <input type="text" id="g_price" placeholder="–ë–∞“ì–∞—Å—ã">
        <input type="tel" id="g_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value="+7">
        <button class="btn-g" onclick="saveGoods()">–¢–∞—É–∞—Ä “õ–æ—Å—É</button>
    </div>
    <div class="card" style="flex: 1;">
        <h4>üìã –¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É</h4>
        <input type="text" id="c_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <textarea id="c_desc" placeholder="–ù–µ —ñ—Å—Ç–µ—É –∫–µ—Ä–µ–∫?"></textarea>
        <input type="tel" id="c_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value="+7">
        <button class="btn-c" onclick="saveOrder()">–¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É</button>
    </div>
</div>

<div id="admin-panel">
    <h2>–ö“Ø—Ç—ñ–ø —Ç“±—Ä“ì–∞–Ω ”©—Ç—ñ–Ω—ñ–º–¥–µ—Ä</h2>
    <div id="pending-list"></div>
    <button onclick="document.getElementById('admin-panel').style.display='none'">–ñ–∞–±—É</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const API = "https://sk-joba.onrender.com";
    const myToken = localStorage.getItem('device_token') || Math.random().toString(36).substring(2);
    localStorage.setItem('device_token', myToken);

    function loadAll() {
        fetch(`${API}/get-all`).then(res => res.json()).then(data => {
            map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });
            
            data.workers.forEach(w => {
                L.marker([w.lat, w.lon]).addTo(map)
                 .bindPopup(`<b>${w.name}</b><br>${w.job}<br>${w.phone}`)
                 .bindTooltip(w.job, {permanent: true, direction: 'top'}).openTooltip();
            });

            data.goods.forEach(g => {
                const yellowIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png', iconSize: [25, 41] });
                L.marker([g.lat, g.lon], {icon: yellowIcon}).addTo(map)
                 .bindPopup(`<b>${g.product_name}</b><br>${g.price} —Ç–≥<br>${g.phone}`)
                 .bindTooltip(g.product_name, {permanent: true, direction: 'top'}).openTooltip();
            });

            data.orders.forEach(o => {
                const redIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41] });
                let html = `<b>–¢–∞–ø—Å—ã—Ä—ã—Å: ${o.description}</b><br>${o.phone}`;
                if(o.device_token === myToken) html += `<br><button onclick="deleteOrder(${o.id})">”®—à—ñ—Ä—É</button>`;
                L.marker([o.lat, o.lon], {icon: redIcon}).addTo(map)
                 .bindPopup(html)
                 .bindTooltip("–¢–∞–ø—Å—ã—Ä—ã—Å", {permanent: true, direction: 'top'}).openTooltip();
            });
        });
    }

    // –ú–ê“¢–´–ó–î–´: –§—É–Ω–∫—Ü–∏—è–ª–∞—Ä –∞—Ç–∞—É—ã–Ω —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑!
    function saveOrder() {
        navigator.geolocation.getCurrentPosition(p => {
            const body = { name: v('c_name'), description: v('c_desc'), phone: v('c_phone'), device_token: myToken, lat: p.coords.latitude, lon: p.coords.longitude };
            fetch(`${API}/save-order`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(() => { alert("–¢–∞–ø—Å—ã—Ä—ã—Å “õ–æ—Å—ã–ª–¥—ã!"); loadAll(); });
        });
    }

    function saveWorker() {
        alert("–¢”©–ª–µ–º –∂–∞—Å–∞“ì–∞–Ω —Å–æ“£ –∞–¥–º–∏–Ω —Ä–∞—Å—Ç–∞—É—ã–Ω –∫“Ø—Ç—ñ“£—ñ–∑.");
        navigator.geolocation.getCurrentPosition(p => {
            const body = { name: v('w_name'), job: v('w_job'), phone: v('w_phone'), durationHours: v('w_dur'), lat: p.coords.latitude, lon: p.coords.longitude };
            fetch(`${API}/save-worker`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(() => alert("”®—Ç—ñ–Ω—ñ–º –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ."));
        });
    }

    function saveGoods() {
        alert("–¢–∞—É–∞—Ä —Ä–∞—Å—Ç–∞–ª“ì–∞–Ω —Å–æ“£ –∫–∞—Ä—Ç–∞–¥–∞ –∫”©—Ä—ñ–Ω–µ–¥—ñ.");
        navigator.geolocation.getCurrentPosition(p => {
            const body = { name: v('g_name'), product: v('g_prod'), price: v('g_price'), phone: v('g_phone'), lat: p.coords.latitude, lon: p.coords.longitude };
            fetch(`${API}/save-goods`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(() => alert("–¢–∞—É–∞—Ä –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ."));
        });
    }

    function showAdmin() {
        document.getElementById('admin-panel').style.display = 'block';
        fetch(`${API}/admin/pending`).then(res => res.json()).then(list => {
            let html = "";
            list.forEach(item => {
                html += `<div style="border-bottom:1px solid #555; padding:10px;">
                    ${item.name} - ${item.info} (${item.type}) 
                    <button onclick="activate('${item.id}', '${item.type}')">–†–∞—Å—Ç–∞—É</button>
                </div>`;
            });
            document.getElementById('pending-list').innerHTML = html || "–ñ–∞“£–∞ ”©—Ç—ñ–Ω—ñ–º–¥–µ—Ä –∂–æ“õ";
        });
    }

    function activate(id, type) {
        const secret = prompt("–ê–¥–º–∏–Ω –ø–∞—Ä–æ–ª—å:");
        fetch(`${API}/admin/activate`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id, type, secret })
        }).then(() => showAdmin());
    }

    function v(id) { return document.getElementById(id).value; }
    function deleteOrder(id) {
        fetch(`${API}/delete-order/${id}`, { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ device_token: myToken }) }).then(() => loadAll());
    }

    loadAll();
</script>
</body>
</html>
