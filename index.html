<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba | Live</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 50vh; width: 100%; border-bottom: 2px solid #007bff; background: #eee; }
        .search-box { padding: 10px; background: white; text-align: center; }
        .search-box input { width: 90%; padding: 12px; border-radius: 25px; border: 2px solid #007bff; outline: none; }
        .container { padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, select, textarea, button { width: 100%; margin: 5px 0; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        
        .marker-label {
            background: white; border: 1px solid #007bff; border-radius: 4px;
            padding: 2px 5px; font-size: 11px; font-weight: bold; color: #333;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); white-space: nowrap;
        }
        
        /* –ê–¥–º–∏–Ω –ú–æ–¥–∞–ª—å –º–µ–Ω –°“Ø–∑–≥—ñ–ª–µ—Ä */
        #admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto; }
        .admin-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .admin-tabs button { flex: 1; background: #6c757d; font-size: 11px; padding: 10px 5px; }
        .admin-tabs button.active { background: #007bff; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f4f4f4; }
    </style>
</head>
<body>

<div class="search-box">
    <input type="text" id="searchInput" placeholder="–Ü–∑–¥–µ—É (“ö—ã–∑–º–µ—Ç, –¢–∞—É–∞—Ä, –¢–∞–ø—Å—ã—Ä—ã—Å)..." oninput="filterMarkers()">
</div>

<div id="map"></div>

<div id="admin-modal">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3>–ë–∞—Å“õ–∞—Ä—É –ø–∞–Ω–µ–ª—ñ</h3>
        <button onclick="window.location.hash=''" style="background:red; width:70px;">–ñ–∞–±—É</button>
    </div>
    
    <div class="admin-tabs">
        <button id="tab-pending" onclick="renderAdmin('pending')" class="active">‚è≥ –ö–µ–∑–µ–∫—Ç–µ</button>
        <button id="tab-active" onclick="renderAdmin('active')">‚úÖ –ë–µ–ª—Å–µ–Ω–¥—ñ</button>
        <button id="tab-all" onclick="renderAdmin('all')">üìä –ë–∞—Ä–ª—ã“ì—ã</button>
    </div>
    
    <div id="admin-content"></div>
</div>

<div class="container">
    <div class="card">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ">
        <input id="w_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <select id="w_dur"><option value="1">1 —Å–∞“ì–∞—Ç ‚Äî 49‚Ç∏</option><option value="24">1 —Ç”ô—É–ª—ñ–∫ ‚Äî 490‚Ç∏</option></select>
        <button onclick="saveItem('worker')">–¢—ñ—Ä–∫–µ–ª—É</button>
    </div>
    <div class="card">
        <h4>üì¶ –¢–∞—É–∞—Ä</h4>
        <input id="g_name" placeholder="–°–∞—Ç—É—à—ã –∞—Ç—ã">
        <input id="g_prod" placeholder="–¢–∞—É–∞—Ä –∞—Ç–∞—É—ã">
        <input id="g_price" placeholder="–ë–∞“ì–∞—Å—ã">
        <input id="g_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <select id="g_dur"><option value="1">1 —Å–∞“ì–∞—Ç ‚Äî 49‚Ç∏</option><option value="24">1 —Ç”ô—É–ª—ñ–∫ ‚Äî 490‚Ç∏</option></select>
        <button onclick="saveItem('good')" style="background:#ffc107; color:black;">–ñ–∞—Ä–∏—è–ª–∞—É</button>
    </div>
    <div class="card">
        <h4>üìã –¢–∞–ø—Å—ã—Ä—ã—Å (–¢–µ–≥—ñ–Ω)</h4>
        <input id="c_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <textarea id="c_desc" placeholder="–ù–µ “õ–∞–∂–µ—Ç?"></textarea>
        <input id="c_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <button onclick="saveItem('order')" style="background:#28a745;">–ñ–∞—Ä–∏—è–ª–∞—É</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
    const API = "https://sk-joba.onrender.com";
    const myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const markersGroup = L.markerClusterGroup({ spiderfyOnMaxZoom: true });
    map.addLayer(markersGroup);

    setTimeout(() => map.invalidateSize(), 500);

    let rawData = []; // –ë–∞—Ä–ª—ã“õ –¥–µ—Ä–µ–∫—Ç–µ—Ä –æ—Å—ã–Ω–¥–∞ —Å–∞“õ—Ç–∞–ª–∞–¥—ã

    function loadMarkers() {
        fetch(API + '/get-all').then(r => r.json()).then(data => {
            // –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –±—ñ—Ä –º–∞—Å—Å–∏–≤–∫–µ –∂–∏–Ω–∞—É
            rawData = [
                ...data.workers.map(i => ({...i, type: 'worker', info: i.job})),
                ...data.goods.map(i => ({...i, type: 'good', info: i.product_name})),
                ...data.orders.map(i => ({...i, type: 'order', info: i.description}))
            ];
            filterMarkers();
            if(document.getElementById('admin-modal').style.display === 'block') renderAdmin(currentFilter);
        });
    }

    function filterMarkers() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        markersGroup.clearLayers();

        rawData.forEach(i => {
            // –¢–µ–∫ –∞–∫—Ç–∏–≤—Ç—ñ –Ω–µ–º–µ—Å–µ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä–¥—ã –∫–∞—Ä—Ç–∞“ì–∞ —à—ã“ì–∞—Ä—É
            if ((i.is_active || i.type === 'order') && (i.info.toLowerCase().includes(term) || term === "")) {
                const color = i.type === 'worker' ? '#007bff' : (i.type === 'good' ? '#ffc107' : '#28a745');
                addM(i.lat, i.lon, `<b>${i.type}</b><br>${i.info}<br>${i.phone}`, i.info, i.id, i.type, i.device_token, color);
            }
        });
    }

    function addM(lat, lon, txt, mini, id, type, token, color) {
        const icon = L.divIcon({
            html: `<div style="background:${color};width:14px;height:14px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 5px rgba(0,0,0,0.3);"></div>`,
            className: ''
