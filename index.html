<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK-Joba | Live</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 45vh; width: 100%; border-bottom: 2px solid #007bff; background: #ddd; }
        .search-box { padding: 15px; background: white; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-box input { width: 90%; padding: 15px; border-radius: 30px; border: 2px solid #007bff; outline: none; font-size: 16px; }
        .container { padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        input, select, textarea { width: 100%; margin: 8px 0; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; background: #007bff; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* –ú–∞—Ä–∫–µ—Ä —Å—Ç–∏–ª—ñ */
        .marker-label {
            background: white; border: 2px solid #007bff; border-radius: 5px;
            padding: 2px 6px; font-weight: bold; font-size: 12px; white-space: nowrap;
        }

        /* Google Pay Button Container */
        .gpay-btn-container { margin-top: 10px; display: none; }
        #admin-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto; }
    </style>
</head>
<body>

<div class="search-box">
    <input type="text" id="searchInput" placeholder="–Ü–∑–¥–µ—É: '“ö—ã–∑–º–µ—Ç', '–¢–∞—É–∞—Ä', '–¢–∞–ø—Å—ã—Ä—ã—Å' –Ω–µ–º–µ—Å–µ –º–∞–º–∞–Ω–¥—ã“õ..." oninput="filterMarkers()">
</div>

<div id="map"></div>

<div class="container">
    <div class="card" id="worker-card">
        <h4>üë∑ “ö—ã–∑–º–µ—Ç “õ–æ—Å—É</h4>
        <input id="w_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <input id="w_job" placeholder="–ú–∞–º–∞–Ω–¥—ã“õ (–º—ã—Å: –≠–ª–µ–∫—Ç—Ä–∏–∫)">
        <input id="w_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <select id="w_dur" onchange="updatePrice('worker')">
            <option value="1">1 —Å–∞“ì–∞—Ç ‚Äî 49‚Ç∏</option>
            <option value="24">1 —Ç”ô—É–ª—ñ–∫ ‚Äî 490‚Ç∏</option>
        </select>
        <div id="gpay-worker" class="gpay-btn-container"></div>
        <button id="btn-worker" onclick="showGPay('worker')">–¢”©–ª–µ–º –∂–∞—Å–∞—É (Google Pay)</button>
    </div>

    <div class="card" id="good-card">
        <h4>üì¶ –¢–∞—É–∞—Ä –∂–∞—Ä–∏—è–ª–∞—É</h4>
        <input id="g_name" placeholder="–°–∞—Ç—É—à—ã –∞—Ç—ã">
        <input id="g_prod" placeholder="–¢–∞—É–∞—Ä –∞—Ç–∞—É—ã">
        <input id="g_price" placeholder="–ë–∞“ì–∞—Å—ã">
        <input id="g_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <select id="g_dur" onchange="updatePrice('good')">
            <option value="1">1 —Å–∞“ì–∞—Ç ‚Äî 49‚Ç∏</option>
            <option value="24">1 —Ç”ô—É–ª—ñ–∫ ‚Äî 490‚Ç∏</option>
        </select>
        <div id="gpay-good" class="gpay-btn-container"></div>
        <button id="btn-good" onclick="showGPay('good')" style="background:#ffc107; color:black;">–¢”©–ª–µ–º –∂–∞—Å–∞—É (Google Pay)</button>
    </div>

    <div class="card">
        <h4>üìã –¢–∞–ø—Å—ã—Ä—ã—Å (–¢–µ–≥—ñ–Ω)</h4>
        <input id="c_name" placeholder="–ê—Ç—ã“£—ã–∑">
        <textarea id="c_desc" placeholder="–ù–µ “õ–∞–∂–µ—Ç?"></textarea>
        <input id="c_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <button onclick="saveItem('order')" style="background:#28a745;">–¢–µ–≥—ñ–Ω –∂–∞—Ä–∏—è–ª–∞—É</button>
    </div>
</div>

<div id="admin-modal">
    <button onclick="window.location.hash=''" style="background:red; width:100px;">‚ùå –ñ–∞–±—É</button>
    <div id="admin-list"></div>
</div>

<script src="https://pay.google.com/gp/p/js/pay.js" async onload="onGooglePayLoaded()"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
    const API = "https://sk-joba.onrender.com";
    const myToken = localStorage.getItem('token') || Math.random().toString(36).substr(2);
    localStorage.setItem('token', myToken);

    // –ö–ê–†–¢–ê
    const map = L.map('map').setView([43.2389, 76.8897], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markersGroup = L.markerClusterGroup();
    map.addLayer(markersGroup);

    let allData = { workers: [], goods: [], orders: [] };

    // –Ü–ó–î–ï–£ –ñ“Æ–ô–ï–°–Ü (–¢“Æ–ó–ï–¢–Ü–õ–ì–ï–ù)
    function filterMarkers() {
        const query = document.getElementById('searchInput').value.toLowerCase().trim();
        markersGroup.clearLayers();

        allData.workers.forEach(w => {
            if (query === "" || query === "“õ—ã–∑–º–µ—Ç" || w.job.toLowerCase().includes(query)) {
                addM(w.lat, w.lon, `üë∑ ${w.job}<br>${w.phone}`, w.job, w.id, 'worker', w.device_token, '#007bff');
            }
        });

        allData.goods.forEach(g => {
            if (query === "" || query === "—Ç–∞—É–∞—Ä" || g.product_name.toLowerCase().includes(query)) {
                addM(g.lat, g.lon, `üì¶ ${g.product_name}<br>${g.price}‚Ç∏<br>${g.phone}`, g.product_name, g.id, 'good', g.device_token, '#ffc107');
            }
        });

        allData.orders.forEach(o => {
            if (query === "" || query === "—Ç–∞–ø—Å—ã—Ä—ã—Å" || o.description.toLowerCase().includes(query)) {
                addM(o.lat, o.lon, `üìã ${o.description}<br>${o.phone}`, o.description, o.id, 'order', o.device_token, '#28a745');
            }
        });
    }

    function addM(lat, lon, txt, mini, id, type, token, color) {
        const icon = L.divIcon({ html: `<div style="background:${color};width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>`, className: '' });
        const m = L.marker([lat, lon], { icon });
        const delBtn = token === myToken ? `<br><button onclick="delItem(${id},'${type}')" style="background:red;font-size:10px;padding:2px;">”®—à—ñ—Ä—É</button>` : "";
        m.bindPopup(txt + delBtn);
        m.bindTooltip(mini, { permanent: true, direction: 'top', className: 'marker-label', offset: [0, -10] });
        markersGroup.addLayer(m);
    }

    // GOOGLE PAY –õ–û–ì–ò–ö–ê–°–´
    let currentType = '';
    const paymentsClient = new google.payments.api.PaymentsClient({ environment: 'TEST' });

    function onGooglePayLoaded() {
        console.log("GPay Loaded");
    }

    function showGPay(type) {
        currentType = type;
        const phone = type === 'worker' ? v('w_phone') : v('g_phone');
        if(!phone) return alert("–ê–ª–¥—ã–º–µ–Ω –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑!");
        
        document.getElementById(`btn-${type}`).style.display = 'none';
        const container = document.getElementById(`gpay-${type}`);
        container.style.display = 'block';
        
        const button = paymentsClient.createButton({ onClick: () => processPayment(type) });
        container.innerHTML = '';
        container.appendChild(button);
    }

    function processPayment(type) {
        const amount = (type === 'worker' ? document.getElementById('w_dur').value : document.getElementById('g_dur').value) === "1" ? "49.00" : "490.00";
        
        const paymentDataRequest = {
            apiVersion: 2, apiVersionMinor: 0,
            allowedPaymentMethods: [{
                type: 'CARD',
                parameters: { allowedAuthMethods: ["PAN_ONLY", "CRYPTOGRAM_3DS"], allowedCardNetworks: ["VISA", "MASTERCARD"] },
                tokenizationSpecification: { type: 'PAYMENT_GATEWAY', parameters: { 'gateway': 'example', 'gatewayMerchantId': 'exampleId' } }
            }],
            transactionInfo: { totalPriceStatus: 'FINAL', totalPrice: amount, currencyCode: 'KZT', countryCode: 'KZ' },
            merchantInfo: { merchantName: 'SK-Joba' }
        };

        paymentsClient.loadPaymentData(paymentDataRequest).then(data => {
            console.log("Payment Success", data);
            saveItem(type);
        }).catch(err => alert("–¢”©–ª–µ–º —Ç–æ“õ—Ç–∞—Ç—ã–ª–¥—ã –Ω–µ–º–µ—Å–µ “õ–∞—Ç–µ —à—ã“õ—Ç—ã."));
    }

    function v(id) { return document.getElementById(id).value.trim(); }

    function saveItem(type) {
        let d = {}, path = '';
        if(type==='worker'){ path='/save-worker'; d={name:v('w_name'), job:v('w_job'), phone:v('w_phone'), durationHours:v('w_dur')}; }
        if(type==='good'){ path='/save-goods'; d={name:v('g_name'), product:v('g_prod'), price:v('g_price'), phone:v('g_phone'), durationHours:v('g_dur')}; }
        if(type==='order'){ path='/save-order'; d={name:v('c_name'), description:v('c_desc'), phone:v('c_phone')}; }

        navigator.geolocation.getCurrentPosition(p => {
            d.lat=p.coords.latitude; d.lon=p.coords.longitude; d.device_token=myToken;
            fetch(API+path, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)})
            .then(() => {
                alert("–°”ô—Ç—Ç—ñ –∂–∞—Ä–∏—è–ª–∞–Ω–¥—ã!");
                location.reload();
            });
        }, () => alert("GPS “õ–æ—Å—ã“£—ã–∑!"));
    }

    function loadMarkers() {
        fetch(API+'/get-all').then(r => r.json()).then(data => {
            allData = data;
            filterMarkers();
        });
    }

    loadMarkers();
</script>
</body>
</html>
